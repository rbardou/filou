# Initialize a main repository and a clone.
$ main.exe --no-color init /tmp/filou-test/main
$ main.exe --no-color clone /tmp/filou-test/main /tmp/filou-test/clone
$ cd /tmp/filou-test/clone
$ explore .filou/config
{ main = "/tmp/filou-test/main/" }
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Repository is empty.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
.
# Add a file.
$ cd /tmp/filou-test/clone
$ echo blablabla > toto
$ cd /tmp/filou-test/clone
$ main.exe --no-color push toto
Pushed: toto
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 9, file count: 1).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
.
└── toto
# Add the file again.
$ cd /tmp/filou-test/clone
$ main.exe --no-color push
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 9, file count: 1).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
.
└── toto
# Add several files.
$ cd /tmp/filou-test/clone
$ echo blu > tutu
$ echo blibli > titi
$ cd /tmp/filou-test/clone
$ main.exe --no-color push tutu titi
Pushed: tutu
Pushed: titi
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 18, file count: 3).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
.
├── titi
├── toto
└── tutu
# Add files in subdirectories.
$ cd /tmp/filou-test/clone
$ mkdir bla
$ mkdir bla/bli
$ echo plaf > bla/bli/plouf
$ mkdir bla/blo
$ echo plif > bla/blo/plouf
$ cd /tmp/filou-test/clone
$ main.exe --dry-run --no-color push bla/bli/plouf bla/blo/plouf
Pushed: bla/bli/plouf
Pushed: bla/blo/plouf
$ cd /tmp/filou-test/clone
$ main.exe --no-color push bla/bli/plouf bla/blo/plouf
Pushed: bla/bli/plouf
Pushed: bla/blo/plouf
$ cd /tmp/filou-test/clone
$ main.exe --no-color push bla/bli/plouf bla/blo/plouf
$ cd /tmp/filou-test/clone
$ main.exe --no-color check --cache
Directory structure looks ok (total size: 26, file count: 5).
All files are available.
Hash index is consistent with the directory structure.
# Test tree.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
.
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree bla
bla
├── bli/
│   └── plouf
└── blo/
    └── plouf
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree bla/blo
bla/blo
└── plouf
$ cd /tmp/filou-test/clone/bla/bli
$ main.exe --no-color tree
bla/bli
└── plouf
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree bla/blo/blu/ble
Error:
  no such directory: bla/blo/blu
Exit code: 1
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree bla/blo/plouf/ble
Error:
  bla/blo/plouf is a file
Exit code: 1
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree bla/blo/plouf
Error:
  bla/blo/plouf is a file
Exit code: 1
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --depth 0
.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --depth 1
.
├── bla/
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --depth 2
.
├── bla/
│   ├── bli/
│   └── blo/
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --depth 3
.
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --depth 0 bla
bla
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --depth 1 bla
bla
├── bli/
└── blo/
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --depth 2 bla
bla
├── bli/
│   └── plouf
└── blo/
    └── plouf
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --only-dirs
.
└── bla/
    ├── bli/
    └── blo/
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --depth 1 --only-dirs
.
└── bla/
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --size
. (26 B)
├── bla/ (8 B)
│   ├── bli/ (4 B)
│   │   └── plouf (4 B)
│   └── blo/ (4 B)
│       └── plouf (4 B)
├── titi (6 B)
├── toto (9 B)
└── tutu (3 B)
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --count
. (5 files)
├── bla/ (2 files)
│   ├── bli/ (1 file)
│   │   └── plouf
│   └── blo/ (1 file)
│       └── plouf
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --size --count
. (26 B) (5 files)
├── bla/ (8 B) (2 files)
│   ├── bli/ (4 B) (1 file)
│   │   └── plouf (4 B)
│   └── blo/ (4 B) (1 file)
│       └── plouf (4 B)
├── titi (6 B)
├── toto (9 B)
└── tutu (3 B)
# Test duplicates.
$ echo plif > plif
$ cd /tmp/filou-test/clone
$ main.exe -v --dry-run --no-color push
Already exists: titi
Already exists: bla/blo/plouf
Already exists: bla/bli/plouf
Already exists: toto
Already exists: tutu
Pushed: plif (duplicate of: bla/blo/plouf)
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --duplicates
.
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├++ plif
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color push
Already exists: titi
Already exists: bla/blo/plouf
Already exists: bla/bli/plouf
Already exists: toto
Already exists: tutu
Pushed: plif (duplicate of: bla/blo/plouf)
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --duplicates
.
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
│           = /plif
├── plif
│   = /bla/blo/plouf
├── titi
├── toto
└── tutu
# Try to pull files.
$ rm titi
$ rm tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
.
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├-- titi
├── toto
└-- tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color pull titi
Pulled: titi
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
.
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└-- tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color pull tutu
Pulled: tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
.
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
$ rm titi
$ rm tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
.
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├-- titi
├── toto
└-- tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color pull titi tutu
Pulled: titi
Pulled: tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
.
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
$ rm tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
.
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└-- tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color pull titi tutu
Pulled: tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
.
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
$ rm bla/bli/plouf
$ rmdir bla/bli
$ rm plif
$ rm toto
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
.
├── bla/
│   ├-- bli/
│   │   └-- plouf
│   └── blo/
│       └── plouf
├-- plif
├── titi
├-- toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color pull bla/bli
Pulled: bla/bli/plouf
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
.
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├-- plif
├── titi
├-- toto
└── tutu
$ rm bla/bli/plouf
$ rmdir bla/bli
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
.
├── bla/
│   ├-- bli/
│   │   └-- plouf
│   └── blo/
│       └── plouf
├-- plif
├── titi
├-- toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color pull bla
Pulled: bla/bli/plouf
Already exists: bla/blo/plouf
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
.
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├-- plif
├── titi
├-- toto
└── tutu
$ rm bla/bli/plouf
$ rmdir bla/bli
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
.
├── bla/
│   ├-- bli/
│   │   └-- plouf
│   └── blo/
│       └── plouf
├-- plif
├── titi
├-- toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color pull
Pulled: bla/bli/plouf
Already exists: bla/blo/plouf
Pulled: plif
Already exists: titi
Pulled: toto
Already exists: tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
.
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 30, file count: 6).
All files are available.
Hash index is consistent with the directory structure.
$ cat bla/bli/plouf
plaf%
$ cat bla/blo/plouf
plif%
$ cat plif
plif%
$ cat titi
blibli%
$ cat toto
blablabla%
$ cat tutu
blu%
# Remove files.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --size --count
. (30 B) (6 files)
├── bla/ (8 B) (2 files)
│   ├── bli/ (4 B) (1 file)
│   │   └── plouf (4 B)
│   └── blo/ (4 B) (1 file)
│       └── plouf (4 B)
├── plif (4 B)
├── titi (6 B)
├── toto (9 B)
└── tutu (3 B)
$ cd /tmp/filou-test/clone
$ main.exe --no-color rm plif
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 26, file count: 5).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --size --count
. (26 B) (5 files)
├── bla/ (8 B) (2 files)
│   ├── bli/ (4 B) (1 file)
│   │   └── plouf (4 B)
│   └── blo/ (4 B) (1 file)
│       └── plouf (4 B)
├++ plif (4 B)
├── titi (6 B)
├── toto (9 B)
└── tutu (3 B)
$ cd /tmp/filou-test/clone
$ main.exe --no-color rm titi toto tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 8, file count: 2).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --size --count
. (8 B) (2 files)
├── bla/ (8 B) (2 files)
│   ├── bli/ (4 B) (1 file)
│   │   └── plouf (4 B)
│   └── blo/ (4 B) (1 file)
│       └── plouf (4 B)
├++ plif (4 B)
├++ titi (6 B)
├++ toto (9 B)
└++ tutu (3 B)
$ cd /tmp/filou-test/clone
$ main.exe --no-color rm bla/bli/plouf
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 4, file count: 1).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --size --count
. (4 B) (1 files)
├── bla/ (4 B) (1 file)
│   ├++ bli/
│   └── blo/ (4 B) (1 file)
│       └── plouf (4 B)
├++ plif (4 B)
├++ titi (6 B)
├++ toto (9 B)
└++ tutu (3 B)
$ cd /tmp/filou-test/clone
$ main.exe --no-color rm bla/blo/plouf
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Repository is empty.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --size --count
. (0 B) (0 files)
├++ bla/
├++ plif (4 B)
├++ titi (6 B)
├++ toto (9 B)
└++ tutu (3 B)
$ cd /tmp/filou-test/clone
$ main.exe --no-color push
Pushed: titi
Pushed: bla/blo/plouf
Pushed: bla/bli/plouf
Pushed: toto
Pushed: tutu
Pushed: plif (duplicate of: bla/blo/plouf)
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --size --count
. (30 B) (6 files)
├── bla/ (8 B) (2 files)
│   ├── bli/ (4 B) (1 file)
│   │   └── plouf (4 B)
│   └── blo/ (4 B) (1 file)
│       └── plouf (4 B)
├── plif (4 B)
├── titi (6 B)
├── toto (9 B)
└── tutu (3 B)
$ cd /tmp/filou-test/clone
$ main.exe --no-color rm plif bla/bli/plouf bla/blo/plouf
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 18, file count: 3).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --size --count
. (18 B) (3 files)
├++ bla/
├++ plif (4 B)
├── titi (6 B)
├── toto (9 B)
└── tutu (3 B)
$ cd /tmp/filou-test/clone
$ main.exe --no-color push
Pushed: bla/blo/plouf
Pushed: bla/bli/plouf
Pushed: plif (duplicate of: bla/blo/plouf)
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 30, file count: 6).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --size --count
. (30 B) (6 files)
├── bla/ (8 B) (2 files)
│   ├── bli/ (4 B) (1 file)
│   │   └── plouf (4 B)
│   └── blo/ (4 B) (1 file)
│       └── plouf (4 B)
├── plif (4 B)
├── titi (6 B)
├── toto (9 B)
└── tutu (3 B)
$ cd /tmp/filou-test/clone
$ main.exe --no-color rm plif bla/bli
Error:
  bla/bli is a directory, use --recursive (or -r) to remove it and its contents
Exit code: 1
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 30, file count: 6).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --size --count
. (30 B) (6 files)
├── bla/ (8 B) (2 files)
│   ├── bli/ (4 B) (1 file)
│   │   └── plouf (4 B)
│   └── blo/ (4 B) (1 file)
│       └── plouf (4 B)
├── plif (4 B)
├── titi (6 B)
├── toto (9 B)
└── tutu (3 B)
$ cd /tmp/filou-test/clone
$ main.exe --no-color rm -r plif bla/bli
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 22, file count: 4).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --size --count
. (22 B) (4 files)
├── bla/ (4 B) (1 file)
│   ├++ bli/
│   └── blo/ (4 B) (1 file)
│       └── plouf (4 B)
├++ plif (4 B)
├── titi (6 B)
├── toto (9 B)
└── tutu (3 B)
$ cd /tmp/filou-test/clone
$ main.exe --no-color push
Pushed: bla/bli/plouf
Pushed: plif (duplicate of: bla/blo/plouf)
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
.
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color rm -r bla
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 22, file count: 4).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --size --count
. (22 B) (4 files)
├++ bla/
├── plif (4 B)
├── titi (6 B)
├── toto (9 B)
└── tutu (3 B)
$ cd /tmp/filou-test/clone
$ main.exe --no-color push
Pushed: bla/blo/plouf (duplicate of: plif)
Pushed: bla/bli/plouf
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
.
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color rm -r .
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Repository is empty.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --size --count
. (0 B) (0 files)
├++ bla/
├++ plif (4 B)
├++ titi (6 B)
├++ toto (9 B)
└++ tutu (3 B)
$ cd /tmp/filou-test/clone
$ main.exe --no-color push
Pushed: titi
Pushed: bla/blo/plouf
Pushed: bla/bli/plouf
Pushed: toto
Pushed: tutu
Pushed: plif (duplicate of: bla/blo/plouf)
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
.
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
# Try to push a directory while a file already exists with the same name.
$ rm toto
$ mkdir toto
$ echo 'this shouldn'\''t be here' > toto/wrong
$ cd /tmp/filou-test/clone
$ main.exe --no-color push
Error:
  failed to push file: toto/wrong:
  parent directory already exists as a file: toto
Exit code: 1
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --duplicates
.
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
│           = /plif
├── plif
│   = /bla/blo/plouf
├── titi
├── toto?
└── tutu
$ rm toto/wrong
$ rmdir toto
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --duplicates
.
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
│           = /plif
├── plif
│   = /bla/blo/plouf
├── titi
├-- toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color pull
Pulled: toto
$ cat toto
blablabla%
# Same, but with a deeper directory.
$ rm toto
$ mkdir toto
$ mkdir toto/tutu
$ echo 'this shouldn'\''t be here' > toto/tutu/wrong
$ cd /tmp/filou-test/clone
$ main.exe --no-color push
Error:
  failed to push file: toto/tutu/wrong:
  parent directory already exists as a file: toto
Exit code: 1
$ rm toto/tutu/wrong
$ rmdir toto/tutu
$ rmdir toto
$ cd /tmp/filou-test/clone
$ main.exe --no-color pull
Pulled: toto
$ cat toto
blablabla%
# Same, but with a deeper directory but the first directory exists.
$ rm bla/bli/plouf
$ mkdir bla/bli/plouf
$ mkdir bla/bli/plouf/tutu
$ echo 'this shouldn'\''t be here' > bla/bli/plouf/tutu/wrong
$ cd /tmp/filou-test/clone
$ main.exe --no-color push
Error:
  failed to push file: bla/bli/plouf/tutu/wrong:
  parent directory already exists as a file: bla/bli/plouf
Exit code: 1
$ rm bla/bli/plouf/tutu/wrong
$ rmdir bla/bli/plouf/tutu
$ rmdir bla/bli/plouf
$ cd /tmp/filou-test/clone
$ main.exe --no-color pull
Pulled: bla/bli/plouf
$ cat bla/bli/plouf
plaf%
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
.
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
# Try to push a file while a directory already exists for one of its parent.
$ rm bla/bli/plouf
$ rmdir bla/bli
$ echo 'I should be a directory' > bla/bli
$ cd /tmp/filou-test/clone
$ main.exe --no-color push
Error:
  failed to push file: bla/bli:
  file already exists as a directory
Exit code: 1
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
.
├── bla/
│   ├── bli?
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
$ rm bla/bli
$ cd /tmp/filou-test/clone
$ main.exe --no-color pull
Pulled: bla/bli/plouf
$ cat bla/bli/plouf
plaf%
# Test update.
$ cd /tmp/filou-test/clone
$ main.exe --no-color update
Computing reachable object set...
Copied 0 objects.
Clone is up-to-date.
$ cd /tmp/filou-test/clone
$ explore .filou/root
{ Non_empty = {
    root_dir = 12f41d5b6b1957d3b926019b508f08521e1614c9dff595500dc15b11cb13cd7b;
    hash_index = d10fb33ec821d25bc7ba85a23553a73e1f4d936a7eaf5632c559485c32f50512;
  } }
$ rm .filou/12/f4/12f41d5b6b1957d3b926019b508f08521e1614c9dff595500dc15b11cb13cd7b
$ cd /tmp/filou-test/clone
$ main.exe --no-color update
Computing reachable object set...
Copied 1 objects.
Clone is up-to-date.
$ cd /tmp/filou-test/clone
$ main.exe --no-color update
Computing reachable object set...
Copied 0 objects.
Clone is up-to-date.
$ rm .filou/12/f4/12f41d5b6b1957d3b926019b508f08521e1614c9dff595500dc15b11cb13cd7b
$ rm .filou/d1/0f/d10fb33ec821d25bc7ba85a23553a73e1f4d936a7eaf5632c559485c32f50512
$ cd /tmp/filou-test/clone
$ main.exe --no-color update
Computing reachable object set...
Copied 2 objects.
Clone is up-to-date.
$ cd /tmp/filou-test/clone
$ main.exe --no-color update
Computing reachable object set...
Copied 0 objects.
Clone is up-to-date.
$ rm -r -f /tmp/filou-test/clone/.filou
$ main.exe --no-color clone /tmp/filou-test/main /tmp/filou-test/clone
$ cd /tmp/filou-test/clone
$ tree -a -s -F
.
├── [       4096]  bla/
│   ├── [       4096]  bli/
│   │   └── [          4]  plouf
│   └── [       4096]  blo/
│       └── [          4]  plouf
├── [       4096]  .filou/
│   └── [         44]  config
├── [          4]  plif
├── [          6]  titi
├── [          9]  toto
└── [          3]  tutu

4 directories, 7 files
$ cd /tmp/filou-test/clone
$ main.exe --no-color update
Computing reachable object set...
Copied 15 objects.
Clone is up-to-date.
$ cd /tmp/filou-test/clone
$ tree -a -s -F
.
├── [       4096]  bla/
│   ├── [       4096]  bli/
│   │   └── [          4]  plouf
│   └── [       4096]  blo/
│       └── [          4]  plouf
├── [       4096]  .filou/
│   ├── [       4096]  12/
│   │   └── [       4096]  f4/
│   │       └── [        297]  12f41d5b6b1957d3b926019b508f08521e1614c9dff595500dc15b11cb13cd7b
│   ├── [       4096]  16/
│   │   └── [       4096]  f9/
│   │       └── [         66]  16f9bc83ff1d4b5d0e2eb8103a96306a56d7eb51d4ea4897a607c73f34a013f5
│   ├── [       4096]  20/
│   │   └── [       4096]  33/
│   │       └── [         88]  2033c6bb1c0c456ea5efd5686b22a6352f2dae1ea1b88f0af3bc88abe73d0c5d
│   ├── [       4096]  2c/
│   │   └── [       4096]  fc/
│   │       └── [         75]  2cfc473aa14551ae622808a0d0358fd3be8b0aad379a0d7e18ae717c39159afb
│   ├── [       4096]  39/
│   │   └── [       4096]  8e/
│   │       └── [        146]  398eed8a0400cdd3e770526ce450d0c74e0fae443954d584f286f3ecd1d81e7b
│   ├── [       4096]  4c/
│   │   └── [       4096]  01/
│   │       └── [         66]  4c01e5bd112c84edf07488c55d62586f32397a09cf1b430aa7c6a283830d55a1
│   ├── [       4096]  5b/
│   │   └── [       4096]  10/
│   │       └── [         75]  5b10d7558d2a2a4c40e18d69350b4c743144266b965a7d20647a8aab170458d4
│   ├── [       4096]  78/
│   │   └── [       4096]  45/
│   │       └── [         66]  7845fdcb260234f5ac916785b7fcd1eddd6f505f26d01229abe1fc9f6bf118da
│   ├── [       4096]  84/
│   │   └── [       4096]  51/
│   │       └── [         94]  8451f677ac647686b69d25b226beecaf4b46ee0cb8d16b5141e4631a754c0ff1
│   ├── [       4096]  a6/
│   │   └── [       4096]  e7/
│   │       └── [         66]  a6e7d0f2cde27696d38a96e560caeb57ce260da86331d3d3d2593cf264952dd2
│   ├── [       4096]  c0/
│   │   └── [       4096]  aa/
│   │       └── [         88]  c0aa227497dd0303120b031c72c1eb0a7311bbc105c61b2fb7d328154a8e4494
│   ├── [       4096]  c4/
│   │   ├── [       4096]  69/
│   │   │   └── [         87]  c46957ea6037751759d7b5be20b78f9b480d832918d91aab7b87fe4d5c3b29d7
│   │   └── [       4096]  ba/
│   │       └── [         75]  c4bade70daca8d2550981dac069120ff13b3ee30675b736d65379dceab7ac9cc
│   ├── [       4096]  c6/
│   │   └── [       4096]  7c/
│   │       └── [         66]  c67c6a1ca9141e67fd1cce2e4515d5e30d4fcb6e74a4ea9ca38ca2a0a89a8f47
│   ├── [         44]  config
│   ├── [       4096]  d1/
│   │   └── [       4096]  0f/
│   │       └── [        226]  d10fb33ec821d25bc7ba85a23553a73e1f4d936a7eaf5632c559485c32f50512
│   └── [        122]  root
├── [          4]  plif
├── [          6]  titi
├── [          9]  toto
└── [          3]  tutu

33 directories, 23 files
$ cd /tmp/filou-test/clone
$ main.exe --no-color check --cache
Directory structure looks ok (total size: 30, file count: 6).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --cache
.
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
# Check what prune removes.
$ cd /tmp/filou-test/clone
$ main.exe --no-color prune
Removed 25 objects totalling 3.45 kB.
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 30, file count: 6).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
.
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
# Check that the main repository is not read with --cache.
$ mv /tmp/filou-test/main /tmp/filou-test/main.backup
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
Error:
  failed to fetch root:
  no such file: /tmp/filou-test/main/root
Exit code: 1
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --cache
.
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
$ mv /tmp/filou-test/main.backup /tmp/filou-test/main
# Check that needed objects are copied in the clone cache when fetching.
$ rm -r -f /tmp/filou-test/clone/.filou
$ main.exe --no-color clone /tmp/filou-test/main /tmp/filou-test/clone
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree bla/bli
bla/bli
└── plouf
$ cd /tmp/filou-test/clone
$ tree -a -s -F
.
├── [       4096]  bla/
│   ├── [       4096]  bli/
│   │   └── [          4]  plouf
│   └── [       4096]  blo/
│       └── [          4]  plouf
├── [       4096]  .filou/
│   ├── [       4096]  12/
│   │   └── [       4096]  f4/
│   │       └── [        297]  12f41d5b6b1957d3b926019b508f08521e1614c9dff595500dc15b11cb13cd7b
│   ├── [       4096]  39/
│   │   └── [       4096]  8e/
│   │       └── [        146]  398eed8a0400cdd3e770526ce450d0c74e0fae443954d584f286f3ecd1d81e7b
│   ├── [       4096]  c0/
│   │   └── [       4096]  aa/
│   │       └── [         88]  c0aa227497dd0303120b031c72c1eb0a7311bbc105c61b2fb7d328154a8e4494
│   ├── [         44]  config
│   └── [        122]  root
├── [          4]  plif
├── [          6]  titi
├── [          9]  toto
└── [          3]  tutu

10 directories, 11 files
$ cd /tmp/filou-test/clone
$ main.exe --no-color update
Computing reachable object set...
Copied 12 objects.
Clone is up-to-date.
# Test prune on the clone.
$ echo 'this is a truc' > bla/bli/truc
$ cd /tmp/filou-test/clone
$ main.exe --no-color push bla/bli
Pushed: bla/bli/truc
$ cd /tmp/filou-test/clone
$ main.exe --no-color prune
Removed 8 objects totalling 1.51 kB.
# Clone: some objects should have been removed, no files should have been added:
- /tmp/filou-test/clone/.filou/12/f4/12f41d5b6b1957d3b926019b508f08521e1614c9dff595500dc15b11cb13cd7b
- /tmp/filou-test/clone/.filou/39/8e/398eed8a0400cdd3e770526ce450d0c74e0fae443954d584f286f3ecd1d81e7b
- /tmp/filou-test/clone/.filou/c0/aa/c0aa227497dd0303120b031c72c1eb0a7311bbc105c61b2fb7d328154a8e4494
- /tmp/filou-test/clone/.filou/d1/0f/d10fb33ec821d25bc7ba85a23553a73e1f4d936a7eaf5632c559485c32f50512
# Main: should be the same diff:
- /tmp/filou-test/main/12/f4/12f41d5b6b1957d3b926019b508f08521e1614c9dff595500dc15b11cb13cd7b
- /tmp/filou-test/main/39/8e/398eed8a0400cdd3e770526ce450d0c74e0fae443954d584f286f3ecd1d81e7b
- /tmp/filou-test/main/c0/aa/c0aa227497dd0303120b031c72c1eb0a7311bbc105c61b2fb7d328154a8e4494
- /tmp/filou-test/main/d1/0f/d10fb33ec821d25bc7ba85a23553a73e1f4d936a7eaf5632c559485c32f50512
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 44, file count: 7).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
.
├── bla/
│   ├── bli/
│   │   ├── plouf
│   │   └── truc
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
# Check that if some files are missing from the cache, they are not added.
$ cd /tmp/filou-test/clone
$ rm .filou/ea/34/ea34ea54fb95b9dd5d20056bc24150b79354852e0f0a28ce578af2b3d2f4b859
$ rm .filou/a6/e7/a6e7d0f2cde27696d38a96e560caeb57ce260da86331d3d3d2593cf264952dd2
$ cd /tmp/filou-test/clone
$ main.exe --no-color prune
Removed 0 objects totalling 0 B.
# Clone: diff should be empty:
# Main: diff should also be empty:
# Updating should restore 2 objects:
$ cd /tmp/filou-test/clone
$ main.exe --no-color update
Computing reachable object set...
Copied 2 objects.
Clone is up-to-date.
# Check that if more objects exist in the clone than in the main, they are removed.
$ cd /tmp/filou-test/clone
$ mkdir .filou/01
$ mkdir .filou/01/23
$ echo 'dummy object' > .filou/01/23/01234567fb95b9dd5d20056bc24150b79354852e0f0a28ce578af2b3d2f4b859
$ cd /tmp/filou-test/clone
$ main.exe --no-color prune
Removed 1 objects totalling 12 B.
# Clone: diff should show one removed file:
- /tmp/filou-test/clone/.filou/01/23/01234567fb95b9dd5d20056bc24150b79354852e0f0a28ce578af2b3d2f4b859
# Main: diff should be empty:
