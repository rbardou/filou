# Initialize a main repository and a clone.
$ main.exe --no-color init /tmp/filou-test/main
$ main.exe --no-color clone /tmp/filou-test/main /tmp/filou-test/clone
Cloning /tmp/filou-test/main/ into: /tmp/filou-test/clone/
$ cd /tmp/filou-test/clone
$ explore .filou/config
{ main = "/tmp/filou-test/main/" }
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Repository is empty.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 init
# Play with the configuration.
$ main.exe --no-color config
clone repository: /tmp/filou-test/clone/
main repository: /tmp/filou-test/main/
$ main.exe --no-color config --main /tmp
$ main.exe --no-color config
clone repository: /tmp/filou-test/clone/
main repository: /tmp/
$ main.exe --no-color config --main /tmp/filou-test/main
$ main.exe --no-color config
clone repository: /tmp/filou-test/clone/
main repository: /tmp/filou-test/main/
# Add a file.
$ cd /tmp/filou-test/clone
$ echo blablabla > toto
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color push --yes toto
Listing files...
Listing files to push...
Pushing files...
Pushed: toto
Pushed 1 files (9 B).
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 9, file count: 1).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
└── toto
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 push toto
     1 init
$ cd /tmp/filou-test/clone
$ main.exe --no-color diff
+  toto
# Add the file again.
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color push --yes
Listing files...
Listing files to push...
Already exists: toto
Pushing files...
Pushed 0 files (0 B).
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 9, file count: 1).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
└── toto
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 push .
     1 push toto
     2 init
$ cd /tmp/filou-test/clone
$ main.exe --no-color diff
# Add several files.
$ cd /tmp/filou-test/clone
$ echo blu > tutu
$ echo blibli > titi
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color push --yes tutu titi
Listing files...
Listing files to push...
Pushing files...
Pushed: tutu
Pushed: titi
Pushed 2 files (9 B).
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 18, file count: 3).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 push tutu titi
     1 push .
     2 push toto
     3 init
$ cd /tmp/filou-test/clone
$ main.exe --no-color diff
+  titi
+  tutu
# Add files in subdirectories.
$ cd /tmp/filou-test/clone
$ mkdir bla
$ mkdir bla/bli
$ echo plaf > bla/bli/plouf
$ mkdir bla/blo
$ echo plif > bla/blo/plouf
$ cd /tmp/filou-test/clone
$ main.exe -v --dry-run --no-color push --yes bla/bli/plouf bla/blo/plouf
Listing files...
Listing files to push...
Pushing files...
Pushed: bla/bli/plouf
Pushed: bla/blo/plouf
Pushed 2 files (8 B).
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color push --yes bla/bli/plouf bla/blo/plouf
Listing files...
Listing files to push...
Pushing files...
Pushed: bla/bli/plouf
Pushed: bla/blo/plouf
Pushed 2 files (8 B).
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color push --yes bla/bli/plouf bla/blo/plouf
Listing files...
Listing files to push...
Already exists: bla/bli/plouf
Already exists: bla/blo/plouf
Pushing files...
Pushed 0 files (0 B).
$ cd /tmp/filou-test/clone
$ main.exe --no-color check --cache
Directory structure looks ok (total size: 26, file count: 5).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 push bla/bli/plouf bla/blo/plouf
     1 push bla/bli/plouf bla/blo/plouf
     2 push tutu titi
     3 push .
     4 push toto
     5 init
$ cd /tmp/filou-test/clone
$ main.exe --no-color diff 3
+  bla/
+  titi
+  tutu
# Test tree.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree bla
└── bla/
    ├── bli/
    │   └── plouf
    └── blo/
        └── plouf
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree bla/blo
└── bla/blo/
    └── plouf
$ cd /tmp/filou-test/clone/bla/bli
$ main.exe --no-color tree
└── bla/bli/
    └── plouf
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree bla/blo/blu/ble
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree bla/blo/plouf/ble
Error:
  failed to get path type for bla/blo/plouf/ble in /tmp/filou-test/clone/:
  failed to read file: /tmp/filou-test/clone/bla/blo/plouf/ble:
  Not a directory
Exit code: 1
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree bla/blo/plouf
└── bla/blo/plouf
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --depth 0
./
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --depth 1
./
├── bla/
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --depth 2
./
├── bla/
│   ├── bli/
│   └── blo/
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --depth 3
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --depth 0 bla
└── bla/
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --depth 1 bla
└── bla/
    ├── bli/
    └── blo/
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --depth 2 bla
└── bla/
    ├── bli/
    │   └── plouf
    └── blo/
        └── plouf
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --only-dirs
./
└── bla/
    ├── bli/
    └── blo/
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --depth 1 --only-dirs
./
└── bla/
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --size
./ (26 B)
├── bla/ (8 B)
│   ├── bli/ (4 B)
│   │   └── plouf (4 B)
│   └── blo/ (4 B)
│       └── plouf (4 B)
├── titi (6 B)
├── toto (9 B)
└── tutu (3 B)
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --count
./ (5 files)
├── bla/ (2 files)
│   ├── bli/ (1 file)
│   │   └── plouf
│   └── blo/ (1 file)
│       └── plouf
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --size --count
./ (26 B) (5 files)
├── bla/ (8 B) (2 files)
│   ├── bli/ (4 B) (1 file)
│   │   └── plouf (4 B)
│   └── blo/ (4 B) (1 file)
│       └── plouf (4 B)
├── titi (6 B)
├── toto (9 B)
└── tutu (3 B)
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 push bla/bli/plouf bla/blo/plouf
     1 push bla/bli/plouf bla/blo/plouf
     2 push tutu titi
     3 push .
     4 push toto
     5 init
# Test duplicates.
$ echo plif > plif
$ cd /tmp/filou-test/clone
$ main.exe -v --dry-run --no-color push --yes
Listing files...
Listing files to push...
Already exists: titi
Already exists: bla/blo/plouf
Already exists: bla/bli/plouf
Already exists: toto
Already exists: tutu
Pushing files...
Pushed: plif (duplicate of: bla/blo/plouf)
Pushed 1 files (4 B).
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --duplicates
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├++ plif
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color push --yes
Listing files...
Listing files to push...
Already exists: titi
Already exists: bla/blo/plouf
Already exists: bla/bli/plouf
Already exists: toto
Already exists: tutu
Pushing files...
Pushed: plif (duplicate of: bla/blo/plouf)
Pushed 1 files (4 B).
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --duplicates
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
│           = /plif
├── plif
│   = /bla/blo/plouf
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 push .
     1 push bla/bli/plouf bla/blo/plouf
     2 push bla/bli/plouf bla/blo/plouf
     3 push tutu titi
     4 push .
     5 push toto
     6 init
$ cd /tmp/filou-test/clone
$ main.exe --no-color diff
+  plif
# Try to pull files.
$ rm titi
$ rm tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├-- titi
├── toto
└-- tutu
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color pull titi
Listing files...
Listing files to pull...
Pulling files...
Pulled: titi
Pulled 1 files (6 B).
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└-- tutu
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color pull tutu
Listing files...
Listing files to pull...
Pulling files...
Pulled: tutu
Pulled 1 files (3 B).
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
$ rm titi
$ rm tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├-- titi
├── toto
└-- tutu
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color pull titi tutu
Listing files...
Listing files to pull...
Pulling files...
Pulled: titi
Pulled: tutu
Pulled 2 files (9 B).
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
$ rm tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└-- tutu
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color pull titi tutu
Listing files...
Listing files to pull...
Already exists: titi
Pulling files...
Pulled: tutu
Pulled 1 files (3 B).
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
$ rm bla/bli/plouf
$ rmdir bla/bli
$ rm plif
$ rm toto
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├-- bli/
│   │   └-- plouf
│   └── blo/
│       └── plouf
├-- plif
├── titi
├-- toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color pull bla/bli
Listing files...
Listing files to pull...
Pulling files...
Pulled: bla/bli/plouf
Pulled 1 files (4 B).
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├-- plif
├── titi
├-- toto
└── tutu
$ rm bla/bli/plouf
$ rmdir bla/bli
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├-- bli/
│   │   └-- plouf
│   └── blo/
│       └── plouf
├-- plif
├── titi
├-- toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color pull bla
Listing files...
Listing files to pull...
Already exists: bla/blo/plouf
Pulling files...
Pulled: bla/bli/plouf
Pulled 1 files (4 B).
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├-- plif
├── titi
├-- toto
└── tutu
$ rm bla/bli/plouf
$ rmdir bla/bli
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├-- bli/
│   │   └-- plouf
│   └── blo/
│       └── plouf
├-- plif
├── titi
├-- toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color pull
Listing files...
Listing files to pull...
Already exists: bla/blo/plouf
Already exists: titi
Already exists: tutu
Pulling files...
Pulled: bla/bli/plouf
Pulled: plif
Pulled: toto
Pulled 3 files (17 B).
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 30, file count: 6).
All files are available.
Hash index is consistent with the directory structure.
$ cat bla/bli/plouf
plaf%
$ cat bla/blo/plouf
plif%
$ cat plif
plif%
$ cat titi
blibli%
$ cat toto
blablabla%
$ cat tutu
blu%
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 push .
     1 push bla/bli/plouf bla/blo/plouf
     2 push bla/bli/plouf bla/blo/plouf
     3 push tutu titi
     4 push .
     5 push toto
     6 init
# Remove files.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --size --count
./ (30 B) (6 files)
├── bla/ (8 B) (2 files)
│   ├── bli/ (4 B) (1 file)
│   │   └── plouf (4 B)
│   └── blo/ (4 B) (1 file)
│       └── plouf (4 B)
├── plif (4 B)
├── titi (6 B)
├── toto (9 B)
└── tutu (3 B)
$ cd /tmp/filou-test/clone
$ main.exe --no-color rm --yes plif
Listing files...
Removing files...
Storing root...
Removed 1 files.
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 26, file count: 5).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --size --count
./ (26 B) (5 files)
├── bla/ (8 B) (2 files)
│   ├── bli/ (4 B) (1 file)
│   │   └── plouf (4 B)
│   └── blo/ (4 B) (1 file)
│       └── plouf (4 B)
├++ plif (4 B)
├── titi (6 B)
├── toto (9 B)
└── tutu (3 B)
$ cd /tmp/filou-test/clone
$ main.exe --no-color rm --yes titi toto tutu
Listing files...
Removing files...
Storing root...
Removed 3 files.
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 8, file count: 2).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --size --count
./ (8 B) (2 files)
├── bla/ (8 B) (2 files)
│   ├── bli/ (4 B) (1 file)
│   │   └── plouf (4 B)
│   └── blo/ (4 B) (1 file)
│       └── plouf (4 B)
├++ plif (4 B)
├++ titi (6 B)
├++ toto (9 B)
└++ tutu (3 B)
$ cd /tmp/filou-test/clone
$ main.exe --no-color rm --yes bla/bli/plouf
Listing files...
Removing files...
Storing root...
Removed 1 files.
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 4, file count: 1).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --size --count
./ (4 B) (1 file)
├── bla/ (4 B) (1 file)
│   ├++ bli/
│   └── blo/ (4 B) (1 file)
│       └── plouf (4 B)
├++ plif (4 B)
├++ titi (6 B)
├++ toto (9 B)
└++ tutu (3 B)
$ cd /tmp/filou-test/clone
$ main.exe --no-color rm --yes bla/blo/plouf
Listing files...
Removing files...
Storing root...
Removed 1 files.
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Repository is empty.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --size --count
./ (0 B) (0 files)
├++ bla/
├++ plif (4 B)
├++ titi (6 B)
├++ toto (9 B)
└++ tutu (3 B)
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color push --yes
Listing files...
Listing files to push...
Pushing files...
Pushed: titi
Pushed: bla/blo/plouf
Pushed: bla/bli/plouf
Pushed: toto
Pushed: tutu
Pushed: plif (duplicate of: bla/blo/plouf)
Pushed 6 files (30 B).
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --size --count
./ (30 B) (6 files)
├── bla/ (8 B) (2 files)
│   ├── bli/ (4 B) (1 file)
│   │   └── plouf (4 B)
│   └── blo/ (4 B) (1 file)
│       └── plouf (4 B)
├── plif (4 B)
├── titi (6 B)
├── toto (9 B)
└── tutu (3 B)
$ cd /tmp/filou-test/clone
$ main.exe --no-color rm --yes plif bla/bli/plouf bla/blo/plouf
Listing files...
Removing files...
Storing root...
Removed 3 files.
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 18, file count: 3).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --size --count
./ (18 B) (3 files)
├++ bla/
├++ plif (4 B)
├── titi (6 B)
├── toto (9 B)
└── tutu (3 B)
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color push --yes
Listing files...
Listing files to push...
Already exists: titi
Already exists: toto
Already exists: tutu
Pushing files...
Pushed: bla/blo/plouf
Pushed: bla/bli/plouf
Pushed: plif (duplicate of: bla/blo/plouf)
Pushed 3 files (12 B).
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 30, file count: 6).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --size --count
./ (30 B) (6 files)
├── bla/ (8 B) (2 files)
│   ├── bli/ (4 B) (1 file)
│   │   └── plouf (4 B)
│   └── blo/ (4 B) (1 file)
│       └── plouf (4 B)
├── plif (4 B)
├── titi (6 B)
├── toto (9 B)
└── tutu (3 B)
$ cd /tmp/filou-test/clone
$ main.exe --no-color rm --yes plif bla/bli
Listing files...
Error:
  bla/bli is a directory
Exit code: 1
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 30, file count: 6).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --size --count
./ (30 B) (6 files)
├── bla/ (8 B) (2 files)
│   ├── bli/ (4 B) (1 file)
│   │   └── plouf (4 B)
│   └── blo/ (4 B) (1 file)
│       └── plouf (4 B)
├── plif (4 B)
├── titi (6 B)
├── toto (9 B)
└── tutu (3 B)
$ cd /tmp/filou-test/clone
$ main.exe --no-color rm --yes -r plif bla/bli
Listing files...
Removing files...
Storing root...
Removed 2 files.
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 22, file count: 4).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --size --count
./ (22 B) (4 files)
├── bla/ (4 B) (1 file)
│   ├++ bli/
│   └── blo/ (4 B) (1 file)
│       └── plouf (4 B)
├++ plif (4 B)
├── titi (6 B)
├── toto (9 B)
└── tutu (3 B)
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color push --yes
Listing files...
Listing files to push...
Already exists: titi
Already exists: bla/blo/plouf
Already exists: toto
Already exists: tutu
Pushing files...
Pushed: bla/bli/plouf
Pushed: plif (duplicate of: bla/blo/plouf)
Pushed 2 files (8 B).
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color rm --yes -r bla
Listing files...
Removing files...
Storing root...
Removed 2 files.
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 22, file count: 4).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --size --count
./ (22 B) (4 files)
├++ bla/
├── plif (4 B)
├── titi (6 B)
├── toto (9 B)
└── tutu (3 B)
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color push --yes
Listing files...
Listing files to push...
Already exists: titi
Already exists: toto
Already exists: tutu
Already exists: plif
Pushing files...
Pushed: bla/blo/plouf (duplicate of: plif)
Pushed: bla/bli/plouf
Pushed 2 files (8 B).
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color rm --yes -r .
Listing files...
Removing files...
Storing root...
Removed 6 files.
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Repository is empty.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --size --count
./ (0 B) (0 files)
├++ bla/
├++ plif (4 B)
├++ titi (6 B)
├++ toto (9 B)
└++ tutu (3 B)
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color push --yes
Listing files...
Listing files to push...
Pushing files...
Pushed: titi
Pushed: bla/blo/plouf
Pushed: bla/bli/plouf
Pushed: toto
Pushed: tutu
Pushed: plif (duplicate of: bla/blo/plouf)
Pushed 6 files (30 B).
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 push .
     1 rm -r .
     2 push .
     3 rm -r bla
     4 push .
     5 rm -r plif bla/bli
     6 push .
     7 rm plif bla/bli/plouf bla/blo/plouf
     8 push .
     9 rm bla/blo/plouf
    10 rm bla/bli/plouf
    11 rm titi toto tutu
    12 rm plif
    13 push .
    14 push bla/bli/plouf bla/blo/plouf
    15 push bla/bli/plouf bla/blo/plouf
    16 push tutu titi
    17 push .
    18 push toto
    19 init
$ cd /tmp/filou-test/clone
$ main.exe --no-color diff 13 1
-  bla/
-  plif
-  titi
-  toto
-  tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color diff
+  bla/
+  plif
+  titi
+  toto
+  tutu
# Try to push a directory while a file already exists with the same name.
$ rm toto
$ mkdir toto
$ echo 'this shouldn'\''t be here' > toto/wrong
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color push --yes
Listing files...
Listing files to push...
Already exists: titi
Already exists: bla/blo/plouf
Already exists: bla/bli/plouf
Already exists: tutu
Already exists: plif
Pushing files...
Error:
  failed to push file: toto/wrong:
  parent directory already exists as a file: toto
Exit code: 1
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --duplicates
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
│           = /plif
├── plif
│   = /bla/blo/plouf
├── titi
├── toto?
└── tutu
$ rm toto/wrong
$ rmdir toto
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --duplicates
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
│           = /plif
├── plif
│   = /bla/blo/plouf
├── titi
├-- toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color pull
Listing files...
Listing files to pull...
Already exists: bla/bli/plouf
Already exists: bla/blo/plouf
Already exists: plif
Already exists: titi
Already exists: tutu
Pulling files...
Pulled: toto
Pulled 1 files (9 B).
$ cat toto
blablabla%
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 push .
     1 rm -r .
     2 push .
     3 rm -r bla
     4 push .
     5 rm -r plif bla/bli
     6 push .
     7 rm plif bla/bli/plouf bla/blo/plouf
     8 push .
     9 rm bla/blo/plouf
    10 rm bla/bli/plouf
    11 rm titi toto tutu
    12 rm plif
    13 push .
    14 push bla/bli/plouf bla/blo/plouf
    15 push bla/bli/plouf bla/blo/plouf
    16 push tutu titi
    17 push .
    18 push toto
    19 init
# Same, but with a deeper directory.
$ rm toto
$ mkdir toto
$ mkdir toto/tutu
$ echo 'this shouldn'\''t be here' > toto/tutu/wrong
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color push --yes
Listing files...
Listing files to push...
Already exists: titi
Already exists: bla/blo/plouf
Already exists: bla/bli/plouf
Already exists: tutu
Already exists: plif
Pushing files...
Error:
  failed to push file: toto/tutu/wrong:
  parent directory already exists as a file: toto
Exit code: 1
$ rm toto/tutu/wrong
$ rmdir toto/tutu
$ rmdir toto
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color pull
Listing files...
Listing files to pull...
Already exists: bla/bli/plouf
Already exists: bla/blo/plouf
Already exists: plif
Already exists: titi
Already exists: tutu
Pulling files...
Pulled: toto
Pulled 1 files (9 B).
$ cat toto
blablabla%
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 push .
     1 rm -r .
     2 push .
     3 rm -r bla
     4 push .
     5 rm -r plif bla/bli
     6 push .
     7 rm plif bla/bli/plouf bla/blo/plouf
     8 push .
     9 rm bla/blo/plouf
    10 rm bla/bli/plouf
    11 rm titi toto tutu
    12 rm plif
    13 push .
    14 push bla/bli/plouf bla/blo/plouf
    15 push bla/bli/plouf bla/blo/plouf
    16 push tutu titi
    17 push .
    18 push toto
    19 init
# Same, but with a deeper directory but the first directory exists.
$ rm bla/bli/plouf
$ mkdir bla/bli/plouf
$ mkdir bla/bli/plouf/tutu
$ echo 'this shouldn'\''t be here' > bla/bli/plouf/tutu/wrong
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color push --yes
Listing files...
Listing files to push...
Already exists: titi
Already exists: bla/blo/plouf
Already exists: toto
Already exists: tutu
Already exists: plif
Pushing files...
Error:
  failed to push file: bla/bli/plouf/tutu/wrong:
  parent directory already exists as a file: bla/bli/plouf
Exit code: 1
$ rm bla/bli/plouf/tutu/wrong
$ rmdir bla/bli/plouf/tutu
$ rmdir bla/bli/plouf
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color pull
Listing files...
Listing files to pull...
Already exists: bla/blo/plouf
Already exists: plif
Already exists: titi
Already exists: toto
Already exists: tutu
Pulling files...
Pulled: bla/bli/plouf
Pulled 1 files (4 B).
$ cat bla/bli/plouf
plaf%
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 push .
     1 rm -r .
     2 push .
     3 rm -r bla
     4 push .
     5 rm -r plif bla/bli
     6 push .
     7 rm plif bla/bli/plouf bla/blo/plouf
     8 push .
     9 rm bla/blo/plouf
    10 rm bla/bli/plouf
    11 rm titi toto tutu
    12 rm plif
    13 push .
    14 push bla/bli/plouf bla/blo/plouf
    15 push bla/bli/plouf bla/blo/plouf
    16 push tutu titi
    17 push .
    18 push toto
    19 init
# Try to push a file while a directory already exists for one of its parent.
$ rm bla/bli/plouf
$ rmdir bla/bli
$ echo 'I should be a directory' > bla/bli
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color push --yes
Listing files...
Listing files to push...
Already exists: titi
Already exists: bla/blo/plouf
Error:
  bla/bli already exists as a directory
Exit code: 1
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli?
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
$ rm bla/bli
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color pull
Listing files...
Listing files to pull...
Already exists: bla/blo/plouf
Already exists: plif
Already exists: titi
Already exists: toto
Already exists: tutu
Pulling files...
Pulled: bla/bli/plouf
Pulled 1 files (4 B).
$ cat bla/bli/plouf
plaf%
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 push .
     1 rm -r .
     2 push .
     3 rm -r bla
     4 push .
     5 rm -r plif bla/bli
     6 push .
     7 rm plif bla/bli/plouf bla/blo/plouf
     8 push .
     9 rm bla/blo/plouf
    10 rm bla/bli/plouf
    11 rm titi toto tutu
    12 rm plif
    13 push .
    14 push bla/bli/plouf bla/blo/plouf
    15 push bla/bli/plouf bla/blo/plouf
    16 push tutu titi
    17 push .
    18 push toto
    19 init
# Test update.
$ cd /tmp/filou-test/clone
$ main.exe --no-color update
Computing reachable object set...
Copied 0 objects.
Clone is up-to-date.
$ cd /tmp/filou-test/clone
$ explore .filou/root
{
  redo = [];
  head = {
    command = "push .";
    root = { Non_empty = {
        root_dir = f856f25552b8fc8c6d9e50b7176be4fa4cb39946b3d79c41769e4d795d129286;
        hash_index = 1aa05bf1ef016a9e97f6f3bc2c82cbd8cd2752f930a1cd950f266c97e0cc7146;
      } };
  };
  undo = [
    {
      command = "rm -r .";
      root = 33 (Empty);
    };
    {
      command = "push .";
      root = { Non_empty = {
          root_dir = 81b1442f60655f20cb899c556ffccd6676ee56049c4dc1b493e31dcecfcb2ba9;
          hash_index = 1aa05bf1ef016a9e97f6f3bc2c82cbd8cd2752f930a1cd950f266c97e0cc7146;
        } };
    };
    {
      command = "rm -r bla";
      root = { Non_empty = {
          root_dir = 6faa560d76df81a85379d0fa1c81f6fcf25aeafd5634b55f3cad63ab73b7221e;
          hash_index = 00bbba45527a63dc06e387bcfa7ba1cff58db18a9be5c02ecdf34b21a06e4ad3;
        } };
    };
    {
      command = "push .";
      root = { Non_empty = {
          root_dir = 81b1442f60655f20cb899c556ffccd6676ee56049c4dc1b493e31dcecfcb2ba9;
          hash_index = 1aa05bf1ef016a9e97f6f3bc2c82cbd8cd2752f930a1cd950f266c97e0cc7146;
        } };
    };
    {
      command = "rm -r plif bla/bli";
      root = { Non_empty = {
          root_dir = 4723cddb9030a5d736b781a4e7e20a23190827be1cb5184ceead5e238d65127e;
          hash_index = 31e79206b9420a482daa2db02f6e269a82a8714142c17a1e9203b2b61afb4579;
        } };
    };
    {
      command = "push .";
      root = { Non_empty = {
          root_dir = 81b1442f60655f20cb899c556ffccd6676ee56049c4dc1b493e31dcecfcb2ba9;
          hash_index = 1aa05bf1ef016a9e97f6f3bc2c82cbd8cd2752f930a1cd950f266c97e0cc7146;
        } };
    };
    {
      command = "rm plif bla/bli/plouf bla/blo/plouf";
      root = { Non_empty = {
          root_dir = 7d9cb3ee4afef41f386a6b05f2b9538fe6568b49b4b1a51d7acad4c2c5aa0aea;
          hash_index = af0b8e52a1f75e2583ef652066d84716fe25d83f587fdabb5b1aaff862c0680b;
        } };
    };
    {
      command = "push .";
      root = { Non_empty = {
          root_dir = f856f25552b8fc8c6d9e50b7176be4fa4cb39946b3d79c41769e4d795d129286;
          hash_index = 1aa05bf1ef016a9e97f6f3bc2c82cbd8cd2752f930a1cd950f266c97e0cc7146;
        } };
    };
    {
      command = "rm bla/blo/plouf";
      root = 33 (Empty);
    };
    {
      command = "rm bla/bli/plouf";
      root = { Non_empty = {
          root_dir = d781a8cce39525842da9e53330ae62bcc827cc20817f35383a266914d725011e;
          hash_index = c8e1f1996cd498ec01ecc40590f784a6b52ada9b6a44b1035be9dfda0b40f48d;
        } };
    };
    {
      command = "rm titi toto tutu";
      root = { Non_empty = {
          root_dir = 7234aa2cce0d88e2989ee3bf636436cb76e6da85d614768bbe384eb3f2a8be43;
          hash_index = b3511e46440ea5182d9d87882d326588121525dbf79b60e96c02a8ce5fd3bddf;
        } };
    };
    {
      command = "rm plif";
      root = { Non_empty = {
          root_dir = 10ea1b0380c134e3b9c531db7aa2415e02f07b59238e517c1b4c65233700c1e2;
          hash_index = c9853e834c666b6ca58535a3b4b739598ddedcf785d015f25302b41e2edf30ec;
        } };
    };
    {
      command = "push .";
      root = { Non_empty = {
          root_dir = 81b1442f60655f20cb899c556ffccd6676ee56049c4dc1b493e31dcecfcb2ba9;
          hash_index = 1aa05bf1ef016a9e97f6f3bc2c82cbd8cd2752f930a1cd950f266c97e0cc7146;
        } };
    };
    {
      command = "push bla/bli/plouf bla/blo/plouf";
      root = { Non_empty = {
          root_dir = 10ea1b0380c134e3b9c531db7aa2415e02f07b59238e517c1b4c65233700c1e2;
          hash_index = c9853e834c666b6ca58535a3b4b739598ddedcf785d015f25302b41e2edf30ec;
        } };
    };
    {
      command = "push bla/bli/plouf bla/blo/plouf";
      root = { Non_empty = {
          root_dir = 10ea1b0380c134e3b9c531db7aa2415e02f07b59238e517c1b4c65233700c1e2;
          hash_index = c9853e834c666b6ca58535a3b4b739598ddedcf785d015f25302b41e2edf30ec;
        } };
    };
    {
      command = "push tutu titi";
      root = { Non_empty = {
          root_dir = e3b04d9c424882cb4d7e6bdf8b26ca3a0efa78a46cd0d6cda698a09733ce516a;
          hash_index = af0b8e52a1f75e2583ef652066d84716fe25d83f587fdabb5b1aaff862c0680b;
        } };
    };
    {
      command = "push .";
      root = { Non_empty = {
          root_dir = 041bb80a32e81f618cc49673a5f17a03783377a229b23df5a741a2a768a489aa;
          hash_index = 5f3958fb25b78314cc2ffd423698eb09a21c0bbb58d2084818f300bd08d0a0e3;
        } };
    };
    {
      command = "push toto";
      root = { Non_empty = {
          root_dir = 041bb80a32e81f618cc49673a5f17a03783377a229b23df5a741a2a768a489aa;
          hash_index = 5f3958fb25b78314cc2ffd423698eb09a21c0bbb58d2084818f300bd08d0a0e3;
        } };
    };
    {
      command = "init";
      root = 33 (Empty);
    };
  ];
}
$ rm .filou/f8/56/f856f25552b8fc8c6d9e50b7176be4fa4cb39946b3d79c41769e4d795d129286
$ cd /tmp/filou-test/clone
$ main.exe --no-color update
Computing reachable object set...
Copied 1 objects.
Clone is up-to-date.
$ cd /tmp/filou-test/clone
$ main.exe --no-color update
Computing reachable object set...
Copied 0 objects.
Clone is up-to-date.
$ rm .filou/f8/56/f856f25552b8fc8c6d9e50b7176be4fa4cb39946b3d79c41769e4d795d129286
$ rm .filou/1a/a0/1aa05bf1ef016a9e97f6f3bc2c82cbd8cd2752f930a1cd950f266c97e0cc7146
$ cd /tmp/filou-test/clone
$ main.exe --no-color update
Computing reachable object set...
Copied 2 objects.
Clone is up-to-date.
$ cd /tmp/filou-test/clone
$ main.exe --no-color update
Computing reachable object set...
Copied 0 objects.
Clone is up-to-date.
$ rm -r -f /tmp/filou-test/clone/.filou
$ main.exe --no-color clone /tmp/filou-test/main /tmp/filou-test/clone
Cloning /tmp/filou-test/main/ into: /tmp/filou-test/clone/
$ cd /tmp/filou-test/clone
$ tree -a -s -F
.
├── [       4096]  bla/
│   ├── [       4096]  bli/
│   │   └── [          4]  plouf
│   └── [       4096]  blo/
│       └── [          4]  plouf
├── [       4096]  .filou/
│   └── [         44]  config
├── [          4]  plif
├── [          6]  titi
├── [          9]  toto
└── [          3]  tutu

4 directories, 7 files
$ cd /tmp/filou-test/clone
$ main.exe --no-color update
Computing reachable object set...
Copied 33 objects.
Clone is up-to-date.
$ cd /tmp/filou-test/clone
$ tree -a -s -F
.
├── [       4096]  bla/
│   ├── [       4096]  bli/
│   │   └── [          4]  plouf
│   └── [       4096]  blo/
│       └── [          4]  plouf
├── [       4096]  .filou/
│   ├── [       4096]  00/
│   │   └── [       4096]  bb/
│   │       └── [         55]  00bbba45527a63dc06e387bcfa7ba1cff58db18a9be5c02ecdf34b21a06e4ad3
│   ├── [       4096]  04/
│   │   └── [       4096]  1b/
│   │       └── [         87]  041bb80a32e81f618cc49673a5f17a03783377a229b23df5a741a2a768a489aa
│   ├── [       4096]  0a/
│   │   └── [       4096]  fa/
│   │       └── [        146]  0afaf91266bbc2bc41a75ebc88936bcbd318743c215db19affffde5e506219b0
│   ├── [       4096]  10/
│   │   └── [       4096]  ea/
│   │       └── [        248]  10ea1b0380c134e3b9c531db7aa2415e02f07b59238e517c1b4c65233700c1e2
│   ├── [       4096]  1a/
│   │   └── [       4096]  a0/
│   │       └── [         55]  1aa05bf1ef016a9e97f6f3bc2c82cbd8cd2752f930a1cd950f266c97e0cc7146
│   ├── [       4096]  29/
│   │   └── [       4096]  92/
│   │       └── [        289]  2992a334dea55e3c1c56230ee51098b681257eb21639768d15ec9025b434e073
│   ├── [       4096]  31/
│   │   └── [       4096]  e7/
│   │       └── [         55]  31e79206b9420a482daa2db02f6e269a82a8714142c17a1e9203b2b61afb4579
│   ├── [       4096]  33/
│   │   ├── [       4096]  65/
│   │   │   └── [        146]  336516b40325f0cd38f778202ae59d3a232463ef69bf6a32cc8896e9d9d94eb8
│   │   └── [       4096]  fa/
│   │       └── [         88]  33fa7d933d2a39bd1db66d2f19c9ff92746adac8b74d3710b594dafa6b814fe0
│   ├── [       4096]  47/
│   │   └── [       4096]  23/
│   │       └── [        247]  4723cddb9030a5d736b781a4e7e20a23190827be1cb5184ceead5e238d65127e
│   ├── [       4096]  4a/
│   │   └── [       4096]  f9/
│   │       └── [        169]  4af93e8267391c302ca27bf4bbf74b97148d615667542f6b9c79175e8073b8b3
│   ├── [       4096]  5f/
│   │   └── [       4096]  39/
│   │       └── [         55]  5f3958fb25b78314cc2ffd423698eb09a21c0bbb58d2084818f300bd08d0a0e3
│   ├── [       4096]  6f/
│   │   └── [       4096]  aa/
│   │       └── [        231]  6faa560d76df81a85379d0fa1c81f6fcf25aeafd5634b55f3cad63ab73b7221e
│   ├── [       4096]  72/
│   │   └── [       4096]  34/
│   │       └── [         97]  7234aa2cce0d88e2989ee3bf636436cb76e6da85d614768bbe384eb3f2a8be43
│   ├── [       4096]  7d/
│   │   └── [       4096]  9c/
│   │       └── [        183]  7d9cb3ee4afef41f386a6b05f2b9538fe6568b49b4b1a51d7acad4c2c5aa0aea
│   ├── [       4096]  81/
│   │   └── [       4096]  b1/
│   │       └── [        297]  81b1442f60655f20cb899c556ffccd6676ee56049c4dc1b493e31dcecfcb2ba9
│   ├── [       4096]  88/
│   │   └── [       4096]  14/
│   │       └── [         88]  88143291117a5d7a915e2b42df089dae05f17b32727e045d93d87ed7249c125c
│   ├── [       4096]  8f/
│   │   └── [       4096]  4b/
│   │       └── [         87]  8f4bf60df203535e6136a7de3f5da6578e6c7753b0dfcd52a9a061ecde694248
│   ├── [       4096]  90/
│   │   └── [       4096]  98/
│   │       └── [        228]  9098d11dc26fe64a32ccd282811ab6ce2f7718832a08f48c3572a2b971e1d384
│   ├── [       4096]  92/
│   │   └── [       4096]  0c/
│   │       └── [        216]  920c172a8e7743d51fe01b08af6950f4f289e16d5f670089d23c48f51b127e0a
│   ├── [       4096]  96/
│   │   └── [       4096]  44/
│   │       └── [         96]  9644f30b737c17c7940b96f741e80fe820ca0435ccd203f49ac427a6e55256ee
│   ├── [       4096]  9e/
│   │   └── [       4096]  20/
│   │       └── [        296]  9e2004f7d7b7e139165ebf9e2a8c0725d4e87fd992c3fbe40f5a8f410c9d3c3e
│   ├── [       4096]  a2/
│   │   └── [       4096]  e4/
│   │       └── [        146]  a2e4306b18f6c3ff89c4493488d6d80b0869c231ac57eb7dbc546e7b4e7a2cc4
│   ├── [       4096]  ab/
│   │   └── [       4096]  72/
│   │       └── [         75]  ab723bb840b48f46fcdb54908bbb958087fad09fd259409607f1a7672cdfb6d7
│   ├── [       4096]  af/
│   │   └── [       4096]  0b/
│   │       └── [         55]  af0b8e52a1f75e2583ef652066d84716fe25d83f587fdabb5b1aaff862c0680b
│   ├── [       4096]  b3/
│   │   └── [       4096]  51/
│   │       └── [         55]  b3511e46440ea5182d9d87882d326588121525dbf79b60e96c02a8ce5fd3bddf
│   ├── [       4096]  c8/
│   │   └── [       4096]  e1/
│   │       └── [         55]  c8e1f1996cd498ec01ecc40590f784a6b52ada9b6a44b1035be9dfda0b40f48d
│   ├── [       4096]  c9/
│   │   └── [       4096]  85/
│   │       └── [         55]  c9853e834c666b6ca58535a3b4b739598ddedcf785d015f25302b41e2edf30ec
│   ├── [         44]  config
│   ├── [       4096]  d7/
│   │   └── [       4096]  81/
│   │       └── [         96]  d781a8cce39525842da9e53330ae62bcc827cc20817f35383a266914d725011e
│   ├── [       4096]  e3/
│   │   ├── [       4096]  b0/
│   │   │   └── [        183]  e3b04d9c424882cb4d7e6bdf8b26ca3a0efa78a46cd0d6cda698a09733ce516a
│   │   └── [       4096]  fe/
│   │       └── [         88]  e3fe3bbcf4c878aa524e1345b9e3dc6f7886c248fad50fc0d82ca6e54cd20930
│   ├── [       4096]  e5/
│   │   └── [       4096]  45/
│   │       └── [         88]  e545af7f5847ba12dfd89827fc5f067530c2fb17b73210d4499de7c0f58e8865
│   ├── [       4096]  f8/
│   │   └── [       4096]  56/
│   │       └── [        297]  f856f25552b8fc8c6d9e50b7176be4fa4cb39946b3d79c41769e4d795d129286
│   └── [       1758]  root
├── [          4]  plif
├── [          6]  titi
├── [          9]  toto
└── [          3]  tutu

68 directories, 41 files
$ cd /tmp/filou-test/clone
$ main.exe --no-color check --cache
Directory structure looks ok (total size: 30, file count: 6).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --cache
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 push .
     1 rm -r .
     2 push .
     3 rm -r bla
     4 push .
     5 rm -r plif bla/bli
     6 push .
     7 rm plif bla/bli/plouf bla/blo/plouf
     8 push .
     9 rm bla/blo/plouf
    10 rm bla/bli/plouf
    11 rm titi toto tutu
    12 rm plif
    13 push .
    14 push bla/bli/plouf bla/blo/plouf
    15 push bla/bli/plouf bla/blo/plouf
    16 push tutu titi
    17 push .
    18 push toto
    19 init
# Play with undo / redo.
$ cd /tmp/filou-test/clone
$ main.exe --no-color undo
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
    -1 push .
-->  0 rm -r .
     1 push .
     2 rm -r bla
     3 push .
     4 rm -r plif bla/bli
     5 push .
     6 rm plif bla/bli/plouf bla/blo/plouf
     7 push .
     8 rm bla/blo/plouf
     9 rm bla/bli/plouf
    10 rm titi toto tutu
    11 rm plif
    12 push .
    13 push bla/bli/plouf bla/blo/plouf
    14 push bla/bli/plouf bla/blo/plouf
    15 push tutu titi
    16 push .
    17 push toto
    18 init
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├++ bla/
├++ plif
├++ titi
├++ toto
└++ tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color undo
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
    -2 push .
    -1 rm -r .
-->  0 push .
     1 rm -r bla
     2 push .
     3 rm -r plif bla/bli
     4 push .
     5 rm plif bla/bli/plouf bla/blo/plouf
     6 push .
     7 rm bla/blo/plouf
     8 rm bla/bli/plouf
     9 rm titi toto tutu
    10 rm plif
    11 push .
    12 push bla/bli/plouf bla/blo/plouf
    13 push bla/bli/plouf bla/blo/plouf
    14 push tutu titi
    15 push .
    16 push toto
    17 init
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color undo 3
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
    -5 push .
    -4 rm -r .
    -3 push .
    -2 rm -r bla
    -1 push .
-->  0 rm -r plif bla/bli
     1 push .
     2 rm plif bla/bli/plouf bla/blo/plouf
     3 push .
     4 rm bla/blo/plouf
     5 rm bla/bli/plouf
     6 rm titi toto tutu
     7 rm plif
     8 push .
     9 push bla/bli/plouf bla/blo/plouf
    10 push bla/bli/plouf bla/blo/plouf
    11 push tutu titi
    12 push .
    13 push toto
    14 init
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├++ bli/
│   └── blo/
│       └── plouf
├++ plif
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color redo 4
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
    -1 push .
-->  0 rm -r .
     1 push .
     2 rm -r bla
     3 push .
     4 rm -r plif bla/bli
     5 push .
     6 rm plif bla/bli/plouf bla/blo/plouf
     7 push .
     8 rm bla/blo/plouf
     9 rm bla/bli/plouf
    10 rm titi toto tutu
    11 rm plif
    12 push .
    13 push bla/bli/plouf bla/blo/plouf
    14 push bla/bli/plouf bla/blo/plouf
    15 push tutu titi
    16 push .
    17 push toto
    18 init
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├++ bla/
├++ plif
├++ titi
├++ toto
└++ tutu
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color push --yes bla
Listing files...
Listing files to push...
Pushing files...
Pushed: bla/blo/plouf
Pushed: bla/bli/plouf
Pushed 2 files (8 B).
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 push bla
     1 rm -r .
     2 push .
     3 rm -r bla
     4 push .
     5 rm -r plif bla/bli
     6 push .
     7 rm plif bla/bli/plouf bla/blo/plouf
     8 push .
     9 rm bla/blo/plouf
    10 rm bla/bli/plouf
    11 rm titi toto tutu
    12 rm plif
    13 push .
    14 push bla/bli/plouf bla/blo/plouf
    15 push bla/bli/plouf bla/blo/plouf
    16 push tutu titi
    17 push .
    18 push toto
    19 init
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├++ plif
├++ titi
├++ toto
└++ tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color redo
Error:
  journal has less than 1 redo entries
Exit code: 1
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color push --yes
Listing files...
Listing files to push...
Already exists: bla/blo/plouf
Already exists: bla/bli/plouf
Pushing files...
Pushed: titi
Pushed: toto
Pushed: tutu
Pushed: plif (duplicate of: bla/blo/plouf)
Pushed 4 files (22 B).
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 push .
     1 push bla
     2 rm -r .
     3 push .
     4 rm -r bla
     5 push .
     6 rm -r plif bla/bli
     7 push .
     8 rm plif bla/bli/plouf bla/blo/plouf
     9 push .
    10 rm bla/blo/plouf
    11 rm bla/bli/plouf
    12 rm titi toto tutu
    13 rm plif
    14 push .
    15 push bla/bli/plouf bla/blo/plouf
    16 push bla/bli/plouf bla/blo/plouf
    17 push tutu titi
    18 push .
    19 push toto
    20 init
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
# Check what prune removes.
$ cd /tmp/filou-test/clone
$ main.exe --no-color prune --yes
Removed 56 objects totalling 7.55 kB.
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 30, file count: 6).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 push .
# Check that the main repository is not read with --cache.
$ mv /tmp/filou-test/main /tmp/filou-test/main.backup
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
Error:
  failed to fetch root:
  no such file: /tmp/filou-test/main/root
Exit code: 1
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --cache
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
$ mv /tmp/filou-test/main.backup /tmp/filou-test/main
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 push .
# Check that needed objects are copied in the clone cache when fetching.
$ rm -r -f /tmp/filou-test/clone/.filou
$ main.exe --no-color clone /tmp/filou-test/main /tmp/filou-test/clone
Cloning /tmp/filou-test/main/ into: /tmp/filou-test/clone/
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree bla/bli
└── bla/bli/
    └── plouf
$ cd /tmp/filou-test/clone
$ tree -a -s -F
.
├── [       4096]  bla/
│   ├── [       4096]  bli/
│   │   └── [          4]  plouf
│   └── [       4096]  blo/
│       └── [          4]  plouf
├── [       4096]  .filou/
│   ├── [       4096]  0a/
│   │   └── [       4096]  fa/
│   │       └── [        146]  0afaf91266bbc2bc41a75ebc88936bcbd318743c215db19affffde5e506219b0
│   ├── [       4096]  cash/
│   │   └── [       4096]  bla-/
│   │       └── [       4096]  bli-/
│   │           └── [        101]  self
│   ├── [         44]  config
│   ├── [       4096]  e3/
│   │   └── [       4096]  fe/
│   │       └── [         88]  e3fe3bbcf4c878aa524e1345b9e3dc6f7886c248fad50fc0d82ca6e54cd20930
│   ├── [       4096]  f8/
│   │   └── [       4096]  56/
│   │       └── [        297]  f856f25552b8fc8c6d9e50b7176be4fa4cb39946b3d79c41769e4d795d129286
│   └── [        175]  root
├── [          4]  plif
├── [          6]  titi
├── [          9]  toto
└── [          3]  tutu

13 directories, 12 files
$ cd /tmp/filou-test/clone
$ main.exe --no-color update
Computing reachable object set...
Copied 3 objects.
Clone is up-to-date.
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 push .
# Test prune on the clone.
$ echo 'this is a truc' > bla/bli/truc
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color push --yes bla/bli
Listing files...
Listing files to push...
Already exists: bla/bli/plouf
Pushing files...
Pushed: bla/bli/truc
Pushed 1 files (14 B).
$ cd /tmp/filou-test/clone
$ main.exe --no-color prune --yes
Removed 10 objects totalling 1.76 kB.
# Clone: some objects should have been removed, no files should have been added:
- /tmp/filou-test/clone/.filou/0a/fa/0afaf91266bbc2bc41a75ebc88936bcbd318743c215db19affffde5e506219b0
- /tmp/filou-test/clone/.filou/1a/a0/1aa05bf1ef016a9e97f6f3bc2c82cbd8cd2752f930a1cd950f266c97e0cc7146
- /tmp/filou-test/clone/.filou/9e/20/9e2004f7d7b7e139165ebf9e2a8c0725d4e87fd992c3fbe40f5a8f410c9d3c3e
- /tmp/filou-test/clone/.filou/e3/fe/e3fe3bbcf4c878aa524e1345b9e3dc6f7886c248fad50fc0d82ca6e54cd20930
- /tmp/filou-test/clone/.filou/f8/56/f856f25552b8fc8c6d9e50b7176be4fa4cb39946b3d79c41769e4d795d129286
# Main: should be the same diff:
- /tmp/filou-test/main/0a/fa/0afaf91266bbc2bc41a75ebc88936bcbd318743c215db19affffde5e506219b0
- /tmp/filou-test/main/1a/a0/1aa05bf1ef016a9e97f6f3bc2c82cbd8cd2752f930a1cd950f266c97e0cc7146
- /tmp/filou-test/main/9e/20/9e2004f7d7b7e139165ebf9e2a8c0725d4e87fd992c3fbe40f5a8f410c9d3c3e
- /tmp/filou-test/main/e3/fe/e3fe3bbcf4c878aa524e1345b9e3dc6f7886c248fad50fc0d82ca6e54cd20930
- /tmp/filou-test/main/f8/56/f856f25552b8fc8c6d9e50b7176be4fa4cb39946b3d79c41769e4d795d129286
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 44, file count: 7).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   ├── plouf
│   │   └── truc
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
# Check that if some files are missing from the cache, they are not added.
$ cd /tmp/filou-test/clone
$ explore .filou/root
{
  redo = [];
  head = {
    command = "push bla/bli";
    root = { Non_empty = {
        root_dir = 5d1cbd2da7c70b70c2a74b432b506e130ed4dadf27fc64a4496d411ee0dcfac2;
        hash_index = 5991b49028b00954b9fa769af67c89e030194b25612efff5a864262cfb70a88f;
      } };
  };
  undo = [];
}
$ rm .filou/5d/1c/5d1cbd2da7c70b70c2a74b432b506e130ed4dadf27fc64a4496d411ee0dcfac2
$ rm .filou/59/91/5991b49028b00954b9fa769af67c89e030194b25612efff5a864262cfb70a88f
$ cd /tmp/filou-test/clone
$ main.exe --no-color prune --yes
Removed 0 objects totalling 0 B.
# Clone: diff should be empty:
# Main: diff should also be empty:
# Updating should restore 2 objects:
$ cd /tmp/filou-test/clone
$ main.exe --no-color update
Computing reachable object set...
Copied 2 objects.
Clone is up-to-date.
# Check that if more objects exist in the clone than in the main, they are removed.
$ cd /tmp/filou-test/clone
$ mkdir .filou/01
$ mkdir .filou/01/23
$ echo 'dummy object' > .filou/01/23/01234567fb95b9dd5d20056bc24150b79354852e0f0a28ce578af2b3d2f4b859
$ cd /tmp/filou-test/clone
$ main.exe --no-color prune --yes
Removed 1 objects totalling 12 B.
# Clone: diff should show one removed file:
- /tmp/filou-test/clone/.filou/01/23/01234567fb95b9dd5d20056bc24150b79354852e0f0a28ce578af2b3d2f4b859
# Main: diff should be empty:
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 push bla/bli
# mv: rename a file at the root
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   ├── plouf
│   │   └── truc
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color mv --yes plif newplif
Checking paths...
Listing files...
Moving files...
Moving files... (0 / 1) (0%)
plif -> newplif
Storing root...
Moved 1 files.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   ├── plouf
│   │   └── truc
│   └── blo/
│       └── plouf
├-- newplif
├++ plif
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color pull newplif
Listing files...
Listing files to pull...
Pulling files...
Pulled: newplif
Pulled 1 files (4 B).
$ cat newplif
plif%
$ cat plif
plif%
# mv: rename a file from root to another empty dir
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color mv --yes newplif plop/newnewplif
Checking paths...
Listing files...
Moving files...
Moving files... (0 / 1) (0%)
newplif -> plop/newnewplif
Storing root...
Moved 1 files.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   ├── plouf
│   │   └── truc
│   └── blo/
│       └── plouf
├++ newplif
├++ plif
├-- plop/
│   └-- newnewplif
├── titi
├── toto
└── tutu
# mv: rename a file from root to another non-empty dir
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color mv --yes titi bla/newtiti
Checking paths...
Listing files...
Moving files...
Moving files... (0 / 1) (0%)
titi -> bla/newtiti
Storing root...
Moved 1 files.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   ├── plouf
│   │   └── truc
│   ├── blo/
│   │   └── plouf
│   └-- newtiti
├++ newplif
├++ plif
├-- plop/
│   └-- newnewplif
├++ titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 mv titi bla/newtiti
     1 mv newplif plop/newnewplif
     2 mv plif newplif
     3 push bla/bli
# mv: rename a file to an existing file
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color mv --yes toto tutu
Checking paths...
Error:
  target tutu already exists and is a not a directory
Exit code: 1
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   ├── plouf
│   │   └── truc
│   ├── blo/
│   │   └── plouf
│   └-- newtiti
├++ newplif
├++ plif
├-- plop/
│   └-- newnewplif
├++ titi
├── toto
└── tutu
# mv: check after the previous mv and undo
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 44, file count: 7).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 mv titi bla/newtiti
     1 mv newplif plop/newnewplif
     2 mv plif newplif
     3 push bla/bli
$ cd /tmp/filou-test/clone
$ main.exe --no-color undo 3
$ rm newplif
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   ├── plouf
│   │   └── truc
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
# mv: move several files to a new dir
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color mv --yes bla/bli/plouf tutu bidule
Checking paths...
Listing files...
Moving files...
Moving files... (0 / 2) (0%)
bla/bli/plouf -> bidule/plouf
Moving files... (1 / 2) (50%)
tutu -> bidule/tutu
Storing root...
Moved 2 files.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├-- bidule/
│   ├-- plouf
│   └-- tutu
├── bla/
│   ├── bli/
│   │   ├++ plouf
│   │   └── truc
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└++ tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color undo
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color mv --yes bla/bli/plouf tutu bidule/
Checking paths...
Listing files...
Moving files...
Moving files... (0 / 2) (0%)
bla/bli/plouf -> bidule/plouf
Moving files... (1 / 2) (50%)
tutu -> bidule/tutu
Storing root...
Moved 2 files.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├-- bidule/
│   ├-- plouf
│   └-- tutu
├── bla/
│   ├── bli/
│   │   ├++ plouf
│   │   └── truc
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└++ tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color undo
# mv: move several files to the root
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color mv --yes bla/bli/truc bla/blo/plouf .
Checking paths...
Listing files...
Moving files...
Moving files... (0 / 2) (0%)
bla/bli/truc -> truc
Moving files... (1 / 2) (50%)
bla/blo/plouf -> plouf
Storing root...
Moved 2 files.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   ├── plouf
│   │   └++ truc
│   └++ blo/
├── plif
├-- plouf
├── titi
├── toto
├-- truc
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color undo
# mv: move a file to a directory
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color mv --yes toto bla
Checking paths...
Listing files...
Moving files...
Moving files... (0 / 1) (0%)
toto -> bla/toto
Storing root...
Moved 1 files.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   ├── plouf
│   │   └── truc
│   ├── blo/
│   │   └── plouf
│   └-- toto
├── plif
├── titi
├++ toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color mv --yes titi bla/
Checking paths...
Listing files...
Moving files...
Moving files... (0 / 1) (0%)
titi -> bla/titi
Storing root...
Moved 1 files.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   ├── plouf
│   │   └── truc
│   ├── blo/
│   │   └── plouf
│   ├-- titi
│   └-- toto
├── plif
├++ titi
├++ toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color undo 2
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   ├── plouf
│   │   └── truc
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
# mv: rename a directory
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color mv --yes bla newbla
Checking paths...
Listing files...
Moving files...
Moving files... (0 / 3) (0%)
bla/bli/plouf -> newbla/bli/plouf
Moving files... (1 / 3) (33%)
bla/bli/truc -> newbla/bli/truc
Moving files... (2 / 3) (66%)
bla/blo/plouf -> newbla/blo/plouf
Storing root...
Moved 3 files.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├++ bla/
├-- newbla/
│   ├-- bli/
│   │   ├-- plouf
│   │   └-- truc
│   └-- blo/
│       └-- plouf
├── plif
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 44, file count: 7).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color undo
# mv: move a directory
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color mv --yes bla plop/plif/plouf/
Checking paths...
Listing files...
Moving files...
Moving files... (0 / 3) (0%)
bla/bli/plouf -> plop/plif/plouf/bla/bli/plouf
Moving files... (1 / 3) (33%)
bla/bli/truc -> plop/plif/plouf/bla/bli/truc
Moving files... (2 / 3) (66%)
bla/blo/plouf -> plop/plif/plouf/bla/blo/plouf
Storing root...
Moved 3 files.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├++ bla/
├── plif
├-- plop/
│   └-- plif/
│       └-- plouf/
│           └-- bla/
│               ├-- bli/
│               │   ├-- plouf
│               │   └-- truc
│               └-- blo/
│                   └-- plouf
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 44, file count: 7).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color undo
# mv: rename a directory into a deep directory
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color mv --yes bla plop/plif/plouf
Checking paths...
Listing files...
Moving files...
Moving files... (0 / 3) (0%)
bla/bli/plouf -> plop/plif/plouf/bli/plouf
Moving files... (1 / 3) (33%)
bla/bli/truc -> plop/plif/plouf/bli/truc
Moving files... (2 / 3) (66%)
bla/blo/plouf -> plop/plif/plouf/blo/plouf
Storing root...
Moved 3 files.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├++ bla/
├── plif
├-- plop/
│   └-- plif/
│       └-- plouf/
│           ├-- bli/
│           │   ├-- plouf
│           │   └-- truc
│           └-- blo/
│               └-- plouf
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color mv --yes plop/plif/plouf/bli bidule/machin
Checking paths...
Listing files...
Moving files...
Moving files... (0 / 2) (0%)
plop/plif/plouf/bli/plouf -> bidule/machin/plouf
Moving files... (1 / 2) (50%)
plop/plif/plouf/bli/truc -> bidule/machin/truc
Storing root...
Moved 2 files.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├-- bidule/
│   └-- machin/
│       ├-- plouf
│       └-- truc
├++ bla/
├── plif
├-- plop/
│   └-- plif/
│       └-- plouf/
│           └-- blo/
│               └-- plouf
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 44, file count: 7).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color undo 2
# mv: move a directory into a directory that already exists
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   ├── plouf
│   │   └── truc
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color mv --yes bla/blo bla/bli
Checking paths...
Listing files...
Moving files...
Moving files... (0 / 1) (0%)
bla/blo/plouf -> bla/bli/blo/plouf
Storing root...
Moved 1 files.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   ├-- blo/
│   │   │   └-- plouf
│   │   ├── plouf
│   │   └── truc
│   └++ blo/
├── plif
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color undo
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color mv --yes bla/blo bla/bli/
Checking paths...
Listing files...
Moving files...
Moving files... (0 / 1) (0%)
bla/blo/plouf -> bla/bli/blo/plouf
Storing root...
Moved 1 files.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   ├-- blo/
│   │   │   └-- plouf
│   │   ├── plouf
│   │   └── truc
│   └++ blo/
├── plif
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color undo
# mv: move a file and a directory at the same time
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   ├── plouf
│   │   └── truc
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color mv --yes plif bla/bli some/new/directory
Checking paths...
Listing files...
Moving files...
Moving files... (0 / 3) (0%)
plif -> some/new/directory/plif
Moving files... (1 / 3) (33%)
bla/bli/plouf -> some/new/directory/bli/plouf
Moving files... (2 / 3) (66%)
bla/bli/truc -> some/new/directory/bli/truc
Storing root...
Moved 3 files.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├++ bli/
│   └── blo/
│       └── plouf
├++ plif
├-- some/
│   └-- new/
│       └-- directory/
│           ├-- bli/
│           │   ├-- plouf
│           │   └-- truc
│           └-- plif
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color undo
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color mv --yes plif bla/bli some/new/directory/
Checking paths...
Listing files...
Moving files...
Moving files... (0 / 3) (0%)
plif -> some/new/directory/plif
Moving files... (1 / 3) (33%)
bla/bli/plouf -> some/new/directory/bli/plouf
Moving files... (2 / 3) (66%)
bla/bli/truc -> some/new/directory/bli/truc
Storing root...
Moved 3 files.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├++ bli/
│   └── blo/
│       └── plouf
├++ plif
├-- some/
│   └-- new/
│       └-- directory/
│           ├-- bli/
│           │   ├-- plouf
│           │   └-- truc
│           └-- plif
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color undo
# mv: move a file onto itself
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color mv --yes toto toto
Checking paths...
Error:
  target toto already exists and is a not a directory
Exit code: 1
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   ├── plouf
│   │   └── truc
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
# mv: move a file into a directory named after itself
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   ├── plouf
│   │   └── truc
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color mv --yes plif plif/newplif
Checking paths...
Listing files...
Moving files...
Moving files... (0 / 1) (0%)
plif -> plif/newplif
Storing root...
Moved 1 files.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   ├── plouf
│   │   └── truc
│   └── blo/
│       └── plouf
├── plif?
├── titi
├── toto
└── tutu
$ cat plif
plif%
$ rm plif
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   ├── plouf
│   │   └── truc
│   └── blo/
│       └── plouf
├-- plif/
│   └-- newplif
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color pull
Listing files...
Listing files to pull...
Already exists: bla/bli/plouf
Already exists: bla/bli/truc
Already exists: bla/blo/plouf
Already exists: titi
Already exists: toto
Already exists: tutu
Pulling files...
Pulled: plif/newplif
Pulled 1 files (4 B).
$ cat plif/newplif
plif%
$ cd /tmp/filou-test/clone
$ main.exe --no-color undo
$ rm -r -f /tmp/filou-test/clone/plif
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color pull
Listing files...
Listing files to pull...
Already exists: bla/bli/plouf
Already exists: bla/bli/truc
Already exists: bla/blo/plouf
Already exists: titi
Already exists: toto
Already exists: tutu
Pulling files...
Pulled: plif
Pulled 1 files (4 B).
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   ├── plouf
│   │   └── truc
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color mv --yes plif plif/
Checking paths...
Error:
  target plif already exists and is a not a directory
Exit code: 1
# mv: rename a directory into the root directory
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color mv --yes bla/bli .
Checking paths...
Listing files...
Moving files...
Moving files... (0 / 2) (0%)
bla/bli/plouf -> bli/plouf
Moving files... (1 / 2) (50%)
bla/bli/truc -> bli/truc
Storing root...
Moved 2 files.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├++ bli/
│   └── blo/
│       └── plouf
├-- bli/
│   ├-- plouf
│   └-- truc
├── plif
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color undo
# mv: rename a less deep directory into the root directory
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color mv --yes bla .
Checking paths...
Listing files...
Moving files...
Moving files... (0 / 3) (0%)
bla/bli/plouf -> bla/bli/plouf
Moving files... (1 / 3) (33%)
bla/bli/truc -> bla/bli/truc
Moving files... (2 / 3) (66%)
bla/blo/plouf -> bla/blo/plouf
Storing root...
Moved 3 files.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   ├── plouf
│   │   └── truc
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color undo
# mv: move the root directory
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color mv --yes . bla/bli
Checking paths...
Error:
  cannot move the root directory
Exit code: 1
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color mv --yes . bla/bli/
Checking paths...
Error:
  cannot move the root directory
Exit code: 1
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 44, file count: 7).
All files are available.
Hash index is consistent with the directory structure.
# cp: rename a file at the root
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   ├── plouf
│   │   └── truc
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color cp --yes plif newplif
Checking paths...
Listing files...
Copying files...
Copying files... (0 / 1) (0%)
plif -> newplif
Storing root...
Copied 1 files.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --duplicates
./
├── bla/
│   ├── bli/
│   │   ├── plouf
│   │   └── truc
│   └── blo/
│       └── plouf
│           = /newplif
│           = /plif
├-- newplif
│   = /bla/blo/plouf
│   = /plif
├── plif
│   = /bla/blo/plouf
│   = /newplif
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color pull newplif
Listing files...
Listing files to pull...
Pulling files...
Pulled: newplif
Pulled 1 files (4 B).
$ cat newplif
plif%
$ cat plif
plif%
# cp: copy a file from root to another empty dir
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color cp --yes newplif plop/newnewplif
Checking paths...
Listing files...
Copying files...
Copying files... (0 / 1) (0%)
newplif -> plop/newnewplif
Storing root...
Copied 1 files.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --duplicates
./
├── bla/
│   ├── bli/
│   │   ├── plouf
│   │   └── truc
│   └── blo/
│       └── plouf
│           = /newplif
│           = /plif
│           = /plop/newnewplif
├── newplif
│   = /bla/blo/plouf
│   = /plif
│   = /plop/newnewplif
├── plif
│   = /bla/blo/plouf
│   = /newplif
│   = /plop/newnewplif
├-- plop/
│   └-- newnewplif
│       = /bla/blo/plouf
│       = /newplif
│       = /plif
├── titi
├── toto
└── tutu
# cp: copy a file from root to another non-empty dir
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color cp --yes titi bla/newtiti
Checking paths...
Listing files...
Copying files...
Copying files... (0 / 1) (0%)
titi -> bla/newtiti
Storing root...
Copied 1 files.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --duplicates
./
├── bla/
│   ├── bli/
│   │   ├── plouf
│   │   └── truc
│   ├── blo/
│   │   └── plouf
│   │       = /newplif
│   │       = /plif
│   │       = /plop/newnewplif
│   └-- newtiti
│       = /titi
├── newplif
│   = /bla/blo/plouf
│   = /plif
│   = /plop/newnewplif
├── plif
│   = /bla/blo/plouf
│   = /newplif
│   = /plop/newnewplif
├-- plop/
│   └-- newnewplif
│       = /bla/blo/plouf
│       = /newplif
│       = /plif
├── titi
│   = /bla/newtiti
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 cp titi bla/newtiti
     1 cp newplif plop/newnewplif
     2 cp plif newplif
     3 push bla/bli
# cp: copy a file to an existing file
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color cp --yes toto tutu
Checking paths...
Error:
  target tutu already exists and is a not a directory
Exit code: 1
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --duplicates
./
├── bla/
│   ├── bli/
│   │   ├── plouf
│   │   └── truc
│   ├── blo/
│   │   └── plouf
│   │       = /newplif
│   │       = /plif
│   │       = /plop/newnewplif
│   └-- newtiti
│       = /titi
├── newplif
│   = /bla/blo/plouf
│   = /plif
│   = /plop/newnewplif
├── plif
│   = /bla/blo/plouf
│   = /newplif
│   = /plop/newnewplif
├-- plop/
│   └-- newnewplif
│       = /bla/blo/plouf
│       = /newplif
│       = /plif
├── titi
│   = /bla/newtiti
├── toto
└── tutu
# cp: check after the previous cp and undo
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 58, file count: 10).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 cp titi bla/newtiti
     1 cp newplif plop/newnewplif
     2 cp plif newplif
     3 push bla/bli
$ cd /tmp/filou-test/clone
$ main.exe --no-color undo 3
$ rm newplif
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --duplicates
./
├── bla/
│   ├── bli/
│   │   ├── plouf
│   │   └── truc
│   └── blo/
│       └── plouf
│           = /plif
├── plif
│   = /bla/blo/plouf
├── titi
├── toto
└── tutu
# cp: copy several files to a new dir
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color cp --yes bla/bli/plouf tutu bidule
Checking paths...
Listing files...
Copying files...
Copying files... (0 / 2) (0%)
bla/bli/plouf -> bidule/plouf
Copying files... (1 / 2) (50%)
tutu -> bidule/tutu
Storing root...
Copied 2 files.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --duplicates
./
├-- bidule/
│   ├-- plouf
│   │   = /bla/bli/plouf
│   └-- tutu
│       = /tutu
├── bla/
│   ├── bli/
│   │   ├── plouf
│   │   │   = /bidule/plouf
│   │   └── truc
│   └── blo/
│       └── plouf
│           = /plif
├── plif
│   = /bla/blo/plouf
├── titi
├── toto
└── tutu
    = /bidule/tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color undo
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color cp --yes bla/bli/plouf tutu bidule/
Checking paths...
Listing files...
Copying files...
Copying files... (0 / 2) (0%)
bla/bli/plouf -> bidule/plouf
Copying files... (1 / 2) (50%)
tutu -> bidule/tutu
Storing root...
Copied 2 files.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --duplicates
./
├-- bidule/
│   ├-- plouf
│   │   = /bla/bli/plouf
│   └-- tutu
│       = /tutu
├── bla/
│   ├── bli/
│   │   ├── plouf
│   │   │   = /bidule/plouf
│   │   └── truc
│   └── blo/
│       └── plouf
│           = /plif
├── plif
│   = /bla/blo/plouf
├── titi
├── toto
└── tutu
    = /bidule/tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color undo
# cp: copy several files to the root
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color cp --yes bla/bli/truc bla/blo/plouf .
Checking paths...
Listing files...
Copying files...
Copying files... (0 / 2) (0%)
bla/bli/truc -> truc
Copying files... (1 / 2) (50%)
bla/blo/plouf -> plouf
Storing root...
Copied 2 files.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --duplicates
./
├── bla/
│   ├── bli/
│   │   ├── plouf
│   │   └── truc
│   │       = /truc
│   └── blo/
│       └── plouf
│           = /plif
│           = /plouf
├── plif
│   = /bla/blo/plouf
│   = /plouf
├-- plouf
│   = /bla/blo/plouf
│   = /plif
├── titi
├── toto
├-- truc
│   = /bla/bli/truc
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color undo
# cp: copy a file to a directory
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color cp --yes toto bla
Checking paths...
Listing files...
Copying files...
Copying files... (0 / 1) (0%)
toto -> bla/toto
Storing root...
Copied 1 files.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --duplicates
./
├── bla/
│   ├── bli/
│   │   ├── plouf
│   │   └── truc
│   ├── blo/
│   │   └── plouf
│   │       = /plif
│   └-- toto
│       = /toto
├── plif
│   = /bla/blo/plouf
├── titi
├── toto
│   = /bla/toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color cp --yes titi bla/
Checking paths...
Listing files...
Copying files...
Copying files... (0 / 1) (0%)
titi -> bla/titi
Storing root...
Copied 1 files.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --duplicates
./
├── bla/
│   ├── bli/
│   │   ├── plouf
│   │   └── truc
│   ├── blo/
│   │   └── plouf
│   │       = /plif
│   ├-- titi
│   │   = /titi
│   └-- toto
│       = /toto
├── plif
│   = /bla/blo/plouf
├── titi
│   = /bla/titi
├── toto
│   = /bla/toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color undo 2
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --duplicates
./
├── bla/
│   ├── bli/
│   │   ├── plouf
│   │   └── truc
│   └── blo/
│       └── plouf
│           = /plif
├── plif
│   = /bla/blo/plouf
├── titi
├── toto
└── tutu
# cp: copy a directory
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color cp --yes bla newbla
Checking paths...
Listing files...
Copying files...
Copying files... (0 / 3) (0%)
bla/bli/plouf -> newbla/bli/plouf
Copying files... (1 / 3) (33%)
bla/bli/truc -> newbla/bli/truc
Copying files... (2 / 3) (66%)
bla/blo/plouf -> newbla/blo/plouf
Storing root...
Copied 3 files.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --duplicates
./
├── bla/
│   ├── bli/
│   │   ├── plouf
│   │   │   = /newbla/bli/plouf
│   │   └── truc
│   │       = /newbla/bli/truc
│   └── blo/
│       └── plouf
│           = /newbla/blo/plouf
│           = /plif
├-- newbla/
│   ├-- bli/
│   │   ├-- plouf
│   │   │   = /bla/bli/plouf
│   │   └-- truc
│   │       = /bla/bli/truc
│   └-- blo/
│       └-- plouf
│           = /bla/blo/plouf
│           = /plif
├── plif
│   = /bla/blo/plouf
│   = /newbla/blo/plouf
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 66, file count: 10).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color undo
# cp: copy a directory
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color cp --yes bla plop/plif/plouf/
Checking paths...
Listing files...
Copying files...
Copying files... (0 / 3) (0%)
bla/bli/plouf -> plop/plif/plouf/bla/bli/plouf
Copying files... (1 / 3) (33%)
bla/bli/truc -> plop/plif/plouf/bla/bli/truc
Copying files... (2 / 3) (66%)
bla/blo/plouf -> plop/plif/plouf/bla/blo/plouf
Storing root...
Copied 3 files.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --duplicates
./
├── bla/
│   ├── bli/
│   │   ├── plouf
│   │   │   = /plop/plif/plouf/bla/bli/plouf
│   │   └── truc
│   │       = /plop/plif/plouf/bla/bli/truc
│   └── blo/
│       └── plouf
│           = /plif
│           = /plop/plif/plouf/bla/blo/plouf
├── plif
│   = /bla/blo/plouf
│   = /plop/plif/plouf/bla/blo/plouf
├-- plop/
│   └-- plif/
│       └-- plouf/
│           └-- bla/
│               ├-- bli/
│               │   ├-- plouf
│               │   │   = /bla/bli/plouf
│               │   └-- truc
│               │       = /bla/bli/truc
│               └-- blo/
│                   └-- plouf
│                       = /bla/blo/plouf
│                       = /plif
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 66, file count: 10).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color undo
# cp: copy a directory into a deep directory
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color cp --yes bla plop/plif/plouf
Checking paths...
Listing files...
Copying files...
Copying files... (0 / 3) (0%)
bla/bli/plouf -> plop/plif/plouf/bli/plouf
Copying files... (1 / 3) (33%)
bla/bli/truc -> plop/plif/plouf/bli/truc
Copying files... (2 / 3) (66%)
bla/blo/plouf -> plop/plif/plouf/blo/plouf
Storing root...
Copied 3 files.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --duplicates
./
├── bla/
│   ├── bli/
│   │   ├── plouf
│   │   │   = /plop/plif/plouf/bli/plouf
│   │   └── truc
│   │       = /plop/plif/plouf/bli/truc
│   └── blo/
│       └── plouf
│           = /plif
│           = /plop/plif/plouf/blo/plouf
├── plif
│   = /bla/blo/plouf
│   = /plop/plif/plouf/blo/plouf
├-- plop/
│   └-- plif/
│       └-- plouf/
│           ├-- bli/
│           │   ├-- plouf
│           │   │   = /bla/bli/plouf
│           │   └-- truc
│           │       = /bla/bli/truc
│           └-- blo/
│               └-- plouf
│                   = /bla/blo/plouf
│                   = /plif
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color cp --yes plop/plif/plouf/bli bidule/machin
Checking paths...
Listing files...
Copying files...
Copying files... (0 / 2) (0%)
plop/plif/plouf/bli/plouf -> bidule/machin/plouf
Copying files... (1 / 2) (50%)
plop/plif/plouf/bli/truc -> bidule/machin/truc
Storing root...
Copied 2 files.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --duplicates
./
├-- bidule/
│   └-- machin/
│       ├-- plouf
│       │   = /bla/bli/plouf
│       │   = /plop/plif/plouf/bli/plouf
│       └-- truc
│           = /bla/bli/truc
│           = /plop/plif/plouf/bli/truc
├── bla/
│   ├── bli/
│   │   ├── plouf
│   │   │   = /bidule/machin/plouf
│   │   │   = /plop/plif/plouf/bli/plouf
│   │   └── truc
│   │       = /bidule/machin/truc
│   │       = /plop/plif/plouf/bli/truc
│   └── blo/
│       └── plouf
│           = /plif
│           = /plop/plif/plouf/blo/plouf
├── plif
│   = /bla/blo/plouf
│   = /plop/plif/plouf/blo/plouf
├-- plop/
│   └-- plif/
│       └-- plouf/
│           ├-- bli/
│           │   ├-- plouf
│           │   │   = /bidule/machin/plouf
│           │   │   = /bla/bli/plouf
│           │   └-- truc
│           │       = /bidule/machin/truc
│           │       = /bla/bli/truc
│           └-- blo/
│               └-- plouf
│                   = /bla/blo/plouf
│                   = /plif
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 84, file count: 12).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color undo 2
# cp: copy a directory into a directory that already exists
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --duplicates
./
├── bla/
│   ├── bli/
│   │   ├── plouf
│   │   └── truc
│   └── blo/
│       └── plouf
│           = /plif
├── plif
│   = /bla/blo/plouf
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color cp --yes bla/blo bla/bli
Checking paths...
Listing files...
Copying files...
Copying files... (0 / 1) (0%)
bla/blo/plouf -> bla/bli/blo/plouf
Storing root...
Copied 1 files.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --duplicates
./
├── bla/
│   ├── bli/
│   │   ├-- blo/
│   │   │   └-- plouf
│   │   │       = /bla/blo/plouf
│   │   │       = /plif
│   │   ├── plouf
│   │   └── truc
│   └── blo/
│       └── plouf
│           = /bla/bli/blo/plouf
│           = /plif
├── plif
│   = /bla/bli/blo/plouf
│   = /bla/blo/plouf
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color undo
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color cp --yes bla/blo bla/bli/
Checking paths...
Listing files...
Copying files...
Copying files... (0 / 1) (0%)
bla/blo/plouf -> bla/bli/blo/plouf
Storing root...
Copied 1 files.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --duplicates
./
├── bla/
│   ├── bli/
│   │   ├-- blo/
│   │   │   └-- plouf
│   │   │       = /bla/blo/plouf
│   │   │       = /plif
│   │   ├── plouf
│   │   └── truc
│   └── blo/
│       └── plouf
│           = /bla/bli/blo/plouf
│           = /plif
├── plif
│   = /bla/bli/blo/plouf
│   = /bla/blo/plouf
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color undo
# cp: copy a file and a directory at the same time
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --duplicates
./
├── bla/
│   ├── bli/
│   │   ├── plouf
│   │   └── truc
│   └── blo/
│       └── plouf
│           = /plif
├── plif
│   = /bla/blo/plouf
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color cp --yes plif bla/bli some/new/directory
Checking paths...
Listing files...
Copying files...
Copying files... (0 / 3) (0%)
plif -> some/new/directory/plif
Copying files... (1 / 3) (33%)
bla/bli/plouf -> some/new/directory/bli/plouf
Copying files... (2 / 3) (66%)
bla/bli/truc -> some/new/directory/bli/truc
Storing root...
Copied 3 files.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --duplicates
./
├── bla/
│   ├── bli/
│   │   ├── plouf
│   │   │   = /some/new/directory/bli/plouf
│   │   └── truc
│   │       = /some/new/directory/bli/truc
│   └── blo/
│       └── plouf
│           = /plif
│           = /some/new/directory/plif
├── plif
│   = /bla/blo/plouf
│   = /some/new/directory/plif
├-- some/
│   └-- new/
│       └-- directory/
│           ├-- bli/
│           │   ├-- plouf
│           │   │   = /bla/bli/plouf
│           │   └-- truc
│           │       = /bla/bli/truc
│           └-- plif
│               = /bla/blo/plouf
│               = /plif
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color undo
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color cp --yes plif bla/bli some/new/directory/
Checking paths...
Listing files...
Copying files...
Copying files... (0 / 3) (0%)
plif -> some/new/directory/plif
Copying files... (1 / 3) (33%)
bla/bli/plouf -> some/new/directory/bli/plouf
Copying files... (2 / 3) (66%)
bla/bli/truc -> some/new/directory/bli/truc
Storing root...
Copied 3 files.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --duplicates
./
├── bla/
│   ├── bli/
│   │   ├── plouf
│   │   │   = /some/new/directory/bli/plouf
│   │   └── truc
│   │       = /some/new/directory/bli/truc
│   └── blo/
│       └── plouf
│           = /plif
│           = /some/new/directory/plif
├── plif
│   = /bla/blo/plouf
│   = /some/new/directory/plif
├-- some/
│   └-- new/
│       └-- directory/
│           ├-- bli/
│           │   ├-- plouf
│           │   │   = /bla/bli/plouf
│           │   └-- truc
│           │       = /bla/bli/truc
│           └-- plif
│               = /bla/blo/plouf
│               = /plif
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color undo
# cp: copy a file onto itself
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color cp --yes toto toto
Checking paths...
Error:
  target toto already exists and is a not a directory
Exit code: 1
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --duplicates
./
├── bla/
│   ├── bli/
│   │   ├── plouf
│   │   └── truc
│   └── blo/
│       └── plouf
│           = /plif
├── plif
│   = /bla/blo/plouf
├── titi
├── toto
└── tutu
# cp: copy a file into a directory named after itself
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --duplicates
./
├── bla/
│   ├── bli/
│   │   ├── plouf
│   │   └── truc
│   └── blo/
│       └── plouf
│           = /plif
├── plif
│   = /bla/blo/plouf
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color cp --yes plif plif/newplif
Checking paths...
Listing files...
Copying files...
Copying files... (0 / 1) (0%)
Error:
  failed to add file: plif/newplif:
  parent directory already exists as a file: plif
Exit code: 1
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --duplicates
./
├── bla/
│   ├── bli/
│   │   ├── plouf
│   │   └── truc
│   └── blo/
│       └── plouf
│           = /plif
├── plif
│   = /bla/blo/plouf
├── titi
├── toto
└── tutu
$ cat plif
plif%
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color cp --yes plif plif/
Checking paths...
Error:
  target plif already exists and is a not a directory
Exit code: 1
# cp: copy a directory into the root directory
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color cp --yes bla/bli .
Checking paths...
Listing files...
Copying files...
Copying files... (0 / 2) (0%)
bla/bli/plouf -> bli/plouf
Copying files... (1 / 2) (50%)
bla/bli/truc -> bli/truc
Storing root...
Copied 2 files.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --duplicates
./
├── bla/
│   ├── bli/
│   │   ├── plouf
│   │   │   = /bli/plouf
│   │   └── truc
│   │       = /bli/truc
│   └── blo/
│       └── plouf
│           = /plif
├-- bli/
│   ├-- plouf
│   │   = /bla/bli/plouf
│   └-- truc
│       = /bla/bli/truc
├── plif
│   = /bla/blo/plouf
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color undo
# cp: copy a less deep directory into the root directory
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color cp --yes bla .
Checking paths...
Listing files...
Copying files...
Copying files... (0 / 3) (0%)
Already exists: bla/bli/plouf
Copying files... (1 / 3) (33%)
Already exists: bla/bli/truc
Copying files... (2 / 3) (66%)
Already exists: bla/blo/plouf
Storing root...
Copied 3 files.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --duplicates
./
├── bla/
│   ├── bli/
│   │   ├── plouf
│   │   └── truc
│   └── blo/
│       └── plouf
│           = /plif
├── plif
│   = /bla/blo/plouf
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color undo
# cp: copy the root directory
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color cp --yes . bla/bli
Checking paths...
Error:
  cannot copy the root directory
Exit code: 1
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color cp --yes . bla/bli/
Checking paths...
Error:
  cannot copy the root directory
Exit code: 1
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 44, file count: 7).
All files are available.
Hash index is consistent with the directory structure.
# cash: modify a file (keeping the same size) and try to push it again
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --duplicates
./
├── bla/
│   ├── bli/
│   │   ├── plouf
│   │   └── truc
│   └── blo/
│       └── plouf
│           = /plif
├── plif
│   = /bla/blo/plouf
├── titi
├── toto
└── tutu
$ cat toto
blablabla%
$ rm toto
$ echo TOTTOTTOT > toto
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --duplicates
./
├── bla/
│   ├── bli/
│   │   ├── plouf
│   │   └── truc
│   └── blo/
│       └── plouf
│           = /plif
├── plif
│   = /bla/blo/plouf
├── titi
├≠≠ toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color push --yes toto
Listing files...
Listing files to push...
Error:
  toto already exists with a different hash
Exit code: 1
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color pull toto
Listing files...
Listing files to pull...
Error:
  toto already exists with a different hash
Exit code: 1
# Push a file, remove it and re-push it from another clone.
$ rm -r -f /tmp/filou-test/main
$ rm -r -f /tmp/filou-test/clone
$ main.exe --no-color init /tmp/filou-test/main
$ main.exe --no-color clone /tmp/filou-test/main /tmp/filou-test/clone
Cloning /tmp/filou-test/main/ into: /tmp/filou-test/clone/
$ cd /tmp/filou-test/clone
$ echo 'contents of bla first version' > bla
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color push --yes
Listing files...
Listing files to push...
Pushing files...
Pushed: bla
Pushed 1 files (29 B).
$ main.exe --no-color clone /tmp/filou-test/main /tmp/filou-test/clone2
Cloning /tmp/filou-test/main/ into: /tmp/filou-test/clone2/
$ cd /tmp/filou-test/clone2
$ cd /tmp/filou-test/clone2
$ main.exe --no-color rm --yes bla
Listing files...
Removing files...
Storing root...
Removed 1 files.
$ echo 'contents of bla second version' > bla
$ cd /tmp/filou-test/clone2
$ main.exe -v --no-color push --yes
Listing files...
Listing files to push...
Pushing files...
Pushed: bla
Pushed 1 files (30 B).
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
└≠≠ bla
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 30, file count: 1).
All files are available.
Hash index is consistent with the directory structure.
# Test the show command with large recursivity.
$ cd /tmp/filou-test/clone
$ main.exe --no-color show -r 1000
{
  redo = [];
  head = {
    command = "push .";
    root = { Non_empty = {
        root_dir = b0c9f424feb3ae1cba7fe3807a9ed48aa711d2ee258be31a4d2dd8e275640cd4 =
        [ { File = {
              name = "bla";
              hash = 20580e3e285f773043630dc3218e4d40339c4e353093c680d54136b5fffcddfa =
              "";
              size = 30 (hash);
            } } ];
        hash_index = 0f239ca28a64304488fa18e3ffcd2ff424ce29daf73ff562269522207215a332 =
        { Leaf = 7510285b46cec8bca1ba13817a4d0620472d677fbd7cd11545280118fca0d062 =
          [ {
              hash = 20580e3e285f773043630dc3218e4d40339c4e353093c680d54136b5fffcddfa =
              "";
              paths = [ [ "bla" ] ];
            } ] };
      } };
  };
  undo = [
    {
      command = "rm bla";
      root = 33 (Empty);
    };
    {
      command = "push .";
      root = { Non_empty = {
          root_dir = 9179194f892491c3939217bd61c6ddc1c603bf630cbbe4870a90f97779adf29d =
          [ { File = {
                name = "bla";
                hash = 20d3840f86a24fa8883fa9be2c7f9018850bd1855993a300fd6d5572a25bc568 =
                "";
                size = 29;
              } } ];
          hash_index = a00b3532afa8b96f982d13ac61ea2a0066bd30dde320a2807485ddcc42d6b32d =
          { Leaf = d8a56350a217dc077ac9961c126dec7d86b1d16546020deeae7fa5ee43b05a2b =
            [ {
                hash = 20d3840f86a24fa8883fa9be2c7f9018850bd1855993a300fd6d5572a25bc568 =
                "";
                paths = [ [ "bla" ] ];
              } ] };
        } };
    };
    {
      command = "init";
      root = 33 (Empty);
    };
  ];
}
