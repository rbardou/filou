# Initialize a main repository and a clone.
$ main.exe --no-color init /tmp/filou-test/main
$ main.exe --no-color clone /tmp/filou-test/main /tmp/filou-test/clone
Cloning /tmp/filou-test/main/ into: /tmp/filou-test/clone/
$ cd /tmp/filou-test/clone
$ explore .filou/config
{ main = "/tmp/filou-test/main/" }
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Repository is empty.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 init
# Play with the configuration.
$ main.exe --no-color config
clone repository: /tmp/filou-test/clone/
main repository: /tmp/filou-test/main/
$ main.exe --no-color config --main /tmp
$ main.exe --no-color config
clone repository: /tmp/filou-test/clone/
main repository: /tmp/
$ main.exe --no-color config --main /tmp/filou-test/main
$ main.exe --no-color config
clone repository: /tmp/filou-test/clone/
main repository: /tmp/filou-test/main/
# Add a file.
$ cd /tmp/filou-test/clone
$ echo blablabla > toto
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color push toto
Pushed: toto
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 9, file count: 1).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
└── toto
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 push toto
     1 init
$ cd /tmp/filou-test/clone
$ main.exe --no-color diff
+  toto
# Add the file again.
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color push
Already exists: toto
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 9, file count: 1).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
└── toto
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 push .
     1 push toto
     2 init
$ cd /tmp/filou-test/clone
$ main.exe --no-color diff
# Add several files.
$ cd /tmp/filou-test/clone
$ echo blu > tutu
$ echo blibli > titi
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color push tutu titi
Pushed: tutu
Pushed: titi
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 18, file count: 3).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 push tutu titi
     1 push .
     2 push toto
     3 init
$ cd /tmp/filou-test/clone
$ main.exe --no-color diff
+  titi
+  tutu
# Add files in subdirectories.
$ cd /tmp/filou-test/clone
$ mkdir bla
$ mkdir bla/bli
$ echo plaf > bla/bli/plouf
$ mkdir bla/blo
$ echo plif > bla/blo/plouf
$ cd /tmp/filou-test/clone
$ main.exe -v --dry-run --no-color push bla/bli/plouf bla/blo/plouf
Pushed: bla/bli/plouf
Pushed: bla/blo/plouf
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color push bla/bli/plouf bla/blo/plouf
Pushed: bla/bli/plouf
Pushed: bla/blo/plouf
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color push bla/bli/plouf bla/blo/plouf
Already exists: bla/bli/plouf
Already exists: bla/blo/plouf
$ cd /tmp/filou-test/clone
$ main.exe --no-color check --cache
Directory structure looks ok (total size: 26, file count: 5).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 push bla/bli/plouf bla/blo/plouf
     1 push bla/bli/plouf bla/blo/plouf
     2 push tutu titi
     3 push .
     4 push toto
     5 init
$ cd /tmp/filou-test/clone
$ main.exe --no-color diff 3
+  bla/
+  titi
+  tutu
# Test tree.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree bla
└── bla/
    ├── bli/
    │   └── plouf
    └── blo/
        └── plouf
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree bla/blo
└── bla/blo/
    └── plouf
$ cd /tmp/filou-test/clone/bla/bli
$ main.exe --no-color tree
└── bla/bli/
    └── plouf
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree bla/blo/blu/ble
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree bla/blo/plouf/ble
Error:
  failed to get path type for bla/blo/plouf/ble in /tmp/filou-test/clone/:
  failed to read file: /tmp/filou-test/clone/bla/blo/plouf/ble:
  Not a directory
Exit code: 1
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree bla/blo/plouf
└── bla/blo/plouf
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --depth 0
./
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --depth 1
./
├── bla/
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --depth 2
./
├── bla/
│   ├── bli/
│   └── blo/
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --depth 3
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --depth 0 bla
└── bla/
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --depth 1 bla
└── bla/
    ├── bli/
    └── blo/
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --depth 2 bla
└── bla/
    ├── bli/
    │   └── plouf
    └── blo/
        └── plouf
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --only-dirs
./
└── bla/
    ├── bli/
    └── blo/
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --depth 1 --only-dirs
./
└── bla/
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --size
./ (26 B)
├── bla/ (8 B)
│   ├── bli/ (4 B)
│   │   └── plouf (4 B)
│   └── blo/ (4 B)
│       └── plouf (4 B)
├── titi (6 B)
├── toto (9 B)
└── tutu (3 B)
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --count
./ (5 files)
├── bla/ (2 files)
│   ├── bli/ (1 file)
│   │   └── plouf
│   └── blo/ (1 file)
│       └── plouf
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --size --count
./ (26 B) (5 files)
├── bla/ (8 B) (2 files)
│   ├── bli/ (4 B) (1 file)
│   │   └── plouf (4 B)
│   └── blo/ (4 B) (1 file)
│       └── plouf (4 B)
├── titi (6 B)
├── toto (9 B)
└── tutu (3 B)
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 push bla/bli/plouf bla/blo/plouf
     1 push bla/bli/plouf bla/blo/plouf
     2 push tutu titi
     3 push .
     4 push toto
     5 init
# Test duplicates.
$ echo plif > plif
$ cd /tmp/filou-test/clone
$ main.exe -v --dry-run --no-color push
Already exists: titi
Already exists: bla/blo/plouf
Already exists: bla/bli/plouf
Already exists: toto
Already exists: tutu
Pushed: plif (duplicate of: bla/blo/plouf)
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --duplicates
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├++ plif
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color push
Already exists: titi
Already exists: bla/blo/plouf
Already exists: bla/bli/plouf
Already exists: toto
Already exists: tutu
Pushed: plif (duplicate of: bla/blo/plouf)
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --duplicates
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
│           = /plif
├── plif
│   = /bla/blo/plouf
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 push .
     1 push bla/bli/plouf bla/blo/plouf
     2 push bla/bli/plouf bla/blo/plouf
     3 push tutu titi
     4 push .
     5 push toto
     6 init
$ cd /tmp/filou-test/clone
$ main.exe --no-color diff
+  plif
# Try to pull files.
$ rm titi
$ rm tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├-- titi
├── toto
└-- tutu
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color pull titi
Pulled: titi
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└-- tutu
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color pull tutu
Pulled: tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
$ rm titi
$ rm tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├-- titi
├── toto
└-- tutu
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color pull titi tutu
Pulled: titi
Pulled: tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
$ rm tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└-- tutu
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color pull titi tutu
Already exists: titi
Pulled: tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
$ rm bla/bli/plouf
$ rmdir bla/bli
$ rm plif
$ rm toto
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├-- bli/
│   │   └-- plouf
│   └── blo/
│       └── plouf
├-- plif
├── titi
├-- toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color pull bla/bli
Pulled: bla/bli/plouf
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├-- plif
├── titi
├-- toto
└── tutu
$ rm bla/bli/plouf
$ rmdir bla/bli
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├-- bli/
│   │   └-- plouf
│   └── blo/
│       └── plouf
├-- plif
├── titi
├-- toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color pull bla
Pulled: bla/bli/plouf
Already exists: bla/blo/plouf
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├-- plif
├── titi
├-- toto
└── tutu
$ rm bla/bli/plouf
$ rmdir bla/bli
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├-- bli/
│   │   └-- plouf
│   └── blo/
│       └── plouf
├-- plif
├── titi
├-- toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color pull
Pulled: bla/bli/plouf
Already exists: bla/blo/plouf
Pulled: plif
Already exists: titi
Pulled: toto
Already exists: tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 30, file count: 6).
All files are available.
Hash index is consistent with the directory structure.
$ cat bla/bli/plouf
plaf%
$ cat bla/blo/plouf
plif%
$ cat plif
plif%
$ cat titi
blibli%
$ cat toto
blablabla%
$ cat tutu
blu%
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 push .
     1 push bla/bli/plouf bla/blo/plouf
     2 push bla/bli/plouf bla/blo/plouf
     3 push tutu titi
     4 push .
     5 push toto
     6 init
# Remove files.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --size --count
./ (30 B) (6 files)
├── bla/ (8 B) (2 files)
│   ├── bli/ (4 B) (1 file)
│   │   └── plouf (4 B)
│   └── blo/ (4 B) (1 file)
│       └── plouf (4 B)
├── plif (4 B)
├── titi (6 B)
├── toto (9 B)
└── tutu (3 B)
$ cd /tmp/filou-test/clone
$ main.exe --no-color rm plif
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 26, file count: 5).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --size --count
./ (26 B) (5 files)
├── bla/ (8 B) (2 files)
│   ├── bli/ (4 B) (1 file)
│   │   └── plouf (4 B)
│   └── blo/ (4 B) (1 file)
│       └── plouf (4 B)
├++ plif (4 B)
├── titi (6 B)
├── toto (9 B)
└── tutu (3 B)
$ cd /tmp/filou-test/clone
$ main.exe --no-color rm titi toto tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 8, file count: 2).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --size --count
./ (8 B) (2 files)
├── bla/ (8 B) (2 files)
│   ├── bli/ (4 B) (1 file)
│   │   └── plouf (4 B)
│   └── blo/ (4 B) (1 file)
│       └── plouf (4 B)
├++ plif (4 B)
├++ titi (6 B)
├++ toto (9 B)
└++ tutu (3 B)
$ cd /tmp/filou-test/clone
$ main.exe --no-color rm bla/bli/plouf
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 4, file count: 1).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --size --count
./ (4 B) (1 file)
├── bla/ (4 B) (1 file)
│   ├++ bli/
│   └── blo/ (4 B) (1 file)
│       └── plouf (4 B)
├++ plif (4 B)
├++ titi (6 B)
├++ toto (9 B)
└++ tutu (3 B)
$ cd /tmp/filou-test/clone
$ main.exe --no-color rm bla/blo/plouf
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Repository is empty.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --size --count
./ (0 B) (0 files)
├++ bla/
├++ plif (4 B)
├++ titi (6 B)
├++ toto (9 B)
└++ tutu (3 B)
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color push
Pushed: titi
Pushed: bla/blo/plouf
Pushed: bla/bli/plouf
Pushed: toto
Pushed: tutu
Pushed: plif (duplicate of: bla/blo/plouf)
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --size --count
./ (30 B) (6 files)
├── bla/ (8 B) (2 files)
│   ├── bli/ (4 B) (1 file)
│   │   └── plouf (4 B)
│   └── blo/ (4 B) (1 file)
│       └── plouf (4 B)
├── plif (4 B)
├── titi (6 B)
├── toto (9 B)
└── tutu (3 B)
$ cd /tmp/filou-test/clone
$ main.exe --no-color rm plif bla/bli/plouf bla/blo/plouf
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 18, file count: 3).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --size --count
./ (18 B) (3 files)
├++ bla/
├++ plif (4 B)
├── titi (6 B)
├── toto (9 B)
└── tutu (3 B)
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color push
Already exists: titi
Pushed: bla/blo/plouf
Pushed: bla/bli/plouf
Already exists: toto
Already exists: tutu
Pushed: plif (duplicate of: bla/blo/plouf)
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 30, file count: 6).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --size --count
./ (30 B) (6 files)
├── bla/ (8 B) (2 files)
│   ├── bli/ (4 B) (1 file)
│   │   └── plouf (4 B)
│   └── blo/ (4 B) (1 file)
│       └── plouf (4 B)
├── plif (4 B)
├── titi (6 B)
├── toto (9 B)
└── tutu (3 B)
$ cd /tmp/filou-test/clone
$ main.exe --no-color rm plif bla/bli
Error:
  bla/bli is a directory
Exit code: 1
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 30, file count: 6).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --size --count
./ (30 B) (6 files)
├── bla/ (8 B) (2 files)
│   ├── bli/ (4 B) (1 file)
│   │   └── plouf (4 B)
│   └── blo/ (4 B) (1 file)
│       └── plouf (4 B)
├── plif (4 B)
├── titi (6 B)
├── toto (9 B)
└── tutu (3 B)
$ cd /tmp/filou-test/clone
$ main.exe --no-color rm -r plif bla/bli
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 22, file count: 4).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --size --count
./ (22 B) (4 files)
├── bla/ (4 B) (1 file)
│   ├++ bli/
│   └── blo/ (4 B) (1 file)
│       └── plouf (4 B)
├++ plif (4 B)
├── titi (6 B)
├── toto (9 B)
└── tutu (3 B)
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color push
Already exists: titi
Already exists: bla/blo/plouf
Pushed: bla/bli/plouf
Already exists: toto
Already exists: tutu
Pushed: plif (duplicate of: bla/blo/plouf)
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color rm -r bla
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 22, file count: 4).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --size --count
./ (22 B) (4 files)
├++ bla/
├── plif (4 B)
├── titi (6 B)
├── toto (9 B)
└── tutu (3 B)
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color push
Already exists: titi
Pushed: bla/blo/plouf (duplicate of: plif)
Pushed: bla/bli/plouf
Already exists: toto
Already exists: tutu
Already exists: plif
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color rm -r .
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Repository is empty.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --size --count
./ (0 B) (0 files)
├++ bla/
├++ plif (4 B)
├++ titi (6 B)
├++ toto (9 B)
└++ tutu (3 B)
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color push
Pushed: titi
Pushed: bla/blo/plouf
Pushed: bla/bli/plouf
Pushed: toto
Pushed: tutu
Pushed: plif (duplicate of: bla/blo/plouf)
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 push .
     1 rm -r .
     2 push .
     3 rm -r bla
     4 push .
     5 rm -r plif bla/bli
     6 push .
     7 rm plif bla/bli/plouf bla/blo/plouf
     8 push .
     9 rm bla/blo/plouf
    10 rm bla/bli/plouf
    11 rm titi toto tutu
    12 rm plif
    13 push .
    14 push bla/bli/plouf bla/blo/plouf
    15 push bla/bli/plouf bla/blo/plouf
    16 push tutu titi
    17 push .
    18 push toto
    19 init
$ cd /tmp/filou-test/clone
$ main.exe --no-color diff 13 1
-  bla/
-  plif
-  titi
-  toto
-  tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color diff
+  bla/
+  plif
+  titi
+  toto
+  tutu
# Try to push a directory while a file already exists with the same name.
$ rm toto
$ mkdir toto
$ echo 'this shouldn'\''t be here' > toto/wrong
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color push
Already exists: titi
Already exists: bla/blo/plouf
Already exists: bla/bli/plouf
Error:
  failed to push file: toto/wrong:
  parent directory already exists as a file: toto
Exit code: 1
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --duplicates
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
│           = /plif
├── plif
│   = /bla/blo/plouf
├── titi
├── toto?
└── tutu
$ rm toto/wrong
$ rmdir toto
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --duplicates
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
│           = /plif
├── plif
│   = /bla/blo/plouf
├── titi
├-- toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color pull
Already exists: bla/bli/plouf
Already exists: bla/blo/plouf
Already exists: plif
Already exists: titi
Pulled: toto
Already exists: tutu
$ cat toto
blablabla%
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 push .
     1 rm -r .
     2 push .
     3 rm -r bla
     4 push .
     5 rm -r plif bla/bli
     6 push .
     7 rm plif bla/bli/plouf bla/blo/plouf
     8 push .
     9 rm bla/blo/plouf
    10 rm bla/bli/plouf
    11 rm titi toto tutu
    12 rm plif
    13 push .
    14 push bla/bli/plouf bla/blo/plouf
    15 push bla/bli/plouf bla/blo/plouf
    16 push tutu titi
    17 push .
    18 push toto
    19 init
# Same, but with a deeper directory.
$ rm toto
$ mkdir toto
$ mkdir toto/tutu
$ echo 'this shouldn'\''t be here' > toto/tutu/wrong
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color push
Already exists: titi
Already exists: bla/blo/plouf
Already exists: bla/bli/plouf
Error:
  failed to push file: toto/tutu/wrong:
  parent directory already exists as a file: toto
Exit code: 1
$ rm toto/tutu/wrong
$ rmdir toto/tutu
$ rmdir toto
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color pull
Already exists: bla/bli/plouf
Already exists: bla/blo/plouf
Already exists: plif
Already exists: titi
Pulled: toto
Already exists: tutu
$ cat toto
blablabla%
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 push .
     1 rm -r .
     2 push .
     3 rm -r bla
     4 push .
     5 rm -r plif bla/bli
     6 push .
     7 rm plif bla/bli/plouf bla/blo/plouf
     8 push .
     9 rm bla/blo/plouf
    10 rm bla/bli/plouf
    11 rm titi toto tutu
    12 rm plif
    13 push .
    14 push bla/bli/plouf bla/blo/plouf
    15 push bla/bli/plouf bla/blo/plouf
    16 push tutu titi
    17 push .
    18 push toto
    19 init
# Same, but with a deeper directory but the first directory exists.
$ rm bla/bli/plouf
$ mkdir bla/bli/plouf
$ mkdir bla/bli/plouf/tutu
$ echo 'this shouldn'\''t be here' > bla/bli/plouf/tutu/wrong
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color push
Already exists: titi
Already exists: bla/blo/plouf
Error:
  failed to push file: bla/bli/plouf/tutu/wrong:
  parent directory already exists as a file: bla/bli/plouf
Exit code: 1
$ rm bla/bli/plouf/tutu/wrong
$ rmdir bla/bli/plouf/tutu
$ rmdir bla/bli/plouf
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color pull
Pulled: bla/bli/plouf
Already exists: bla/blo/plouf
Already exists: plif
Already exists: titi
Already exists: toto
Already exists: tutu
$ cat bla/bli/plouf
plaf%
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 push .
     1 rm -r .
     2 push .
     3 rm -r bla
     4 push .
     5 rm -r plif bla/bli
     6 push .
     7 rm plif bla/bli/plouf bla/blo/plouf
     8 push .
     9 rm bla/blo/plouf
    10 rm bla/bli/plouf
    11 rm titi toto tutu
    12 rm plif
    13 push .
    14 push bla/bli/plouf bla/blo/plouf
    15 push bla/bli/plouf bla/blo/plouf
    16 push tutu titi
    17 push .
    18 push toto
    19 init
# Try to push a file while a directory already exists for one of its parent.
$ rm bla/bli/plouf
$ rmdir bla/bli
$ echo 'I should be a directory' > bla/bli
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color push
Already exists: titi
Already exists: bla/blo/plouf
Error:
  failed to push file: bla/bli:
  file already exists as a directory
Exit code: 1
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli?
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
$ rm bla/bli
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color pull
Pulled: bla/bli/plouf
Already exists: bla/blo/plouf
Already exists: plif
Already exists: titi
Already exists: toto
Already exists: tutu
$ cat bla/bli/plouf
plaf%
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 push .
     1 rm -r .
     2 push .
     3 rm -r bla
     4 push .
     5 rm -r plif bla/bli
     6 push .
     7 rm plif bla/bli/plouf bla/blo/plouf
     8 push .
     9 rm bla/blo/plouf
    10 rm bla/bli/plouf
    11 rm titi toto tutu
    12 rm plif
    13 push .
    14 push bla/bli/plouf bla/blo/plouf
    15 push bla/bli/plouf bla/blo/plouf
    16 push tutu titi
    17 push .
    18 push toto
    19 init
# Test update.
$ cd /tmp/filou-test/clone
$ main.exe --no-color update
Computing reachable object set...
Copied 0 objects.
Clone is up-to-date.
$ cd /tmp/filou-test/clone
$ explore .filou/root
{
  redo = [];
  head = {
    command = "push .";
    root = { Non_empty = {
        root_dir = 007c9212426b740dce1ff2dc928dbc82db8511c4c0c1c5dd4d2f3e65b73be132;
        hash_index = 46831df2ca355f99357e3999efa937cad647f50b7d99478a610385a59923a700;
      } };
  };
  undo = [
    {
      command = "rm -r .";
      root = 31 (Empty);
    };
    {
      command = "push .";
      root = { Non_empty = {
          root_dir = 81adb4bfe41aa789a9a05dc3079c49925b515c60866ee6accd633bb35254f5fd;
          hash_index = 46831df2ca355f99357e3999efa937cad647f50b7d99478a610385a59923a700;
        } };
    };
    {
      command = "rm -r bla";
      root = { Non_empty = {
          root_dir = afa9eb8561076bab703034baa3109e6b6e8b71a2454c2732fd1f0e74396aa5eb;
          hash_index = 71c76ec04127dcc65e9fefe5c7dbd32757c075c1c092aaf949e8e91a33bc53d4;
        } };
    };
    {
      command = "push .";
      root = { Non_empty = {
          root_dir = 81adb4bfe41aa789a9a05dc3079c49925b515c60866ee6accd633bb35254f5fd;
          hash_index = 46831df2ca355f99357e3999efa937cad647f50b7d99478a610385a59923a700;
        } };
    };
    {
      command = "rm -r plif bla/bli";
      root = { Non_empty = {
          root_dir = 469eff2ee35d5d1b991fbe2d2bf279d1236ddc84405c207b6fcebc5a0c287e61;
          hash_index = 324b176748a4ef6286ac87621afa2f24c257cd7b23de15fb4a12b4d97005a750;
        } };
    };
    {
      command = "push .";
      root = { Non_empty = {
          root_dir = 81adb4bfe41aa789a9a05dc3079c49925b515c60866ee6accd633bb35254f5fd;
          hash_index = 46831df2ca355f99357e3999efa937cad647f50b7d99478a610385a59923a700;
        } };
    };
    {
      command = "rm plif bla/bli/plouf bla/blo/plouf";
      root = { Non_empty = {
          root_dir = 42c841776df006f78a7c940a01c56be7e68120afdf1cb4e13fdcc82f69c85ab3;
          hash_index = 566b95752137b8a34b3c8fe53e3b9b39d3f60fddc84236a997edc549f4887ab4;
        } };
    };
    {
      command = "push .";
      root = { Non_empty = {
          root_dir = 007c9212426b740dce1ff2dc928dbc82db8511c4c0c1c5dd4d2f3e65b73be132;
          hash_index = 46831df2ca355f99357e3999efa937cad647f50b7d99478a610385a59923a700;
        } };
    };
    {
      command = "rm bla/blo/plouf";
      root = 31 (Empty);
    };
    {
      command = "rm bla/bli/plouf";
      root = { Non_empty = {
          root_dir = 4b98dde17a215f75717d1960d313fc4b4ccac3c5a47eae7a0931a86ba750d1c1;
          hash_index = 74ea856db6e97f22875e26ce77885a4c77b4172fd85fa9414284e2dff572d72b;
        } };
    };
    {
      command = "rm titi toto tutu";
      root = { Non_empty = {
          root_dir = 41292f5a3b1b4b8277cba8848d00e65996af15cd7321b881529fee68b2d1f1f6;
          hash_index = 1506e1b1a63e72fc6106feac94ec2cbdd8725210fed592b768cb21ba84fbc250;
        } };
    };
    {
      command = "rm plif";
      root = { Non_empty = {
          root_dir = cefe8a18e9963d8120074c75c3ba057ea0458a049ced1bb6400472dea2a1a3ae;
          hash_index = 53ac1650860f9e1c68432b3273b4e8a4fa40c59e3ef2eea6d164827f8cc50815;
        } };
    };
    {
      command = "push .";
      root = { Non_empty = {
          root_dir = 81adb4bfe41aa789a9a05dc3079c49925b515c60866ee6accd633bb35254f5fd;
          hash_index = 46831df2ca355f99357e3999efa937cad647f50b7d99478a610385a59923a700;
        } };
    };
    {
      command = "push bla/bli/plouf bla/blo/plouf";
      root = { Non_empty = {
          root_dir = cefe8a18e9963d8120074c75c3ba057ea0458a049ced1bb6400472dea2a1a3ae;
          hash_index = 53ac1650860f9e1c68432b3273b4e8a4fa40c59e3ef2eea6d164827f8cc50815;
        } };
    };
    {
      command = "push bla/bli/plouf bla/blo/plouf";
      root = { Non_empty = {
          root_dir = cefe8a18e9963d8120074c75c3ba057ea0458a049ced1bb6400472dea2a1a3ae;
          hash_index = 53ac1650860f9e1c68432b3273b4e8a4fa40c59e3ef2eea6d164827f8cc50815;
        } };
    };
    {
      command = "push tutu titi";
      root = { Non_empty = {
          root_dir = 01511eeeeccce49cac2576bdabeb3e55176ed4ef40d07a21906b212ba3df8155;
          hash_index = 566b95752137b8a34b3c8fe53e3b9b39d3f60fddc84236a997edc549f4887ab4;
        } };
    };
    {
      command = "push .";
      root = { Non_empty = {
          root_dir = 6c7bb05f1e31d03e8305898fac7905ca0d1c5df9ade2685765fd9a5c803df2bb;
          hash_index = 44c405d44c55baa8a1bf6dc91240d52108a8c91dc4d987ab6f672103c01e9281;
        } };
    };
    {
      command = "push toto";
      root = { Non_empty = {
          root_dir = 6c7bb05f1e31d03e8305898fac7905ca0d1c5df9ade2685765fd9a5c803df2bb;
          hash_index = 44c405d44c55baa8a1bf6dc91240d52108a8c91dc4d987ab6f672103c01e9281;
        } };
    };
    {
      command = "init";
      root = 31 (Empty);
    };
  ];
}
$ rm .filou/00/7c/007c9212426b740dce1ff2dc928dbc82db8511c4c0c1c5dd4d2f3e65b73be132
$ cd /tmp/filou-test/clone
$ main.exe --no-color update
Computing reachable object set...
Copied 1 objects.
Clone is up-to-date.
$ cd /tmp/filou-test/clone
$ main.exe --no-color update
Computing reachable object set...
Copied 0 objects.
Clone is up-to-date.
$ rm .filou/00/7c/007c9212426b740dce1ff2dc928dbc82db8511c4c0c1c5dd4d2f3e65b73be132
$ rm .filou/46/83/46831df2ca355f99357e3999efa937cad647f50b7d99478a610385a59923a700
$ cd /tmp/filou-test/clone
$ main.exe --no-color update
Computing reachable object set...
Copied 2 objects.
Clone is up-to-date.
$ cd /tmp/filou-test/clone
$ main.exe --no-color update
Computing reachable object set...
Copied 0 objects.
Clone is up-to-date.
$ rm -r -f /tmp/filou-test/clone/.filou
$ main.exe --no-color clone /tmp/filou-test/main /tmp/filou-test/clone
Cloning /tmp/filou-test/main/ into: /tmp/filou-test/clone/
$ cd /tmp/filou-test/clone
$ tree -a -s -F
.
├── [       4096]  bla/
│   ├── [       4096]  bli/
│   │   └── [          4]  plouf
│   └── [       4096]  blo/
│       └── [          4]  plouf
├── [       4096]  .filou/
│   └── [         44]  config
├── [          4]  plif
├── [          6]  titi
├── [          9]  toto
└── [          3]  tutu

4 directories, 7 files
$ cd /tmp/filou-test/clone
$ main.exe --no-color update
Computing reachable object set...
Copied 33 objects.
Clone is up-to-date.
$ cd /tmp/filou-test/clone
$ tree -a -s -F
.
├── [       4096]  bla/
│   ├── [       4096]  bli/
│   │   └── [          4]  plouf
│   └── [       4096]  blo/
│       └── [          4]  plouf
├── [       4096]  .filou/
│   ├── [       4096]  00/
│   │   └── [       4096]  7c/
│   │       └── [        297]  007c9212426b740dce1ff2dc928dbc82db8511c4c0c1c5dd4d2f3e65b73be132
│   ├── [       4096]  01/
│   │   └── [       4096]  51/
│   │       └── [        183]  01511eeeeccce49cac2576bdabeb3e55176ed4ef40d07a21906b212ba3df8155
│   ├── [       4096]  07/
│   │   └── [       4096]  86/
│   │       └── [         87]  07866657909a05f003d5fe28188ba666491760f32045446be92098d6170ab33c
│   ├── [       4096]  13/
│   │   └── [       4096]  3e/
│   │       └── [        216]  133ef8a038b5757b940c44d5c79bad41a5577b415ba9b878ab4cb0a6689c583d
│   ├── [       4096]  15/
│   │   └── [       4096]  06/
│   │       └── [         55]  1506e1b1a63e72fc6106feac94ec2cbdd8725210fed592b768cb21ba84fbc250
│   ├── [       4096]  32/
│   │   └── [       4096]  4b/
│   │       └── [         55]  324b176748a4ef6286ac87621afa2f24c257cd7b23de15fb4a12b4d97005a750
│   ├── [       4096]  41/
│   │   └── [       4096]  29/
│   │       └── [         97]  41292f5a3b1b4b8277cba8848d00e65996af15cd7321b881529fee68b2d1f1f6
│   ├── [       4096]  42/
│   │   └── [       4096]  c8/
│   │       └── [        183]  42c841776df006f78a7c940a01c56be7e68120afdf1cb4e13fdcc82f69c85ab3
│   ├── [       4096]  44/
│   │   └── [       4096]  c4/
│   │       └── [         55]  44c405d44c55baa8a1bf6dc91240d52108a8c91dc4d987ab6f672103c01e9281
│   ├── [       4096]  46/
│   │   ├── [       4096]  83/
│   │   │   └── [         55]  46831df2ca355f99357e3999efa937cad647f50b7d99478a610385a59923a700
│   │   └── [       4096]  9e/
│   │       └── [        247]  469eff2ee35d5d1b991fbe2d2bf279d1236ddc84405c207b6fcebc5a0c287e61
│   ├── [       4096]  49/
│   │   └── [       4096]  d2/
│   │       └── [         88]  49d240084b137c6ccf354403e33fc03aadf7c3847cf7667e69846f154ad1b1ae
│   ├── [       4096]  4a/
│   │   └── [       4096]  8b/
│   │       └── [        146]  4a8bb7d8f6cfa4003d385366f04f6abacd3baf5858e63bcee288cebc3fbd7f62
│   ├── [       4096]  4b/
│   │   └── [       4096]  98/
│   │       └── [         96]  4b98dde17a215f75717d1960d313fc4b4ccac3c5a47eae7a0931a86ba750d1c1
│   ├── [       4096]  4d/
│   │   └── [       4096]  55/
│   │       └── [        228]  4d559a9f33a79562534cf0aa7d8e196321e5fbe8d35899df589b8f09f9ab1233
│   ├── [       4096]  53/
│   │   └── [       4096]  ac/
│   │       └── [         55]  53ac1650860f9e1c68432b3273b4e8a4fa40c59e3ef2eea6d164827f8cc50815
│   ├── [       4096]  56/
│   │   └── [       4096]  6b/
│   │       └── [         55]  566b95752137b8a34b3c8fe53e3b9b39d3f60fddc84236a997edc549f4887ab4
│   ├── [       4096]  6c/
│   │   └── [       4096]  7b/
│   │       └── [         87]  6c7bb05f1e31d03e8305898fac7905ca0d1c5df9ade2685765fd9a5c803df2bb
│   ├── [       4096]  71/
│   │   └── [       4096]  c7/
│   │       └── [         55]  71c76ec04127dcc65e9fefe5c7dbd32757c075c1c092aaf949e8e91a33bc53d4
│   ├── [       4096]  72/
│   │   └── [       4096]  a4/
│   │       └── [        169]  72a4850ec444542fe6d765961a9e0efcfe47ba5b94347e1236af1edce9d52e66
│   ├── [       4096]  74/
│   │   └── [       4096]  ea/
│   │       └── [         55]  74ea856db6e97f22875e26ce77885a4c77b4172fd85fa9414284e2dff572d72b
│   ├── [       4096]  81/
│   │   └── [       4096]  ad/
│   │       └── [        297]  81adb4bfe41aa789a9a05dc3079c49925b515c60866ee6accd633bb35254f5fd
│   ├── [       4096]  89/
│   │   └── [       4096]  a8/
│   │       └── [         88]  89a8d8fe98958200025991c7e91cf190915e217f5c2165b8d0215cbcd11dba56
│   ├── [       4096]  95/
│   │   └── [       4096]  c7/
│   │       └── [         75]  95c79518fe43b0eb0b36ca97dbd66f494da7392f49c0f18a92d902b1c345bd21
│   ├── [       4096]  97/
│   │   └── [       4096]  3f/
│   │       └── [         88]  973fadf617f27d59ab3cede722310e1a7b9c191ca188d58e65c9d955e3c6f901
│   ├── [       4096]  9b/
│   │   └── [       4096]  72/
│   │       └── [         96]  9b728004118565346eafe5b5fc882e60c0c0edba09d95b42a5556d6604bc82e6
│   ├── [       4096]  af/
│   │   └── [       4096]  a9/
│   │       └── [        231]  afa9eb8561076bab703034baa3109e6b6e8b71a2454c2732fd1f0e74396aa5eb
│   ├── [       4096]  ca/
│   │   └── [       4096]  e8/
│   │       └── [        146]  cae86e802cd0940a86f153c30ac718678539004f90c928cb58d1714519076156
│   ├── [       4096]  cb/
│   │   └── [       4096]  1d/
│   │       └── [         88]  cb1d78e51ff06c0d65cc17bf9cb86b39a1581aa64436fbd72c2f625607996d59
│   ├── [       4096]  cd/
│   │   └── [       4096]  7e/
│   │       └── [        289]  cd7e56f88600700621e6b81f55e70f59eef827e5a8ae80404fac0db0283e01a2
│   ├── [       4096]  ce/
│   │   └── [       4096]  fe/
│   │       └── [        248]  cefe8a18e9963d8120074c75c3ba057ea0458a049ced1bb6400472dea2a1a3ae
│   ├── [         44]  config
│   ├── [       4096]  ee/
│   │   └── [       4096]  2b/
│   │       └── [        296]  ee2b6c2a30a1adc33b57e20b82787ef9f2e659ef0a59a8333fd21f144982ed21
│   ├── [       4096]  fd/
│   │   └── [       4096]  8c/
│   │       └── [        146]  fd8c05b76fa28501d543c9a2a8db8a056879754993f597298d19f548ece8e53a
│   └── [       1758]  root
├── [          4]  plif
├── [          6]  titi
├── [          9]  toto
└── [          3]  tutu

69 directories, 41 files
$ cd /tmp/filou-test/clone
$ main.exe --no-color check --cache
Directory structure looks ok (total size: 30, file count: 6).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --cache
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 push .
     1 rm -r .
     2 push .
     3 rm -r bla
     4 push .
     5 rm -r plif bla/bli
     6 push .
     7 rm plif bla/bli/plouf bla/blo/plouf
     8 push .
     9 rm bla/blo/plouf
    10 rm bla/bli/plouf
    11 rm titi toto tutu
    12 rm plif
    13 push .
    14 push bla/bli/plouf bla/blo/plouf
    15 push bla/bli/plouf bla/blo/plouf
    16 push tutu titi
    17 push .
    18 push toto
    19 init
# Play with undo / redo.
$ cd /tmp/filou-test/clone
$ main.exe --no-color undo
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
    -1 push .
-->  0 rm -r .
     1 push .
     2 rm -r bla
     3 push .
     4 rm -r plif bla/bli
     5 push .
     6 rm plif bla/bli/plouf bla/blo/plouf
     7 push .
     8 rm bla/blo/plouf
     9 rm bla/bli/plouf
    10 rm titi toto tutu
    11 rm plif
    12 push .
    13 push bla/bli/plouf bla/blo/plouf
    14 push bla/bli/plouf bla/blo/plouf
    15 push tutu titi
    16 push .
    17 push toto
    18 init
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├++ bla/
├++ plif
├++ titi
├++ toto
└++ tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color undo
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
    -2 push .
    -1 rm -r .
-->  0 push .
     1 rm -r bla
     2 push .
     3 rm -r plif bla/bli
     4 push .
     5 rm plif bla/bli/plouf bla/blo/plouf
     6 push .
     7 rm bla/blo/plouf
     8 rm bla/bli/plouf
     9 rm titi toto tutu
    10 rm plif
    11 push .
    12 push bla/bli/plouf bla/blo/plouf
    13 push bla/bli/plouf bla/blo/plouf
    14 push tutu titi
    15 push .
    16 push toto
    17 init
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color undo 3
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
    -5 push .
    -4 rm -r .
    -3 push .
    -2 rm -r bla
    -1 push .
-->  0 rm -r plif bla/bli
     1 push .
     2 rm plif bla/bli/plouf bla/blo/plouf
     3 push .
     4 rm bla/blo/plouf
     5 rm bla/bli/plouf
     6 rm titi toto tutu
     7 rm plif
     8 push .
     9 push bla/bli/plouf bla/blo/plouf
    10 push bla/bli/plouf bla/blo/plouf
    11 push tutu titi
    12 push .
    13 push toto
    14 init
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├++ bli/
│   └── blo/
│       └── plouf
├++ plif
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color redo 4
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
    -1 push .
-->  0 rm -r .
     1 push .
     2 rm -r bla
     3 push .
     4 rm -r plif bla/bli
     5 push .
     6 rm plif bla/bli/plouf bla/blo/plouf
     7 push .
     8 rm bla/blo/plouf
     9 rm bla/bli/plouf
    10 rm titi toto tutu
    11 rm plif
    12 push .
    13 push bla/bli/plouf bla/blo/plouf
    14 push bla/bli/plouf bla/blo/plouf
    15 push tutu titi
    16 push .
    17 push toto
    18 init
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├++ bla/
├++ plif
├++ titi
├++ toto
└++ tutu
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color push bla
Pushed: bla/blo/plouf
Pushed: bla/bli/plouf
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 push bla
     1 rm -r .
     2 push .
     3 rm -r bla
     4 push .
     5 rm -r plif bla/bli
     6 push .
     7 rm plif bla/bli/plouf bla/blo/plouf
     8 push .
     9 rm bla/blo/plouf
    10 rm bla/bli/plouf
    11 rm titi toto tutu
    12 rm plif
    13 push .
    14 push bla/bli/plouf bla/blo/plouf
    15 push bla/bli/plouf bla/blo/plouf
    16 push tutu titi
    17 push .
    18 push toto
    19 init
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├++ plif
├++ titi
├++ toto
└++ tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color redo
Error:
  journal has less than 1 redo entries
Exit code: 1
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color push
Pushed: titi
Already exists: bla/blo/plouf
Already exists: bla/bli/plouf
Pushed: toto
Pushed: tutu
Pushed: plif (duplicate of: bla/blo/plouf)
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 push .
     1 push bla
     2 rm -r .
     3 push .
     4 rm -r bla
     5 push .
     6 rm -r plif bla/bli
     7 push .
     8 rm plif bla/bli/plouf bla/blo/plouf
     9 push .
    10 rm bla/blo/plouf
    11 rm bla/bli/plouf
    12 rm titi toto tutu
    13 rm plif
    14 push .
    15 push bla/bli/plouf bla/blo/plouf
    16 push bla/bli/plouf bla/blo/plouf
    17 push tutu titi
    18 push .
    19 push toto
    20 init
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
# Check what prune removes.
$ cd /tmp/filou-test/clone
$ main.exe --no-color prune --yes
Removed 56 objects totalling 7.55 kB.
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 30, file count: 6).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 push .
# Check that the main repository is not read with --cache.
$ mv /tmp/filou-test/main /tmp/filou-test/main.backup
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
Error:
  failed to fetch root:
  no such file: /tmp/filou-test/main/root
Exit code: 1
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --cache
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
$ mv /tmp/filou-test/main.backup /tmp/filou-test/main
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 push .
# Check that needed objects are copied in the clone cache when fetching.
$ rm -r -f /tmp/filou-test/clone/.filou
$ main.exe --no-color clone /tmp/filou-test/main /tmp/filou-test/clone
Cloning /tmp/filou-test/main/ into: /tmp/filou-test/clone/
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree bla/bli
└── bla/bli/
    └── plouf
$ cd /tmp/filou-test/clone
$ tree -a -s -F
.
├── [       4096]  bla/
│   ├── [       4096]  bli/
│   │   └── [          4]  plouf
│   └── [       4096]  blo/
│       └── [          4]  plouf
├── [       4096]  .filou/
│   ├── [       4096]  00/
│   │   └── [       4096]  7c/
│   │       └── [        297]  007c9212426b740dce1ff2dc928dbc82db8511c4c0c1c5dd4d2f3e65b73be132
│   ├── [       4096]  4a/
│   │   └── [       4096]  8b/
│   │       └── [        146]  4a8bb7d8f6cfa4003d385366f04f6abacd3baf5858e63bcee288cebc3fbd7f62
│   ├── [       4096]  89/
│   │   └── [       4096]  a8/
│   │       └── [         88]  89a8d8fe98958200025991c7e91cf190915e217f5c2165b8d0215cbcd11dba56
│   ├── [         44]  config
│   └── [        175]  root
├── [          4]  plif
├── [          6]  titi
├── [          9]  toto
└── [          3]  tutu

10 directories, 11 files
$ cd /tmp/filou-test/clone
$ main.exe --no-color update
Computing reachable object set...
Copied 3 objects.
Clone is up-to-date.
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 push .
# Test prune on the clone.
$ echo 'this is a truc' > bla/bli/truc
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color push bla/bli
Already exists: bla/bli/plouf
Pushed: bla/bli/truc
$ cd /tmp/filou-test/clone
$ main.exe --no-color prune --yes
Removed 10 objects totalling 1.76 kB.
# Clone: some objects should have been removed, no files should have been added:
- /tmp/filou-test/clone/.filou/00/7c/007c9212426b740dce1ff2dc928dbc82db8511c4c0c1c5dd4d2f3e65b73be132
- /tmp/filou-test/clone/.filou/46/83/46831df2ca355f99357e3999efa937cad647f50b7d99478a610385a59923a700
- /tmp/filou-test/clone/.filou/4a/8b/4a8bb7d8f6cfa4003d385366f04f6abacd3baf5858e63bcee288cebc3fbd7f62
- /tmp/filou-test/clone/.filou/89/a8/89a8d8fe98958200025991c7e91cf190915e217f5c2165b8d0215cbcd11dba56
- /tmp/filou-test/clone/.filou/ee/2b/ee2b6c2a30a1adc33b57e20b82787ef9f2e659ef0a59a8333fd21f144982ed21
# Main: should be the same diff:
- /tmp/filou-test/main/00/7c/007c9212426b740dce1ff2dc928dbc82db8511c4c0c1c5dd4d2f3e65b73be132
- /tmp/filou-test/main/46/83/46831df2ca355f99357e3999efa937cad647f50b7d99478a610385a59923a700
- /tmp/filou-test/main/4a/8b/4a8bb7d8f6cfa4003d385366f04f6abacd3baf5858e63bcee288cebc3fbd7f62
- /tmp/filou-test/main/89/a8/89a8d8fe98958200025991c7e91cf190915e217f5c2165b8d0215cbcd11dba56
- /tmp/filou-test/main/ee/2b/ee2b6c2a30a1adc33b57e20b82787ef9f2e659ef0a59a8333fd21f144982ed21
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 44, file count: 7).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   ├── plouf
│   │   └── truc
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
# Check that if some files are missing from the cache, they are not added.
$ cd /tmp/filou-test/clone
$ explore .filou/root
{
  redo = [];
  head = {
    command = "push bla/bli";
    root = { Non_empty = {
        root_dir = 39118085023aa55cbc027c086cd4797bb56f2e228b341369b2632d780d8df56a;
        hash_index = 6b4683747aceabd8059900b8e11dd214047bd9ebaa9bf73a77b5e7740e8f1e07;
      } };
  };
  undo = [];
}
$ rm .filou/39/11/39118085023aa55cbc027c086cd4797bb56f2e228b341369b2632d780d8df56a
$ rm .filou/6b/46/6b4683747aceabd8059900b8e11dd214047bd9ebaa9bf73a77b5e7740e8f1e07
$ cd /tmp/filou-test/clone
$ main.exe --no-color prune --yes
Removed 0 objects totalling 0 B.
# Clone: diff should be empty:
# Main: diff should also be empty:
# Updating should restore 2 objects:
$ cd /tmp/filou-test/clone
$ main.exe --no-color update
Computing reachable object set...
Copied 2 objects.
Clone is up-to-date.
# Check that if more objects exist in the clone than in the main, they are removed.
$ cd /tmp/filou-test/clone
$ mkdir .filou/01
$ mkdir .filou/01/23
$ echo 'dummy object' > .filou/01/23/01234567fb95b9dd5d20056bc24150b79354852e0f0a28ce578af2b3d2f4b859
$ cd /tmp/filou-test/clone
$ main.exe --no-color prune --yes
Removed 1 objects totalling 12 B.
# Clone: diff should show one removed file:
- /tmp/filou-test/clone/.filou/01/23/01234567fb95b9dd5d20056bc24150b79354852e0f0a28ce578af2b3d2f4b859
# Main: diff should be empty:
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 push bla/bli
# Push a file, remove it and re-push it from another clone.
$ rm -r -f /tmp/filou-test/main
$ rm -r -f /tmp/filou-test/clone
$ main.exe --no-color init /tmp/filou-test/main
$ main.exe --no-color clone /tmp/filou-test/main /tmp/filou-test/clone
Cloning /tmp/filou-test/main/ into: /tmp/filou-test/clone/
$ cd /tmp/filou-test/clone
$ echo 'contents of bla first version' > bla
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color push
Pushed: bla
$ main.exe --no-color clone /tmp/filou-test/main /tmp/filou-test/clone2
Cloning /tmp/filou-test/main/ into: /tmp/filou-test/clone2/
$ cd /tmp/filou-test/clone2
$ cd /tmp/filou-test/clone2
$ main.exe --no-color rm bla
$ echo 'contents of bla second version' > bla
$ cd /tmp/filou-test/clone2
$ main.exe -v --no-color push
Pushed: bla
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
└≠≠ bla
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 30, file count: 1).
All files are available.
Hash index is consistent with the directory structure.
# Test the show command with large recursivity.
$ cd /tmp/filou-test/clone
$ main.exe --no-color show -r 1000
{
  redo = [];
  head = {
    command = "push .";
    root = { Non_empty = {
        root_dir = 9b16d0e119eb143dafb4c90c042945a8879e7588c3de6d437836124f665aee0f =
        [ { File = {
              name = "bla";
              hash = 20580e3e285f773043630dc3218e4d40339c4e353093c680d54136b5fffcddfa =
              "";
              size = 30;
            } } ];
        hash_index = 712236a0e9b77d07c859b9a19cb4362b0ff843d3d757111de364d370c1eab2fc =
        { Leaf = b9b9a5da6f39564e5649d3d21cc363b100f7f1862ba5f8d197f814752e03c540 =
          [ {
              hash = 20580e3e285f773043630dc3218e4d40339c4e353093c680d54136b5fffcddfa =
              "";
              paths = [ [ "bla" ] ];
            } ] };
      } };
  };
  undo = [
    {
      command = "rm bla";
      root = 31 (Empty);
    };
    {
      command = "push .";
      root = { Non_empty = {
          root_dir = c6926b83b3b7dc996fd820a34432a8ef4d02bf11ec58f63ed9fdb3a10e6b2770 =
          [ { File = {
                name = "bla";
                hash = 20d3840f86a24fa8883fa9be2c7f9018850bd1855993a300fd6d5572a25bc568 =
                "";
                size = 29;
              } } ];
          hash_index = cd4318d2beb1da2b1096e80eb5170e4fb420a5a6d2f2608ccb5e6483c8938270 =
          { Leaf = 8284451c46d60597646aad29e28515336418c999ddb583bfdd3da8860530ddb2 =
            [ {
                hash = 20d3840f86a24fa8883fa9be2c7f9018850bd1855993a300fd6d5572a25bc568 =
                "";
                paths = [ [ "bla" ] ];
              } ] };
        } };
    };
    {
      command = "init";
      root = 31 (Empty);
    };
  ];
}
