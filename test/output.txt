# Initialize a main repository and a clone.
$ main.exe --no-color init /tmp/filou-test/main
$ main.exe --no-color clone /tmp/filou-test/main /tmp/filou-test/clone
$ cd /tmp/filou-test/clone
$ explore .filou/config
{ main = "/tmp/filou-test/main/" }
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Repository is empty.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 init
# Add a file.
$ cd /tmp/filou-test/clone
$ echo blablabla > toto
$ cd /tmp/filou-test/clone
$ main.exe --no-color push toto
Pushed: toto
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 9, file count: 1).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
└── toto
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 push toto
     1 init
# Add the file again.
$ cd /tmp/filou-test/clone
$ main.exe --no-color push
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 9, file count: 1).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
└── toto
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 push .
     1 push toto
     2 init
# Add several files.
$ cd /tmp/filou-test/clone
$ echo blu > tutu
$ echo blibli > titi
$ cd /tmp/filou-test/clone
$ main.exe --no-color push tutu titi
Pushed: tutu
Pushed: titi
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 18, file count: 3).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 push tutu titi
     1 push .
     2 push toto
     3 init
# Add files in subdirectories.
$ cd /tmp/filou-test/clone
$ mkdir bla
$ mkdir bla/bli
$ echo plaf > bla/bli/plouf
$ mkdir bla/blo
$ echo plif > bla/blo/plouf
$ cd /tmp/filou-test/clone
$ main.exe --dry-run --no-color push bla/bli/plouf bla/blo/plouf
Pushed: bla/bli/plouf
Pushed: bla/blo/plouf
$ cd /tmp/filou-test/clone
$ main.exe --no-color push bla/bli/plouf bla/blo/plouf
Pushed: bla/bli/plouf
Pushed: bla/blo/plouf
$ cd /tmp/filou-test/clone
$ main.exe --no-color push bla/bli/plouf bla/blo/plouf
$ cd /tmp/filou-test/clone
$ main.exe --no-color check --cache
Directory structure looks ok (total size: 26, file count: 5).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 push bla/bli/plouf bla/blo/plouf
     1 push bla/bli/plouf bla/blo/plouf
     2 push tutu titi
     3 push .
     4 push toto
     5 init
# Test tree.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree bla
└── bla/
    ├── bli/
    │   └── plouf
    └── blo/
        └── plouf
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree bla/blo
└── bla/blo/
    └── plouf
$ cd /tmp/filou-test/clone/bla/bli
$ main.exe --no-color tree
└── bla/bli/
    └── plouf
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree bla/blo/blu/ble
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree bla/blo/plouf/ble
Error:
  failed to get path type for bla/blo/plouf/ble in /tmp/filou-test/clone/:
  failed to read file: /tmp/filou-test/clone/bla/blo/plouf/ble:
  Not a directory
Exit code: 1
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree bla/blo/plouf
└── bla/blo/plouf
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --depth 0
./
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --depth 1
./
├── bla/
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --depth 2
./
├── bla/
│   ├── bli/
│   └── blo/
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --depth 3
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --depth 0 bla
└── bla/
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --depth 1 bla
└── bla/
    ├── bli/
    └── blo/
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --depth 2 bla
└── bla/
    ├── bli/
    │   └── plouf
    └── blo/
        └── plouf
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --only-dirs
./
└── bla/
    ├── bli/
    └── blo/
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --depth 1 --only-dirs
./
└── bla/
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --size
./ (26 B)
├── bla/ (8 B)
│   ├── bli/ (4 B)
│   │   └── plouf (4 B)
│   └── blo/ (4 B)
│       └── plouf (4 B)
├── titi (6 B)
├── toto (9 B)
└── tutu (3 B)
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --count
./ (5 files)
├── bla/ (2 files)
│   ├── bli/ (1 file)
│   │   └── plouf
│   └── blo/ (1 file)
│       └── plouf
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --size --count
./ (26 B) (5 files)
├── bla/ (8 B) (2 files)
│   ├── bli/ (4 B) (1 file)
│   │   └── plouf (4 B)
│   └── blo/ (4 B) (1 file)
│       └── plouf (4 B)
├── titi (6 B)
├── toto (9 B)
└── tutu (3 B)
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 push bla/bli/plouf bla/blo/plouf
     1 push bla/bli/plouf bla/blo/plouf
     2 push tutu titi
     3 push .
     4 push toto
     5 init
# Test duplicates.
$ echo plif > plif
$ cd /tmp/filou-test/clone
$ main.exe -v --dry-run --no-color push
Already exists: titi
Already exists: bla/blo/plouf
Already exists: bla/bli/plouf
Already exists: toto
Already exists: tutu
Pushed: plif (duplicate of: bla/blo/plouf)
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --duplicates
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├++ plif
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color push
Already exists: titi
Already exists: bla/blo/plouf
Already exists: bla/bli/plouf
Already exists: toto
Already exists: tutu
Pushed: plif (duplicate of: bla/blo/plouf)
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --duplicates
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
│           = /plif
├── plif
│   = /bla/blo/plouf
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 push .
     1 push bla/bli/plouf bla/blo/plouf
     2 push bla/bli/plouf bla/blo/plouf
     3 push tutu titi
     4 push .
     5 push toto
     6 init
# Try to pull files.
$ rm titi
$ rm tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├-- titi
├── toto
└-- tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color pull titi
Pulled: titi
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└-- tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color pull tutu
Pulled: tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
$ rm titi
$ rm tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├-- titi
├── toto
└-- tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color pull titi tutu
Pulled: titi
Pulled: tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
$ rm tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└-- tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color pull titi tutu
Pulled: tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
$ rm bla/bli/plouf
$ rmdir bla/bli
$ rm plif
$ rm toto
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├-- bli/
│   │   └-- plouf
│   └── blo/
│       └── plouf
├-- plif
├── titi
├-- toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color pull bla/bli
Pulled: bla/bli/plouf
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├-- plif
├── titi
├-- toto
└── tutu
$ rm bla/bli/plouf
$ rmdir bla/bli
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├-- bli/
│   │   └-- plouf
│   └── blo/
│       └── plouf
├-- plif
├── titi
├-- toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color pull bla
Pulled: bla/bli/plouf
Already exists: bla/blo/plouf
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├-- plif
├── titi
├-- toto
└── tutu
$ rm bla/bli/plouf
$ rmdir bla/bli
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├-- bli/
│   │   └-- plouf
│   └── blo/
│       └── plouf
├-- plif
├── titi
├-- toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color pull
Pulled: bla/bli/plouf
Already exists: bla/blo/plouf
Pulled: plif
Already exists: titi
Pulled: toto
Already exists: tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 30, file count: 6).
All files are available.
Hash index is consistent with the directory structure.
$ cat bla/bli/plouf
plaf%
$ cat bla/blo/plouf
plif%
$ cat plif
plif%
$ cat titi
blibli%
$ cat toto
blablabla%
$ cat tutu
blu%
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 push .
     1 push bla/bli/plouf bla/blo/plouf
     2 push bla/bli/plouf bla/blo/plouf
     3 push tutu titi
     4 push .
     5 push toto
     6 init
# Remove files.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --size --count
./ (30 B) (6 files)
├── bla/ (8 B) (2 files)
│   ├── bli/ (4 B) (1 file)
│   │   └── plouf (4 B)
│   └── blo/ (4 B) (1 file)
│       └── plouf (4 B)
├── plif (4 B)
├── titi (6 B)
├── toto (9 B)
└── tutu (3 B)
$ cd /tmp/filou-test/clone
$ main.exe --no-color rm plif
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 26, file count: 5).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --size --count
./ (26 B) (5 files)
├── bla/ (8 B) (2 files)
│   ├── bli/ (4 B) (1 file)
│   │   └── plouf (4 B)
│   └── blo/ (4 B) (1 file)
│       └── plouf (4 B)
├++ plif (4 B)
├── titi (6 B)
├── toto (9 B)
└── tutu (3 B)
$ cd /tmp/filou-test/clone
$ main.exe --no-color rm titi toto tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 8, file count: 2).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --size --count
./ (8 B) (2 files)
├── bla/ (8 B) (2 files)
│   ├── bli/ (4 B) (1 file)
│   │   └── plouf (4 B)
│   └── blo/ (4 B) (1 file)
│       └── plouf (4 B)
├++ plif (4 B)
├++ titi (6 B)
├++ toto (9 B)
└++ tutu (3 B)
$ cd /tmp/filou-test/clone
$ main.exe --no-color rm bla/bli/plouf
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 4, file count: 1).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --size --count
./ (4 B) (1 file)
├── bla/ (4 B) (1 file)
│   ├++ bli/
│   └── blo/ (4 B) (1 file)
│       └── plouf (4 B)
├++ plif (4 B)
├++ titi (6 B)
├++ toto (9 B)
└++ tutu (3 B)
$ cd /tmp/filou-test/clone
$ main.exe --no-color rm bla/blo/plouf
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Repository is empty.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --size --count
./ (0 B) (0 files)
├++ bla/
├++ plif (4 B)
├++ titi (6 B)
├++ toto (9 B)
└++ tutu (3 B)
$ cd /tmp/filou-test/clone
$ main.exe --no-color push
Pushed: titi
Pushed: bla/blo/plouf
Pushed: bla/bli/plouf
Pushed: toto
Pushed: tutu
Pushed: plif (duplicate of: bla/blo/plouf)
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --size --count
./ (30 B) (6 files)
├── bla/ (8 B) (2 files)
│   ├── bli/ (4 B) (1 file)
│   │   └── plouf (4 B)
│   └── blo/ (4 B) (1 file)
│       └── plouf (4 B)
├── plif (4 B)
├── titi (6 B)
├── toto (9 B)
└── tutu (3 B)
$ cd /tmp/filou-test/clone
$ main.exe --no-color rm plif bla/bli/plouf bla/blo/plouf
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 18, file count: 3).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --size --count
./ (18 B) (3 files)
├++ bla/
├++ plif (4 B)
├── titi (6 B)
├── toto (9 B)
└── tutu (3 B)
$ cd /tmp/filou-test/clone
$ main.exe --no-color push
Pushed: bla/blo/plouf
Pushed: bla/bli/plouf
Pushed: plif (duplicate of: bla/blo/plouf)
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 30, file count: 6).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --size --count
./ (30 B) (6 files)
├── bla/ (8 B) (2 files)
│   ├── bli/ (4 B) (1 file)
│   │   └── plouf (4 B)
│   └── blo/ (4 B) (1 file)
│       └── plouf (4 B)
├── plif (4 B)
├── titi (6 B)
├── toto (9 B)
└── tutu (3 B)
$ cd /tmp/filou-test/clone
$ main.exe --no-color rm plif bla/bli
Error:
  bla/bli is a directory, use --recursive (or -r) to remove it and its contents
Exit code: 1
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 30, file count: 6).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --size --count
./ (30 B) (6 files)
├── bla/ (8 B) (2 files)
│   ├── bli/ (4 B) (1 file)
│   │   └── plouf (4 B)
│   └── blo/ (4 B) (1 file)
│       └── plouf (4 B)
├── plif (4 B)
├── titi (6 B)
├── toto (9 B)
└── tutu (3 B)
$ cd /tmp/filou-test/clone
$ main.exe --no-color rm -r plif bla/bli
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 22, file count: 4).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --size --count
./ (22 B) (4 files)
├── bla/ (4 B) (1 file)
│   ├++ bli/
│   └── blo/ (4 B) (1 file)
│       └── plouf (4 B)
├++ plif (4 B)
├── titi (6 B)
├── toto (9 B)
└── tutu (3 B)
$ cd /tmp/filou-test/clone
$ main.exe --no-color push
Pushed: bla/bli/plouf
Pushed: plif (duplicate of: bla/blo/plouf)
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color rm -r bla
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 22, file count: 4).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --size --count
./ (22 B) (4 files)
├++ bla/
├── plif (4 B)
├── titi (6 B)
├── toto (9 B)
└── tutu (3 B)
$ cd /tmp/filou-test/clone
$ main.exe --no-color push
Pushed: bla/blo/plouf (duplicate of: plif)
Pushed: bla/bli/plouf
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color rm -r .
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Repository is empty.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --size --count
./ (0 B) (0 files)
├++ bla/
├++ plif (4 B)
├++ titi (6 B)
├++ toto (9 B)
└++ tutu (3 B)
$ cd /tmp/filou-test/clone
$ main.exe --no-color push
Pushed: titi
Pushed: bla/blo/plouf
Pushed: bla/bli/plouf
Pushed: toto
Pushed: tutu
Pushed: plif (duplicate of: bla/blo/plouf)
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 push .
     1 rm -r .
     2 push .
     3 rm -r bla
     4 push .
     5 rm -r plif bla/bli
     6 push .
     7 rm plif bla/bli/plouf bla/blo/plouf
     8 push .
     9 rm bla/blo/plouf
    10 rm bla/bli/plouf
    11 rm titi toto tutu
    12 rm plif
    13 push .
    14 push bla/bli/plouf bla/blo/plouf
    15 push bla/bli/plouf bla/blo/plouf
    16 push tutu titi
    17 push .
    18 push toto
    19 init
# Try to push a directory while a file already exists with the same name.
$ rm toto
$ mkdir toto
$ echo 'this shouldn'\''t be here' > toto/wrong
$ cd /tmp/filou-test/clone
$ main.exe --no-color push
Error:
  failed to push file: toto/wrong:
  parent directory already exists as a file: toto
Exit code: 1
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --duplicates
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
│           = /plif
├── plif
│   = /bla/blo/plouf
├── titi
├── toto?
└── tutu
$ rm toto/wrong
$ rmdir toto
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --duplicates
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
│           = /plif
├── plif
│   = /bla/blo/plouf
├── titi
├-- toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color pull
Pulled: toto
$ cat toto
blablabla%
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 push .
     1 rm -r .
     2 push .
     3 rm -r bla
     4 push .
     5 rm -r plif bla/bli
     6 push .
     7 rm plif bla/bli/plouf bla/blo/plouf
     8 push .
     9 rm bla/blo/plouf
    10 rm bla/bli/plouf
    11 rm titi toto tutu
    12 rm plif
    13 push .
    14 push bla/bli/plouf bla/blo/plouf
    15 push bla/bli/plouf bla/blo/plouf
    16 push tutu titi
    17 push .
    18 push toto
    19 init
# Same, but with a deeper directory.
$ rm toto
$ mkdir toto
$ mkdir toto/tutu
$ echo 'this shouldn'\''t be here' > toto/tutu/wrong
$ cd /tmp/filou-test/clone
$ main.exe --no-color push
Error:
  failed to push file: toto/tutu/wrong:
  parent directory already exists as a file: toto
Exit code: 1
$ rm toto/tutu/wrong
$ rmdir toto/tutu
$ rmdir toto
$ cd /tmp/filou-test/clone
$ main.exe --no-color pull
Pulled: toto
$ cat toto
blablabla%
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 push .
     1 rm -r .
     2 push .
     3 rm -r bla
     4 push .
     5 rm -r plif bla/bli
     6 push .
     7 rm plif bla/bli/plouf bla/blo/plouf
     8 push .
     9 rm bla/blo/plouf
    10 rm bla/bli/plouf
    11 rm titi toto tutu
    12 rm plif
    13 push .
    14 push bla/bli/plouf bla/blo/plouf
    15 push bla/bli/plouf bla/blo/plouf
    16 push tutu titi
    17 push .
    18 push toto
    19 init
# Same, but with a deeper directory but the first directory exists.
$ rm bla/bli/plouf
$ mkdir bla/bli/plouf
$ mkdir bla/bli/plouf/tutu
$ echo 'this shouldn'\''t be here' > bla/bli/plouf/tutu/wrong
$ cd /tmp/filou-test/clone
$ main.exe --no-color push
Error:
  failed to push file: bla/bli/plouf/tutu/wrong:
  parent directory already exists as a file: bla/bli/plouf
Exit code: 1
$ rm bla/bli/plouf/tutu/wrong
$ rmdir bla/bli/plouf/tutu
$ rmdir bla/bli/plouf
$ cd /tmp/filou-test/clone
$ main.exe --no-color pull
Pulled: bla/bli/plouf
$ cat bla/bli/plouf
plaf%
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 push .
     1 rm -r .
     2 push .
     3 rm -r bla
     4 push .
     5 rm -r plif bla/bli
     6 push .
     7 rm plif bla/bli/plouf bla/blo/plouf
     8 push .
     9 rm bla/blo/plouf
    10 rm bla/bli/plouf
    11 rm titi toto tutu
    12 rm plif
    13 push .
    14 push bla/bli/plouf bla/blo/plouf
    15 push bla/bli/plouf bla/blo/plouf
    16 push tutu titi
    17 push .
    18 push toto
    19 init
# Try to push a file while a directory already exists for one of its parent.
$ rm bla/bli/plouf
$ rmdir bla/bli
$ echo 'I should be a directory' > bla/bli
$ cd /tmp/filou-test/clone
$ main.exe --no-color push
Error:
  failed to push file: bla/bli:
  file already exists as a directory
Exit code: 1
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli?
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
$ rm bla/bli
$ cd /tmp/filou-test/clone
$ main.exe --no-color pull
Pulled: bla/bli/plouf
$ cat bla/bli/plouf
plaf%
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 push .
     1 rm -r .
     2 push .
     3 rm -r bla
     4 push .
     5 rm -r plif bla/bli
     6 push .
     7 rm plif bla/bli/plouf bla/blo/plouf
     8 push .
     9 rm bla/blo/plouf
    10 rm bla/bli/plouf
    11 rm titi toto tutu
    12 rm plif
    13 push .
    14 push bla/bli/plouf bla/blo/plouf
    15 push bla/bli/plouf bla/blo/plouf
    16 push tutu titi
    17 push .
    18 push toto
    19 init
# Test update.
$ cd /tmp/filou-test/clone
$ main.exe --no-color update
Computing reachable object set...
Copied 0 objects.
Clone is up-to-date.
$ cd /tmp/filou-test/clone
$ explore .filou/root
{
  redo = [];
  head = {
    command = "push .";
    root = { Non_empty = {
        root_dir = 068078c68210224ad43efdbeed879fbfdfbbb69e072b4b9655b09beb75f4c92e;
        hash_index = d10fb33ec821d25bc7ba85a23553a73e1f4d936a7eaf5632c559485c32f50512;
      } };
  };
  undo = [
    {
      command = "rm -r .";
      root = 9 (Empty);
    };
    {
      command = "push .";
      root = { Non_empty = {
          root_dir = 27cc78904fd5e81733461c1651e77fe0ad7180e795ffea92fde201f47e707e8c;
          hash_index = d10fb33ec821d25bc7ba85a23553a73e1f4d936a7eaf5632c559485c32f50512;
        } };
    };
    {
      command = "rm -r bla";
      root = { Non_empty = {
          root_dir = 8194c70f763a5f8497b14f79456921787ca160217d3a9801b1a4be79827a6174;
          hash_index = 3ca48d0bf144049015756906d10485591618a746785746457cba19553801fafe;
        } };
    };
    {
      command = "push .";
      root = { Non_empty = {
          root_dir = 27cc78904fd5e81733461c1651e77fe0ad7180e795ffea92fde201f47e707e8c;
          hash_index = d10fb33ec821d25bc7ba85a23553a73e1f4d936a7eaf5632c559485c32f50512;
        } };
    };
    {
      command = "rm -r plif bla/bli";
      root = { Non_empty = {
          root_dir = b6b38025637f15d64e491874c4c130f5d75bd2f0e47078c4cbaa489262695bb3;
          hash_index = c2bc343694a6a0d694c60e01406ae576828edb35e49d07305a2f7f9717182513;
        } };
    };
    {
      command = "push .";
      root = { Non_empty = {
          root_dir = 27cc78904fd5e81733461c1651e77fe0ad7180e795ffea92fde201f47e707e8c;
          hash_index = d10fb33ec821d25bc7ba85a23553a73e1f4d936a7eaf5632c559485c32f50512;
        } };
    };
    {
      command = "rm plif bla/bli/plouf bla/blo/plouf";
      root = { Non_empty = {
          root_dir = 62a3eda45147624b821cbc6697de53e336c31dbe036af7a569f164b8013ef5de;
          hash_index = 236befb99816f89edd9c8d11f1b69c4870e4c4f09df182e42919cea1953e2352;
        } };
    };
    {
      command = "push .";
      root = { Non_empty = {
          root_dir = 068078c68210224ad43efdbeed879fbfdfbbb69e072b4b9655b09beb75f4c92e;
          hash_index = d10fb33ec821d25bc7ba85a23553a73e1f4d936a7eaf5632c559485c32f50512;
        } };
    };
    {
      command = "rm bla/blo/plouf";
      root = 9 (Empty);
    };
    {
      command = "rm bla/bli/plouf";
      root = { Non_empty = {
          root_dir = 11e5752a0a278874faeac447627845298e8ad2ce71eea5f61473fa25e393ca52;
          hash_index = c25afcbe7e510ce5f4017396ced64b11aa2d0f5696f69e38789919f6224d6d61;
        } };
    };
    {
      command = "rm titi toto tutu";
      root = { Non_empty = {
          root_dir = a767b4826058f0bf8be6aa9379edc699f66d136d7cbd3519c73d6faeb1c6dab2;
          hash_index = 705c6497915e5f151a803c052573101b96f60bf48a02c182238b45cdb87a8a15;
        } };
    };
    {
      command = "rm plif";
      root = { Non_empty = {
          root_dir = 49bd1d51b3e1a13092e82f07ec131da75c4469c8311cd5f6f48d5882537addb4;
          hash_index = 0d49079a858f9f9825b587e5ea881317fbc4a44768046c879d33840f12b980b7;
        } };
    };
    {
      command = "push .";
      root = { Non_empty = {
          root_dir = 27cc78904fd5e81733461c1651e77fe0ad7180e795ffea92fde201f47e707e8c;
          hash_index = d10fb33ec821d25bc7ba85a23553a73e1f4d936a7eaf5632c559485c32f50512;
        } };
    };
    {
      command = "push bla/bli/plouf bla/blo/plouf";
      root = { Non_empty = {
          root_dir = 49bd1d51b3e1a13092e82f07ec131da75c4469c8311cd5f6f48d5882537addb4;
          hash_index = 0d49079a858f9f9825b587e5ea881317fbc4a44768046c879d33840f12b980b7;
        } };
    };
    {
      command = "push bla/bli/plouf bla/blo/plouf";
      root = { Non_empty = {
          root_dir = 49bd1d51b3e1a13092e82f07ec131da75c4469c8311cd5f6f48d5882537addb4;
          hash_index = 0d49079a858f9f9825b587e5ea881317fbc4a44768046c879d33840f12b980b7;
        } };
    };
    {
      command = "push tutu titi";
      root = { Non_empty = {
          root_dir = cf6a509d77b87a0c07ec52ecd173a7f0e86090024ed836fd362a0049277fb4c3;
          hash_index = 236befb99816f89edd9c8d11f1b69c4870e4c4f09df182e42919cea1953e2352;
        } };
    };
    {
      command = "push .";
      root = { Non_empty = {
          root_dir = 273a2c0344280fa98b9204a3a9417437a5595ded5fba4f1f4e2c3aa94d6092c2;
          hash_index = 98fff22dfbe16e5159a0c23765a4742614da80948d58c8de784e8535910f381b;
        } };
    };
    {
      command = "push toto";
      root = { Non_empty = {
          root_dir = 273a2c0344280fa98b9204a3a9417437a5595ded5fba4f1f4e2c3aa94d6092c2;
          hash_index = 98fff22dfbe16e5159a0c23765a4742614da80948d58c8de784e8535910f381b;
        } };
    };
    {
      command = "init";
      root = 9 (Empty);
    };
  ];
}
$ rm .filou/06/80/068078c68210224ad43efdbeed879fbfdfbbb69e072b4b9655b09beb75f4c92e
$ cd /tmp/filou-test/clone
$ main.exe --no-color update
Computing reachable object set...
Copied 1 objects.
Clone is up-to-date.
$ cd /tmp/filou-test/clone
$ main.exe --no-color update
Computing reachable object set...
Copied 0 objects.
Clone is up-to-date.
$ rm .filou/06/80/068078c68210224ad43efdbeed879fbfdfbbb69e072b4b9655b09beb75f4c92e
$ rm .filou/d1/0f/d10fb33ec821d25bc7ba85a23553a73e1f4d936a7eaf5632c559485c32f50512
$ cd /tmp/filou-test/clone
$ main.exe --no-color update
Computing reachable object set...
Copied 2 objects.
Clone is up-to-date.
$ cd /tmp/filou-test/clone
$ main.exe --no-color update
Computing reachable object set...
Copied 0 objects.
Clone is up-to-date.
$ rm -r -f /tmp/filou-test/clone/.filou
$ main.exe --no-color clone /tmp/filou-test/main /tmp/filou-test/clone
$ cd /tmp/filou-test/clone
$ tree -a -s -F
.
├── [       4096]  bla/
│   ├── [       4096]  bli/
│   │   └── [          4]  plouf
│   └── [       4096]  blo/
│       └── [          4]  plouf
├── [       4096]  .filou/
│   └── [         44]  config
├── [          4]  plif
├── [          6]  titi
├── [          9]  toto
└── [          3]  tutu

4 directories, 7 files
$ cd /tmp/filou-test/clone
$ main.exe --no-color update
Computing reachable object set...
Copied 40 objects.
Clone is up-to-date.
$ cd /tmp/filou-test/clone
$ tree -a -s -F
.
├── [       4096]  bla/
│   ├── [       4096]  bli/
│   │   └── [          4]  plouf
│   └── [       4096]  blo/
│       └── [          4]  plouf
├── [       4096]  .filou/
│   ├── [       4096]  06/
│   │   └── [       4096]  80/
│   │       └── [        297]  068078c68210224ad43efdbeed879fbfdfbbb69e072b4b9655b09beb75f4c92e
│   ├── [       4096]  0d/
│   │   └── [       4096]  49/
│   │       └── [        226]  0d49079a858f9f9825b587e5ea881317fbc4a44768046c879d33840f12b980b7
│   ├── [       4096]  11/
│   │   └── [       4096]  e5/
│   │       └── [         96]  11e5752a0a278874faeac447627845298e8ad2ce71eea5f61473fa25e393ca52
│   ├── [       4096]  16/
│   │   └── [       4096]  f9/
│   │       └── [         66]  16f9bc83ff1d4b5d0e2eb8103a96306a56d7eb51d4ea4897a607c73f34a013f5
│   ├── [       4096]  23/
│   │   └── [       4096]  6b/
│   │       └── [        146]  236befb99816f89edd9c8d11f1b69c4870e4c4f09df182e42919cea1953e2352
│   ├── [       4096]  27/
│   │   ├── [       4096]  3a/
│   │   │   └── [         87]  273a2c0344280fa98b9204a3a9417437a5595ded5fba4f1f4e2c3aa94d6092c2
│   │   └── [       4096]  cc/
│   │       └── [        297]  27cc78904fd5e81733461c1651e77fe0ad7180e795ffea92fde201f47e707e8c
│   ├── [       4096]  2c/
│   │   └── [       4096]  fc/
│   │       └── [         75]  2cfc473aa14551ae622808a0d0358fd3be8b0aad379a0d7e18ae717c39159afb
│   ├── [       4096]  3c/
│   │   └── [       4096]  a4/
│   │       └── [        186]  3ca48d0bf144049015756906d10485591618a746785746457cba19553801fafe
│   ├── [       4096]  49/
│   │   └── [       4096]  bd/
│   │       └── [        248]  49bd1d51b3e1a13092e82f07ec131da75c4469c8311cd5f6f48d5882537addb4
│   ├── [       4096]  4c/
│   │   └── [       4096]  01/
│   │       └── [         66]  4c01e5bd112c84edf07488c55d62586f32397a09cf1b430aa7c6a283830d55a1
│   ├── [       4096]  5b/
│   │   └── [       4096]  10/
│   │       └── [         75]  5b10d7558d2a2a4c40e18d69350b4c743144266b965a7d20647a8aab170458d4
│   ├── [       4096]  5c/
│   │   └── [       4096]  2a/
│   │       └── [         87]  5c2aff9de86bde2bad58107f51dc6be486abb7b3b75ba16ff14d91acea23bfd3
│   ├── [       4096]  62/
│   │   └── [       4096]  a3/
│   │       └── [        183]  62a3eda45147624b821cbc6697de53e336c31dbe036af7a569f164b8013ef5de
│   ├── [       4096]  70/
│   │   ├── [       4096]  5c/
│   │   │   └── [        106]  705c6497915e5f151a803c052573101b96f60bf48a02c182238b45cdb87a8a15
│   │   └── [       4096]  bd/
│   │       └── [         66]  70bd48f2939d090451730dcc6f46cbe992a72a2e104b7ba0ed25abb01d11a6b2
│   ├── [       4096]  72/
│   │   └── [       4096]  cd/
│   │       └── [         88]  72cd1d24b6a35f588ab4a63b5f1e47ee96afba7e311dbc36bf0ca931e0fa4803
│   ├── [       4096]  78/
│   │   └── [       4096]  45/
│   │       └── [         66]  7845fdcb260234f5ac916785b7fcd1eddd6f505f26d01229abe1fc9f6bf118da
│   ├── [       4096]  81/
│   │   └── [       4096]  94/
│   │       └── [        231]  8194c70f763a5f8497b14f79456921787ca160217d3a9801b1a4be79827a6174
│   ├── [       4096]  84/
│   │   └── [       4096]  51/
│   │       └── [         94]  8451f677ac647686b69d25b226beecaf4b46ee0cb8d16b5141e4631a754c0ff1
│   ├── [       4096]  92/
│   │   └── [       4096]  88/
│   │       └── [         96]  928890a1105035f6d844c8ccc79e020e5dd4d7493cbc452d1d85eab459c0daca
│   ├── [       4096]  96/
│   │   └── [       4096]  d9/
│   │       └── [         75]  96d92ff59a2f2bf8e0d2f18647c9a934b2319656b9f0f2a85f30935b0a8551c5
│   ├── [       4096]  98/
│   │   └── [       4096]  ff/
│   │       └── [         66]  98fff22dfbe16e5159a0c23765a4742614da80948d58c8de784e8535910f381b
│   ├── [       4096]  a6/
│   │   └── [       4096]  e7/
│   │       └── [         66]  a6e7d0f2cde27696d38a96e560caeb57ce260da86331d3d3d2593cf264952dd2
│   ├── [       4096]  a7/
│   │   └── [       4096]  67/
│   │       └── [         97]  a767b4826058f0bf8be6aa9379edc699f66d136d7cbd3519c73d6faeb1c6dab2
│   ├── [       4096]  a8/
│   │   └── [       4096]  a8/
│   │       └── [         96]  a8a84606c2510c5e5376bdb9dd9ea20e2049323710907b9f2383f97feaf8cfd2
│   ├── [       4096]  b6/
│   │   └── [       4096]  b3/
│   │       └── [        247]  b6b38025637f15d64e491874c4c130f5d75bd2f0e47078c4cbaa489262695bb3
│   ├── [       4096]  be/
│   │   └── [       4096]  bb/
│   │       └── [        146]  bebb697660abb9c885806cf8d616eb3e74a25c45addc2fa3713400f9d0b90e35
│   ├── [       4096]  c2/
│   │   ├── [       4096]  5a/
│   │   │   └── [         66]  c25afcbe7e510ce5f4017396ced64b11aa2d0f5696f69e38789919f6224d6d61
│   │   └── [       4096]  bc/
│   │       └── [        186]  c2bc343694a6a0d694c60e01406ae576828edb35e49d07305a2f7f9717182513
│   ├── [       4096]  c4/
│   │   ├── [       4096]  69/
│   │   │   └── [         87]  c46957ea6037751759d7b5be20b78f9b480d832918d91aab7b87fe4d5c3b29d7
│   │   └── [       4096]  ba/
│   │       └── [         75]  c4bade70daca8d2550981dac069120ff13b3ee30675b736d65379dceab7ac9cc
│   ├── [       4096]  c6/
│   │   └── [       4096]  7c/
│   │       └── [         66]  c67c6a1ca9141e67fd1cce2e4515d5e30d4fcb6e74a4ea9ca38ca2a0a89a8f47
│   ├── [       4096]  cb/
│   │   └── [       4096]  5d/
│   │       └── [         88]  cb5d0b1bc8e8f4a4476aea724e8f631e0087d4d4b4049a81012720cd95995398
│   ├── [       4096]  cc/
│   │   └── [       4096]  43/
│   │       └── [         66]  cc43bd93ba4edf6d931cd7c4a4ed85102268bb94b6aa5d5532da5a6f0b9d5e4c
│   ├── [       4096]  cf/
│   │   └── [       4096]  6a/
│   │       └── [        183]  cf6a509d77b87a0c07ec52ecd173a7f0e86090024ed836fd362a0049277fb4c3
│   ├── [         44]  config
│   ├── [       4096]  d1/
│   │   └── [       4096]  0f/
│   │       └── [        226]  d10fb33ec821d25bc7ba85a23553a73e1f4d936a7eaf5632c559485c32f50512
│   ├── [       4096]  ea/
│   │   └── [       4096]  b9/
│   │       └── [         88]  eab996c9de3a26dcd8f0adc5c39ea609d7fc65ec2b81cd7cff17d519861b9188
│   ├── [       4096]  f4/
│   │   └── [       4096]  07/
│   │       └── [         88]  f407dc503d4e0848bc247b6c2d6f5b7b872f003beb68724a21678353ff79ee73
│   ├── [       4096]  f9/
│   │   └── [       4096]  82/
│   │       └── [        146]  f9823d28ca18fe5b06e9cc4ce317796b78c23d39881ea2ea902d363d39baa0cc
│   └── [       1758]  root
├── [          4]  plif
├── [          6]  titi
├── [          9]  toto
└── [          3]  tutu

80 directories, 48 files
$ cd /tmp/filou-test/clone
$ main.exe --no-color check --cache
Directory structure looks ok (total size: 30, file count: 6).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --cache
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 push .
     1 rm -r .
     2 push .
     3 rm -r bla
     4 push .
     5 rm -r plif bla/bli
     6 push .
     7 rm plif bla/bli/plouf bla/blo/plouf
     8 push .
     9 rm bla/blo/plouf
    10 rm bla/bli/plouf
    11 rm titi toto tutu
    12 rm plif
    13 push .
    14 push bla/bli/plouf bla/blo/plouf
    15 push bla/bli/plouf bla/blo/plouf
    16 push tutu titi
    17 push .
    18 push toto
    19 init
# Play with undo / redo.
$ cd /tmp/filou-test/clone
$ main.exe --no-color undo
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
    -1 push .
-->  0 rm -r .
     1 push .
     2 rm -r bla
     3 push .
     4 rm -r plif bla/bli
     5 push .
     6 rm plif bla/bli/plouf bla/blo/plouf
     7 push .
     8 rm bla/blo/plouf
     9 rm bla/bli/plouf
    10 rm titi toto tutu
    11 rm plif
    12 push .
    13 push bla/bli/plouf bla/blo/plouf
    14 push bla/bli/plouf bla/blo/plouf
    15 push tutu titi
    16 push .
    17 push toto
    18 init
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├++ bla/
├++ plif
├++ titi
├++ toto
└++ tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color undo
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
    -2 push .
    -1 rm -r .
-->  0 push .
     1 rm -r bla
     2 push .
     3 rm -r plif bla/bli
     4 push .
     5 rm plif bla/bli/plouf bla/blo/plouf
     6 push .
     7 rm bla/blo/plouf
     8 rm bla/bli/plouf
     9 rm titi toto tutu
    10 rm plif
    11 push .
    12 push bla/bli/plouf bla/blo/plouf
    13 push bla/bli/plouf bla/blo/plouf
    14 push tutu titi
    15 push .
    16 push toto
    17 init
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color undo 3
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
    -5 push .
    -4 rm -r .
    -3 push .
    -2 rm -r bla
    -1 push .
-->  0 rm -r plif bla/bli
     1 push .
     2 rm plif bla/bli/plouf bla/blo/plouf
     3 push .
     4 rm bla/blo/plouf
     5 rm bla/bli/plouf
     6 rm titi toto tutu
     7 rm plif
     8 push .
     9 push bla/bli/plouf bla/blo/plouf
    10 push bla/bli/plouf bla/blo/plouf
    11 push tutu titi
    12 push .
    13 push toto
    14 init
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├++ bli/
│   └── blo/
│       └── plouf
├++ plif
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color redo 4
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
    -1 push .
-->  0 rm -r .
     1 push .
     2 rm -r bla
     3 push .
     4 rm -r plif bla/bli
     5 push .
     6 rm plif bla/bli/plouf bla/blo/plouf
     7 push .
     8 rm bla/blo/plouf
     9 rm bla/bli/plouf
    10 rm titi toto tutu
    11 rm plif
    12 push .
    13 push bla/bli/plouf bla/blo/plouf
    14 push bla/bli/plouf bla/blo/plouf
    15 push tutu titi
    16 push .
    17 push toto
    18 init
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├++ bla/
├++ plif
├++ titi
├++ toto
└++ tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color push bla
Pushed: bla/blo/plouf
Pushed: bla/bli/plouf
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 push bla
     1 rm -r .
     2 push .
     3 rm -r bla
     4 push .
     5 rm -r plif bla/bli
     6 push .
     7 rm plif bla/bli/plouf bla/blo/plouf
     8 push .
     9 rm bla/blo/plouf
    10 rm bla/bli/plouf
    11 rm titi toto tutu
    12 rm plif
    13 push .
    14 push bla/bli/plouf bla/blo/plouf
    15 push bla/bli/plouf bla/blo/plouf
    16 push tutu titi
    17 push .
    18 push toto
    19 init
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├++ plif
├++ titi
├++ toto
└++ tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color redo
Error:
  journal has less than 1 redo entries
Exit code: 1
$ cd /tmp/filou-test/clone
$ main.exe --no-color push
Pushed: titi
Pushed: toto
Pushed: tutu
Pushed: plif (duplicate of: bla/blo/plouf)
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 push .
     1 push bla
     2 rm -r .
     3 push .
     4 rm -r bla
     5 push .
     6 rm -r plif bla/bli
     7 push .
     8 rm plif bla/bli/plouf bla/blo/plouf
     9 push .
    10 rm bla/blo/plouf
    11 rm bla/bli/plouf
    12 rm titi toto tutu
    13 rm plif
    14 push .
    15 push bla/bli/plouf bla/blo/plouf
    16 push bla/bli/plouf bla/blo/plouf
    17 push tutu titi
    18 push .
    19 push toto
    20 init
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
# Check what prune removes.
$ cd /tmp/filou-test/clone
$ main.exe --no-color prune --yes
Removed 52 objects totalling 7.11 kB.
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 30, file count: 6).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 push .
# Check that the main repository is not read with --cache.
$ mv /tmp/filou-test/main /tmp/filou-test/main.backup
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
Error:
  failed to fetch root:
  no such file: /tmp/filou-test/main/root
Exit code: 1
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --cache
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
$ mv /tmp/filou-test/main.backup /tmp/filou-test/main
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 push .
# Check that needed objects are copied in the clone cache when fetching.
$ rm -r -f /tmp/filou-test/clone/.filou
$ main.exe --no-color clone /tmp/filou-test/main /tmp/filou-test/clone
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree bla/bli
└── bla/bli/
    └── plouf
$ cd /tmp/filou-test/clone
$ tree -a -s -F
.
├── [       4096]  bla/
│   ├── [       4096]  bli/
│   │   └── [          4]  plouf
│   └── [       4096]  blo/
│       └── [          4]  plouf
├── [       4096]  .filou/
│   ├── [       4096]  06/
│   │   └── [       4096]  80/
│   │       └── [        297]  068078c68210224ad43efdbeed879fbfdfbbb69e072b4b9655b09beb75f4c92e
│   ├── [       4096]  cb/
│   │   └── [       4096]  5d/
│   │       └── [         88]  cb5d0b1bc8e8f4a4476aea724e8f631e0087d4d4b4049a81012720cd95995398
│   ├── [         44]  config
│   ├── [       4096]  f9/
│   │   └── [       4096]  82/
│   │       └── [        146]  f9823d28ca18fe5b06e9cc4ce317796b78c23d39881ea2ea902d363d39baa0cc
│   └── [        175]  root
├── [          4]  plif
├── [          6]  titi
├── [          9]  toto
└── [          3]  tutu

10 directories, 11 files
$ cd /tmp/filou-test/clone
$ main.exe --no-color update
Computing reachable object set...
Copied 12 objects.
Clone is up-to-date.
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 push .
# Test prune on the clone.
$ echo 'this is a truc' > bla/bli/truc
$ cd /tmp/filou-test/clone
$ main.exe --no-color push bla/bli
Pushed: bla/bli/truc
$ cd /tmp/filou-test/clone
$ main.exe --no-color prune --yes
Removed 8 objects totalling 1.51 kB.
# Clone: some objects should have been removed, no files should have been added:
- /tmp/filou-test/clone/.filou/06/80/068078c68210224ad43efdbeed879fbfdfbbb69e072b4b9655b09beb75f4c92e
- /tmp/filou-test/clone/.filou/cb/5d/cb5d0b1bc8e8f4a4476aea724e8f631e0087d4d4b4049a81012720cd95995398
- /tmp/filou-test/clone/.filou/d1/0f/d10fb33ec821d25bc7ba85a23553a73e1f4d936a7eaf5632c559485c32f50512
- /tmp/filou-test/clone/.filou/f9/82/f9823d28ca18fe5b06e9cc4ce317796b78c23d39881ea2ea902d363d39baa0cc
# Main: should be the same diff:
- /tmp/filou-test/main/06/80/068078c68210224ad43efdbeed879fbfdfbbb69e072b4b9655b09beb75f4c92e
- /tmp/filou-test/main/cb/5d/cb5d0b1bc8e8f4a4476aea724e8f631e0087d4d4b4049a81012720cd95995398
- /tmp/filou-test/main/d1/0f/d10fb33ec821d25bc7ba85a23553a73e1f4d936a7eaf5632c559485c32f50512
- /tmp/filou-test/main/f9/82/f9823d28ca18fe5b06e9cc4ce317796b78c23d39881ea2ea902d363d39baa0cc
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 44, file count: 7).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   ├── plouf
│   │   └── truc
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
# Check that if some files are missing from the cache, they are not added.
$ cd /tmp/filou-test/clone
$ rm .filou/ea/34/ea34ea54fb95b9dd5d20056bc24150b79354852e0f0a28ce578af2b3d2f4b859
$ rm .filou/a6/e7/a6e7d0f2cde27696d38a96e560caeb57ce260da86331d3d3d2593cf264952dd2
$ cd /tmp/filou-test/clone
$ main.exe --no-color prune --yes
Removed 0 objects totalling 0 B.
# Clone: diff should be empty:
# Main: diff should also be empty:
# Updating should restore 2 objects:
$ cd /tmp/filou-test/clone
$ main.exe --no-color update
Computing reachable object set...
Copied 2 objects.
Clone is up-to-date.
# Check that if more objects exist in the clone than in the main, they are removed.
$ cd /tmp/filou-test/clone
$ mkdir .filou/01/23
$ echo 'dummy object' > .filou/01/23/01234567fb95b9dd5d20056bc24150b79354852e0f0a28ce578af2b3d2f4b859
$ cd /tmp/filou-test/clone
$ main.exe --no-color prune --yes
Removed 1 objects totalling 12 B.
# Clone: diff should show one removed file:
- /tmp/filou-test/clone/.filou/01/23/01234567fb95b9dd5d20056bc24150b79354852e0f0a28ce578af2b3d2f4b859
# Main: diff should be empty:
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 push bla/bli
