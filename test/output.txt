# Initialize a main repository and a clone.
$ main.exe --no-color init /tmp/filou-test/main
$ main.exe --no-color clone /tmp/filou-test/main /tmp/filou-test/clone
$ cd /tmp/filou-test/clone
$ explore .filou/config
{ main = "/tmp/filou-test/main/" }
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Repository is empty.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 init
# Add a file.
$ cd /tmp/filou-test/clone
$ echo blablabla > toto
$ cd /tmp/filou-test/clone
$ main.exe --no-color push toto
Pushed: toto
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 9, file count: 1).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
└── toto
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 push toto
     1 init
$ cd /tmp/filou-test/clone
$ main.exe --no-color diff
+  toto
# Add the file again.
$ cd /tmp/filou-test/clone
$ main.exe --no-color push
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 9, file count: 1).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
└── toto
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 push .
     1 push toto
     2 init
$ cd /tmp/filou-test/clone
$ main.exe --no-color diff
# Add several files.
$ cd /tmp/filou-test/clone
$ echo blu > tutu
$ echo blibli > titi
$ cd /tmp/filou-test/clone
$ main.exe --no-color push tutu titi
Pushed: tutu
Pushed: titi
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 18, file count: 3).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 push tutu titi
     1 push .
     2 push toto
     3 init
$ cd /tmp/filou-test/clone
$ main.exe --no-color diff
+  titi
+  tutu
# Add files in subdirectories.
$ cd /tmp/filou-test/clone
$ mkdir bla
$ mkdir bla/bli
$ echo plaf > bla/bli/plouf
$ mkdir bla/blo
$ echo plif > bla/blo/plouf
$ cd /tmp/filou-test/clone
$ main.exe --dry-run --no-color push bla/bli/plouf bla/blo/plouf
Pushed: bla/bli/plouf
Pushed: bla/blo/plouf
$ cd /tmp/filou-test/clone
$ main.exe --no-color push bla/bli/plouf bla/blo/plouf
Pushed: bla/bli/plouf
Pushed: bla/blo/plouf
$ cd /tmp/filou-test/clone
$ main.exe --no-color push bla/bli/plouf bla/blo/plouf
$ cd /tmp/filou-test/clone
$ main.exe --no-color check --cache
Directory structure looks ok (total size: 26, file count: 5).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 push bla/bli/plouf bla/blo/plouf
     1 push bla/bli/plouf bla/blo/plouf
     2 push tutu titi
     3 push .
     4 push toto
     5 init
$ cd /tmp/filou-test/clone
$ main.exe --no-color diff 3
+  bla/
+  titi
+  tutu
# Test tree.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree bla
└── bla/
    ├── bli/
    │   └── plouf
    └── blo/
        └── plouf
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree bla/blo
└── bla/blo/
    └── plouf
$ cd /tmp/filou-test/clone/bla/bli
$ main.exe --no-color tree
└── bla/bli/
    └── plouf
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree bla/blo/blu/ble
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree bla/blo/plouf/ble
Error:
  failed to get path type for bla/blo/plouf/ble in /tmp/filou-test/clone/:
  failed to read file: /tmp/filou-test/clone/bla/blo/plouf/ble:
  Not a directory
Exit code: 1
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree bla/blo/plouf
└── bla/blo/plouf
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --depth 0
./
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --depth 1
./
├── bla/
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --depth 2
./
├── bla/
│   ├── bli/
│   └── blo/
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --depth 3
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --depth 0 bla
└── bla/
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --depth 1 bla
└── bla/
    ├── bli/
    └── blo/
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --depth 2 bla
└── bla/
    ├── bli/
    │   └── plouf
    └── blo/
        └── plouf
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --only-dirs
./
└── bla/
    ├── bli/
    └── blo/
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --depth 1 --only-dirs
./
└── bla/
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --size
./ (26 B)
├── bla/ (8 B)
│   ├── bli/ (4 B)
│   │   └── plouf (4 B)
│   └── blo/ (4 B)
│       └── plouf (4 B)
├── titi (6 B)
├── toto (9 B)
└── tutu (3 B)
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --count
./ (5 files)
├── bla/ (2 files)
│   ├── bli/ (1 file)
│   │   └── plouf
│   └── blo/ (1 file)
│       └── plouf
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --size --count
./ (26 B) (5 files)
├── bla/ (8 B) (2 files)
│   ├── bli/ (4 B) (1 file)
│   │   └── plouf (4 B)
│   └── blo/ (4 B) (1 file)
│       └── plouf (4 B)
├── titi (6 B)
├── toto (9 B)
└── tutu (3 B)
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 push bla/bli/plouf bla/blo/plouf
     1 push bla/bli/plouf bla/blo/plouf
     2 push tutu titi
     3 push .
     4 push toto
     5 init
# Test duplicates.
$ echo plif > plif
$ cd /tmp/filou-test/clone
$ main.exe -v --dry-run --no-color push
Already exists: titi
Already exists: bla/blo/plouf
Already exists: bla/bli/plouf
Already exists: toto
Already exists: tutu
Pushed: plif (duplicate of: bla/blo/plouf)
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --duplicates
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├++ plif
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color push
Already exists: titi
Already exists: bla/blo/plouf
Already exists: bla/bli/plouf
Already exists: toto
Already exists: tutu
Pushed: plif (duplicate of: bla/blo/plouf)
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --duplicates
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
│           = /plif
├── plif
│   = /bla/blo/plouf
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 push .
     1 push bla/bli/plouf bla/blo/plouf
     2 push bla/bli/plouf bla/blo/plouf
     3 push tutu titi
     4 push .
     5 push toto
     6 init
$ cd /tmp/filou-test/clone
$ main.exe --no-color diff
+  plif
# Try to pull files.
$ rm titi
$ rm tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├-- titi
├── toto
└-- tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color pull titi
Pulled: titi
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└-- tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color pull tutu
Pulled: tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
$ rm titi
$ rm tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├-- titi
├── toto
└-- tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color pull titi tutu
Pulled: titi
Pulled: tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
$ rm tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└-- tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color pull titi tutu
Pulled: tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
$ rm bla/bli/plouf
$ rmdir bla/bli
$ rm plif
$ rm toto
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├-- bli/
│   │   └-- plouf
│   └── blo/
│       └── plouf
├-- plif
├── titi
├-- toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color pull bla/bli
Pulled: bla/bli/plouf
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├-- plif
├── titi
├-- toto
└── tutu
$ rm bla/bli/plouf
$ rmdir bla/bli
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├-- bli/
│   │   └-- plouf
│   └── blo/
│       └── plouf
├-- plif
├── titi
├-- toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color pull bla
Pulled: bla/bli/plouf
Already exists: bla/blo/plouf
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├-- plif
├── titi
├-- toto
└── tutu
$ rm bla/bli/plouf
$ rmdir bla/bli
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├-- bli/
│   │   └-- plouf
│   └── blo/
│       └── plouf
├-- plif
├── titi
├-- toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe -v --no-color pull
Pulled: bla/bli/plouf
Already exists: bla/blo/plouf
Pulled: plif
Already exists: titi
Pulled: toto
Already exists: tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 30, file count: 6).
All files are available.
Hash index is consistent with the directory structure.
$ cat bla/bli/plouf
plaf%
$ cat bla/blo/plouf
plif%
$ cat plif
plif%
$ cat titi
blibli%
$ cat toto
blablabla%
$ cat tutu
blu%
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 push .
     1 push bla/bli/plouf bla/blo/plouf
     2 push bla/bli/plouf bla/blo/plouf
     3 push tutu titi
     4 push .
     5 push toto
     6 init
# Remove files.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --size --count
./ (30 B) (6 files)
├── bla/ (8 B) (2 files)
│   ├── bli/ (4 B) (1 file)
│   │   └── plouf (4 B)
│   └── blo/ (4 B) (1 file)
│       └── plouf (4 B)
├── plif (4 B)
├── titi (6 B)
├── toto (9 B)
└── tutu (3 B)
$ cd /tmp/filou-test/clone
$ main.exe --no-color rm plif
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 26, file count: 5).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --size --count
./ (26 B) (5 files)
├── bla/ (8 B) (2 files)
│   ├── bli/ (4 B) (1 file)
│   │   └── plouf (4 B)
│   └── blo/ (4 B) (1 file)
│       └── plouf (4 B)
├++ plif (4 B)
├── titi (6 B)
├── toto (9 B)
└── tutu (3 B)
$ cd /tmp/filou-test/clone
$ main.exe --no-color rm titi toto tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 8, file count: 2).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --size --count
./ (8 B) (2 files)
├── bla/ (8 B) (2 files)
│   ├── bli/ (4 B) (1 file)
│   │   └── plouf (4 B)
│   └── blo/ (4 B) (1 file)
│       └── plouf (4 B)
├++ plif (4 B)
├++ titi (6 B)
├++ toto (9 B)
└++ tutu (3 B)
$ cd /tmp/filou-test/clone
$ main.exe --no-color rm bla/bli/plouf
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 4, file count: 1).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --size --count
./ (4 B) (1 file)
├── bla/ (4 B) (1 file)
│   ├++ bli/
│   └── blo/ (4 B) (1 file)
│       └── plouf (4 B)
├++ plif (4 B)
├++ titi (6 B)
├++ toto (9 B)
└++ tutu (3 B)
$ cd /tmp/filou-test/clone
$ main.exe --no-color rm bla/blo/plouf
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Repository is empty.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --size --count
./ (0 B) (0 files)
├++ bla/
├++ plif (4 B)
├++ titi (6 B)
├++ toto (9 B)
└++ tutu (3 B)
$ cd /tmp/filou-test/clone
$ main.exe --no-color push
Pushed: titi
Pushed: bla/blo/plouf
Pushed: bla/bli/plouf
Pushed: toto
Pushed: tutu
Pushed: plif (duplicate of: bla/blo/plouf)
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --size --count
./ (30 B) (6 files)
├── bla/ (8 B) (2 files)
│   ├── bli/ (4 B) (1 file)
│   │   └── plouf (4 B)
│   └── blo/ (4 B) (1 file)
│       └── plouf (4 B)
├── plif (4 B)
├── titi (6 B)
├── toto (9 B)
└── tutu (3 B)
$ cd /tmp/filou-test/clone
$ main.exe --no-color rm plif bla/bli/plouf bla/blo/plouf
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 18, file count: 3).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --size --count
./ (18 B) (3 files)
├++ bla/
├++ plif (4 B)
├── titi (6 B)
├── toto (9 B)
└── tutu (3 B)
$ cd /tmp/filou-test/clone
$ main.exe --no-color push
Pushed: bla/blo/plouf
Pushed: bla/bli/plouf
Pushed: plif (duplicate of: bla/blo/plouf)
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 30, file count: 6).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --size --count
./ (30 B) (6 files)
├── bla/ (8 B) (2 files)
│   ├── bli/ (4 B) (1 file)
│   │   └── plouf (4 B)
│   └── blo/ (4 B) (1 file)
│       └── plouf (4 B)
├── plif (4 B)
├── titi (6 B)
├── toto (9 B)
└── tutu (3 B)
$ cd /tmp/filou-test/clone
$ main.exe --no-color rm plif bla/bli
Error:
  bla/bli is a directory, use --recursive (or -r) to remove it and its contents
Exit code: 1
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 30, file count: 6).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --size --count
./ (30 B) (6 files)
├── bla/ (8 B) (2 files)
│   ├── bli/ (4 B) (1 file)
│   │   └── plouf (4 B)
│   └── blo/ (4 B) (1 file)
│       └── plouf (4 B)
├── plif (4 B)
├── titi (6 B)
├── toto (9 B)
└── tutu (3 B)
$ cd /tmp/filou-test/clone
$ main.exe --no-color rm -r plif bla/bli
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 22, file count: 4).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --size --count
./ (22 B) (4 files)
├── bla/ (4 B) (1 file)
│   ├++ bli/
│   └── blo/ (4 B) (1 file)
│       └── plouf (4 B)
├++ plif (4 B)
├── titi (6 B)
├── toto (9 B)
└── tutu (3 B)
$ cd /tmp/filou-test/clone
$ main.exe --no-color push
Pushed: bla/bli/plouf
Pushed: plif (duplicate of: bla/blo/plouf)
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color rm -r bla
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 22, file count: 4).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --size --count
./ (22 B) (4 files)
├++ bla/
├── plif (4 B)
├── titi (6 B)
├── toto (9 B)
└── tutu (3 B)
$ cd /tmp/filou-test/clone
$ main.exe --no-color push
Pushed: bla/blo/plouf (duplicate of: plif)
Pushed: bla/bli/plouf
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color rm -r .
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Repository is empty.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --size --count
./ (0 B) (0 files)
├++ bla/
├++ plif (4 B)
├++ titi (6 B)
├++ toto (9 B)
└++ tutu (3 B)
$ cd /tmp/filou-test/clone
$ main.exe --no-color push
Pushed: titi
Pushed: bla/blo/plouf
Pushed: bla/bli/plouf
Pushed: toto
Pushed: tutu
Pushed: plif (duplicate of: bla/blo/plouf)
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 push .
     1 rm -r .
     2 push .
     3 rm -r bla
     4 push .
     5 rm -r plif bla/bli
     6 push .
     7 rm plif bla/bli/plouf bla/blo/plouf
     8 push .
     9 rm bla/blo/plouf
    10 rm bla/bli/plouf
    11 rm titi toto tutu
    12 rm plif
    13 push .
    14 push bla/bli/plouf bla/blo/plouf
    15 push bla/bli/plouf bla/blo/plouf
    16 push tutu titi
    17 push .
    18 push toto
    19 init
$ cd /tmp/filou-test/clone
$ main.exe --no-color diff 13 1
-  bla/
-  plif
-  titi
-  toto
-  tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color diff
+  bla/
+  plif
+  titi
+  toto
+  tutu
# Try to push a directory while a file already exists with the same name.
$ rm toto
$ mkdir toto
$ echo 'this shouldn'\''t be here' > toto/wrong
$ cd /tmp/filou-test/clone
$ main.exe --no-color push
Error:
  failed to push file: toto/wrong:
  parent directory already exists as a file: toto
Exit code: 1
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --duplicates
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
│           = /plif
├── plif
│   = /bla/blo/plouf
├── titi
├── toto?
└── tutu
$ rm toto/wrong
$ rmdir toto
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --duplicates
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
│           = /plif
├── plif
│   = /bla/blo/plouf
├── titi
├-- toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color pull
Pulled: toto
$ cat toto
blablabla%
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 push .
     1 rm -r .
     2 push .
     3 rm -r bla
     4 push .
     5 rm -r plif bla/bli
     6 push .
     7 rm plif bla/bli/plouf bla/blo/plouf
     8 push .
     9 rm bla/blo/plouf
    10 rm bla/bli/plouf
    11 rm titi toto tutu
    12 rm plif
    13 push .
    14 push bla/bli/plouf bla/blo/plouf
    15 push bla/bli/plouf bla/blo/plouf
    16 push tutu titi
    17 push .
    18 push toto
    19 init
# Same, but with a deeper directory.
$ rm toto
$ mkdir toto
$ mkdir toto/tutu
$ echo 'this shouldn'\''t be here' > toto/tutu/wrong
$ cd /tmp/filou-test/clone
$ main.exe --no-color push
Error:
  failed to push file: toto/tutu/wrong:
  parent directory already exists as a file: toto
Exit code: 1
$ rm toto/tutu/wrong
$ rmdir toto/tutu
$ rmdir toto
$ cd /tmp/filou-test/clone
$ main.exe --no-color pull
Pulled: toto
$ cat toto
blablabla%
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 push .
     1 rm -r .
     2 push .
     3 rm -r bla
     4 push .
     5 rm -r plif bla/bli
     6 push .
     7 rm plif bla/bli/plouf bla/blo/plouf
     8 push .
     9 rm bla/blo/plouf
    10 rm bla/bli/plouf
    11 rm titi toto tutu
    12 rm plif
    13 push .
    14 push bla/bli/plouf bla/blo/plouf
    15 push bla/bli/plouf bla/blo/plouf
    16 push tutu titi
    17 push .
    18 push toto
    19 init
# Same, but with a deeper directory but the first directory exists.
$ rm bla/bli/plouf
$ mkdir bla/bli/plouf
$ mkdir bla/bli/plouf/tutu
$ echo 'this shouldn'\''t be here' > bla/bli/plouf/tutu/wrong
$ cd /tmp/filou-test/clone
$ main.exe --no-color push
Error:
  failed to push file: bla/bli/plouf/tutu/wrong:
  parent directory already exists as a file: bla/bli/plouf
Exit code: 1
$ rm bla/bli/plouf/tutu/wrong
$ rmdir bla/bli/plouf/tutu
$ rmdir bla/bli/plouf
$ cd /tmp/filou-test/clone
$ main.exe --no-color pull
Pulled: bla/bli/plouf
$ cat bla/bli/plouf
plaf%
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 push .
     1 rm -r .
     2 push .
     3 rm -r bla
     4 push .
     5 rm -r plif bla/bli
     6 push .
     7 rm plif bla/bli/plouf bla/blo/plouf
     8 push .
     9 rm bla/blo/plouf
    10 rm bla/bli/plouf
    11 rm titi toto tutu
    12 rm plif
    13 push .
    14 push bla/bli/plouf bla/blo/plouf
    15 push bla/bli/plouf bla/blo/plouf
    16 push tutu titi
    17 push .
    18 push toto
    19 init
# Try to push a file while a directory already exists for one of its parent.
$ rm bla/bli/plouf
$ rmdir bla/bli
$ echo 'I should be a directory' > bla/bli
$ cd /tmp/filou-test/clone
$ main.exe --no-color push
Error:
  failed to push file: bla/bli:
  file already exists as a directory
Exit code: 1
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli?
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
$ rm bla/bli
$ cd /tmp/filou-test/clone
$ main.exe --no-color pull
Pulled: bla/bli/plouf
$ cat bla/bli/plouf
plaf%
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 push .
     1 rm -r .
     2 push .
     3 rm -r bla
     4 push .
     5 rm -r plif bla/bli
     6 push .
     7 rm plif bla/bli/plouf bla/blo/plouf
     8 push .
     9 rm bla/blo/plouf
    10 rm bla/bli/plouf
    11 rm titi toto tutu
    12 rm plif
    13 push .
    14 push bla/bli/plouf bla/blo/plouf
    15 push bla/bli/plouf bla/blo/plouf
    16 push tutu titi
    17 push .
    18 push toto
    19 init
# Test update.
$ cd /tmp/filou-test/clone
$ main.exe --no-color update
Computing reachable object set...
Copied 0 objects.
Clone is up-to-date.
$ cd /tmp/filou-test/clone
$ explore .filou/root
{
  redo = [];
  head = {
    command = "push .";
    root = { Non_empty = {
        root_dir = e878aee40659906d5ccb6940f93a28f3730dcf507e467ce2d9bda2c9eeeb9fdc;
        hash_index = c1b896190d5906ef0ee8a53cff6e44584674d8f90d74122807eaafe0b5c29632;
      } };
  };
  undo = [
    {
      command = "rm -r .";
      root = 32 (Empty);
    };
    {
      command = "push .";
      root = { Non_empty = {
          root_dir = 43d07a48bc208b91e6f5d095ca5d9ab904e7e383b441a2437873b21bfd9f5432;
          hash_index = c1b896190d5906ef0ee8a53cff6e44584674d8f90d74122807eaafe0b5c29632;
        } };
    };
    {
      command = "rm -r bla";
      root = { Non_empty = {
          root_dir = ad37ea70d7b33671038a6aa02f9ffd8784e012ae72df2ea39005c37b0a7c7765;
          hash_index = 9e7bb067b05ccdcc330bb3d70056c8a8eb66b39c599ee2bf940bfb37f56e5a52;
        } };
    };
    {
      command = "push .";
      root = { Non_empty = {
          root_dir = 43d07a48bc208b91e6f5d095ca5d9ab904e7e383b441a2437873b21bfd9f5432;
          hash_index = c1b896190d5906ef0ee8a53cff6e44584674d8f90d74122807eaafe0b5c29632;
        } };
    };
    {
      command = "rm -r plif bla/bli";
      root = { Non_empty = {
          root_dir = 219025996a3613c98a94ec35b551c6714b0cc7ee629925a1d101b41816ce241c;
          hash_index = c9ef1474ed646a8d0ffdf312b049f6fe2b1c2fa8a1215221cc4a47b65de260f8;
        } };
    };
    {
      command = "push .";
      root = { Non_empty = {
          root_dir = 43d07a48bc208b91e6f5d095ca5d9ab904e7e383b441a2437873b21bfd9f5432;
          hash_index = c1b896190d5906ef0ee8a53cff6e44584674d8f90d74122807eaafe0b5c29632;
        } };
    };
    {
      command = "rm plif bla/bli/plouf bla/blo/plouf";
      root = { Non_empty = {
          root_dir = 8a473f3cb5e2e90a178a4679e542995debeda54454dabf61d64b5f358cd55a53;
          hash_index = 3252e56f89f71f2b34367e3e226863a239479a221241dc8007f5f5545036f191;
        } };
    };
    {
      command = "push .";
      root = { Non_empty = {
          root_dir = e878aee40659906d5ccb6940f93a28f3730dcf507e467ce2d9bda2c9eeeb9fdc;
          hash_index = c1b896190d5906ef0ee8a53cff6e44584674d8f90d74122807eaafe0b5c29632;
        } };
    };
    {
      command = "rm bla/blo/plouf";
      root = 32 (Empty);
    };
    {
      command = "rm bla/bli/plouf";
      root = { Non_empty = {
          root_dir = 49c900ccea0ff485e5c147294defa59a16c41d0c7290f1ef2eaca36d7cc00f19;
          hash_index = fecba1a163fe456da8ebb6e440d6f2125c6ec11839958d798c44b1ef98a6ef08;
        } };
    };
    {
      command = "rm titi toto tutu";
      root = { Non_empty = {
          root_dir = baf5a204d227266d9957d377b849eaa5a75b00f7cf5328af7fb94cfd37ca54b6;
          hash_index = d6eed61e42816b2ccd7a6c13dd660fda68b9161b7d233e5ef00ef47c0b0e9451;
        } };
    };
    {
      command = "rm plif";
      root = { Non_empty = {
          root_dir = 0451f8a3cd8381f73a38ea8f362f87e4cd7ddb80d3ffd8f4840f7c2e830e0c1b;
          hash_index = ea731a4b0893e41120694094dde9d2f4a61a3aee397b01ad8373f1502205d8fd;
        } };
    };
    {
      command = "push .";
      root = { Non_empty = {
          root_dir = 43d07a48bc208b91e6f5d095ca5d9ab904e7e383b441a2437873b21bfd9f5432;
          hash_index = c1b896190d5906ef0ee8a53cff6e44584674d8f90d74122807eaafe0b5c29632;
        } };
    };
    {
      command = "push bla/bli/plouf bla/blo/plouf";
      root = { Non_empty = {
          root_dir = 0451f8a3cd8381f73a38ea8f362f87e4cd7ddb80d3ffd8f4840f7c2e830e0c1b;
          hash_index = ea731a4b0893e41120694094dde9d2f4a61a3aee397b01ad8373f1502205d8fd;
        } };
    };
    {
      command = "push bla/bli/plouf bla/blo/plouf";
      root = { Non_empty = {
          root_dir = 0451f8a3cd8381f73a38ea8f362f87e4cd7ddb80d3ffd8f4840f7c2e830e0c1b;
          hash_index = ea731a4b0893e41120694094dde9d2f4a61a3aee397b01ad8373f1502205d8fd;
        } };
    };
    {
      command = "push tutu titi";
      root = { Non_empty = {
          root_dir = 42c841776df006f78a7c940a01c56be7e68120afdf1cb4e13fdcc82f69c85ab3;
          hash_index = 3252e56f89f71f2b34367e3e226863a239479a221241dc8007f5f5545036f191;
        } };
    };
    {
      command = "push .";
      root = { Non_empty = {
          root_dir = 706c5b0f5dbcef08bd26ab946571000297dac1ff0487aacc03ed90dae22035b4;
          hash_index = 190e537da8e39221f8648a7750aa827c784b54c44ac74e5a6bc21c6873ea4237;
        } };
    };
    {
      command = "push toto";
      root = { Non_empty = {
          root_dir = 706c5b0f5dbcef08bd26ab946571000297dac1ff0487aacc03ed90dae22035b4;
          hash_index = 190e537da8e39221f8648a7750aa827c784b54c44ac74e5a6bc21c6873ea4237;
        } };
    };
    {
      command = "init";
      root = 32 (Empty);
    };
  ];
}
$ rm .filou/e8/78/e878aee40659906d5ccb6940f93a28f3730dcf507e467ce2d9bda2c9eeeb9fdc
$ cd /tmp/filou-test/clone
$ main.exe --no-color update
Computing reachable object set...
Copied 1 objects.
Clone is up-to-date.
$ cd /tmp/filou-test/clone
$ main.exe --no-color update
Computing reachable object set...
Copied 0 objects.
Clone is up-to-date.
$ rm .filou/e8/78/e878aee40659906d5ccb6940f93a28f3730dcf507e467ce2d9bda2c9eeeb9fdc
$ rm .filou/c1/b8/c1b896190d5906ef0ee8a53cff6e44584674d8f90d74122807eaafe0b5c29632
$ cd /tmp/filou-test/clone
$ main.exe --no-color update
Computing reachable object set...
Copied 2 objects.
Clone is up-to-date.
$ cd /tmp/filou-test/clone
$ main.exe --no-color update
Computing reachable object set...
Copied 0 objects.
Clone is up-to-date.
$ rm -r -f /tmp/filou-test/clone/.filou
$ main.exe --no-color clone /tmp/filou-test/main /tmp/filou-test/clone
$ cd /tmp/filou-test/clone
$ tree -a -s -F
.
├── [       4096]  bla/
│   ├── [       4096]  bli/
│   │   └── [          4]  plouf
│   └── [       4096]  blo/
│       └── [          4]  plouf
├── [       4096]  .filou/
│   └── [         44]  config
├── [          4]  plif
├── [          6]  titi
├── [          9]  toto
└── [          3]  tutu

4 directories, 7 files
$ cd /tmp/filou-test/clone
$ main.exe --no-color update
Computing reachable object set...
Copied 39 objects.
Clone is up-to-date.
$ cd /tmp/filou-test/clone
$ tree -a -s -F
.
├── [       4096]  bla/
│   ├── [       4096]  bli/
│   │   └── [          4]  plouf
│   └── [       4096]  blo/
│       └── [          4]  plouf
├── [       4096]  .filou/
│   ├── [       4096]  04/
│   │   └── [       4096]  51/
│   │       └── [        248]  0451f8a3cd8381f73a38ea8f362f87e4cd7ddb80d3ffd8f4840f7c2e830e0c1b
│   ├── [       4096]  07/
│   │   ├── [       4096]  86/
│   │   │   └── [         87]  07866657909a05f003d5fe28188ba666491760f32045446be92098d6170ab33c
│   │   └── [       4096]  be/
│   │       └── [         66]  07be272ebfe4b295631c092a1c711f69263967e400433afc800c500d60a4a825
│   ├── [       4096]  12/
│   │   └── [       4096]  ac/
│   │       └── [         66]  12acdfd2d55d639cbcc6a82625ed8778344fd3c92c36e234533fee20e0129a2d
│   ├── [       4096]  18/
│   │   └── [       4096]  f6/
│   │       └── [         96]  18f6791e8b6119ad6533253878355fd46a8f3e47a012f44069f56906be164e7f
│   ├── [       4096]  19/
│   │   └── [       4096]  0e/
│   │       └── [         66]  190e537da8e39221f8648a7750aa827c784b54c44ac74e5a6bc21c6873ea4237
│   ├── [       4096]  21/
│   │   └── [       4096]  90/
│   │       └── [        247]  219025996a3613c98a94ec35b551c6714b0cc7ee629925a1d101b41816ce241c
│   ├── [       4096]  2e/
│   │   └── [       4096]  15/
│   │       └── [         88]  2e1595332cec7e158715162a870eaae52dbd093bcabf34014c7e532af47fb71d
│   ├── [       4096]  32/
│   │   └── [       4096]  52/
│   │       └── [        146]  3252e56f89f71f2b34367e3e226863a239479a221241dc8007f5f5545036f191
│   ├── [       4096]  36/
│   │   └── [       4096]  12/
│   │       └── [         66]  3612f23f4ee3c3d5b3b33b06af006dc45d6b430837b8b7063f75592de733ec6d
│   ├── [       4096]  42/
│   │   └── [       4096]  c8/
│   │       └── [        183]  42c841776df006f78a7c940a01c56be7e68120afdf1cb4e13fdcc82f69c85ab3
│   ├── [       4096]  43/
│   │   └── [       4096]  d0/
│   │       └── [        297]  43d07a48bc208b91e6f5d095ca5d9ab904e7e383b441a2437873b21bfd9f5432
│   ├── [       4096]  44/
│   │   └── [       4096]  81/
│   │       └── [         66]  44811f837ea3877a96f4c470aacb423a3ebe725394b943b9493906f769b2acd0
│   ├── [       4096]  49/
│   │   └── [       4096]  c9/
│   │       └── [         96]  49c900ccea0ff485e5c147294defa59a16c41d0c7290f1ef2eaca36d7cc00f19
│   ├── [       4096]  70/
│   │   └── [       4096]  6c/
│   │       └── [         87]  706c5b0f5dbcef08bd26ab946571000297dac1ff0487aacc03ed90dae22035b4
│   ├── [       4096]  76/
│   │   └── [       4096]  b9/
│   │       └── [         87]  76b9bef7e34f1322d03f5e96cc9661288856382727d4ec0d0098c740818aa799
│   ├── [       4096]  7c/
│   │   └── [       4096]  e9/
│   │       └── [         75]  7ce9494fecd37797d89effc25aea1f9250aa723bd628c74ce1696bc3207062e2
│   ├── [       4096]  89/
│   │   └── [       4096]  a8/
│   │       └── [         88]  89a8d8fe98958200025991c7e91cf190915e217f5c2165b8d0215cbcd11dba56
│   ├── [       4096]  8a/
│   │   └── [       4096]  47/
│   │       └── [        183]  8a473f3cb5e2e90a178a4679e542995debeda54454dabf61d64b5f358cd55a53
│   ├── [       4096]  95/
│   │   └── [       4096]  c7/
│   │       └── [         75]  95c79518fe43b0eb0b36ca97dbd66f494da7392f49c0f18a92d902b1c345bd21
│   ├── [       4096]  98/
│   │   └── [       4096]  b3/
│   │       └── [         66]  98b3fc6d9c7d1943bb5bd3db0639beed38fb598502635303abcc086caf5bc120
│   ├── [       4096]  99/
│   │   └── [       4096]  c7/
│   │       └── [         75]  99c720a26777be7fc3513fdcc7ae21f828d5b9e9948fb8ecb95b93227855b2a1
│   ├── [       4096]  9d/
│   │   └── [       4096]  d7/
│   │       └── [         66]  9dd78bea3060df9c6d42f7046209f4ec3ed2870d620c5096979998c2d457d515
│   ├── [       4096]  9e/
│   │   └── [       4096]  7b/
│   │       └── [        186]  9e7bb067b05ccdcc330bb3d70056c8a8eb66b39c599ee2bf940bfb37f56e5a52
│   ├── [       4096]  ad/
│   │   └── [       4096]  37/
│   │       └── [        231]  ad37ea70d7b33671038a6aa02f9ffd8784e012ae72df2ea39005c37b0a7c7765
│   ├── [       4096]  ba/
│   │   └── [       4096]  f5/
│   │       └── [         97]  baf5a204d227266d9957d377b849eaa5a75b00f7cf5328af7fb94cfd37ca54b6
│   ├── [       4096]  c1/
│   │   └── [       4096]  b8/
│   │       └── [        226]  c1b896190d5906ef0ee8a53cff6e44584674d8f90d74122807eaafe0b5c29632
│   ├── [       4096]  c8/
│   │   └── [       4096]  c0/
│   │       └── [        146]  c8c02c7854ff0487015eaa44c129a131f340bb7a747e743f237e40cee4d9ede6
│   ├── [       4096]  c9/
│   │   └── [       4096]  ef/
│   │       └── [        186]  c9ef1474ed646a8d0ffdf312b049f6fe2b1c2fa8a1215221cc4a47b65de260f8
│   ├── [       4096]  cb/
│   │   └── [       4096]  1d/
│   │       └── [         88]  cb1d78e51ff06c0d65cc17bf9cb86b39a1581aa64436fbd72c2f625607996d59
│   ├── [         44]  config
│   ├── [       4096]  d2/
│   │   └── [       4096]  6f/
│   │       └── [         66]  d26fe950694ae4a1b70b2868b577bde5b6612374734972571cab63cca27e3c06
│   ├── [       4096]  d6/
│   │   └── [       4096]  ee/
│   │       └── [        106]  d6eed61e42816b2ccd7a6c13dd660fda68b9161b7d233e5ef00ef47c0b0e9451
│   ├── [       4096]  d8/
│   │   └── [       4096]  c1/
│   │       └── [         88]  d8c1bb84c95d33a716260fbf820b844e7e6d9a7442bd075c145d23ce3b1cab31
│   ├── [       4096]  de/
│   │   └── [       4096]  35/
│   │       └── [         94]  de35de6ffa16e55b8a1783d2f716b0aabf1a8e6c5fce4d6ea80c8a07f794b147
│   ├── [       4096]  e8/
│   │   └── [       4096]  78/
│   │       └── [        297]  e878aee40659906d5ccb6940f93a28f3730dcf507e467ce2d9bda2c9eeeb9fdc
│   ├── [       4096]  ea/
│   │   └── [       4096]  73/
│   │       └── [        226]  ea731a4b0893e41120694094dde9d2f4a61a3aee397b01ad8373f1502205d8fd
│   ├── [       4096]  ee/
│   │   └── [       4096]  64/
│   │       └── [         75]  ee64be49e7b40a3489c8df8e32228cebbc6966c872585261a51de70349352ee9
│   ├── [       4096]  ef/
│   │   └── [       4096]  7c/
│   │       └── [        146]  ef7c2a9d0779c702a2514ecd522e2e36784c81ec3e2baa1f1b88c89764ddbb82
│   ├── [       4096]  fe/
│   │   └── [       4096]  cb/
│   │       └── [         66]  fecba1a163fe456da8ebb6e440d6f2125c6ec11839958d798c44b1ef98a6ef08
│   └── [       1758]  root
├── [          4]  plif
├── [          6]  titi
├── [          9]  toto
└── [          3]  tutu

81 directories, 47 files
$ cd /tmp/filou-test/clone
$ main.exe --no-color check --cache
Directory structure looks ok (total size: 30, file count: 6).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --cache
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 push .
     1 rm -r .
     2 push .
     3 rm -r bla
     4 push .
     5 rm -r plif bla/bli
     6 push .
     7 rm plif bla/bli/plouf bla/blo/plouf
     8 push .
     9 rm bla/blo/plouf
    10 rm bla/bli/plouf
    11 rm titi toto tutu
    12 rm plif
    13 push .
    14 push bla/bli/plouf bla/blo/plouf
    15 push bla/bli/plouf bla/blo/plouf
    16 push tutu titi
    17 push .
    18 push toto
    19 init
# Play with undo / redo.
$ cd /tmp/filou-test/clone
$ main.exe --no-color undo
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
    -1 push .
-->  0 rm -r .
     1 push .
     2 rm -r bla
     3 push .
     4 rm -r plif bla/bli
     5 push .
     6 rm plif bla/bli/plouf bla/blo/plouf
     7 push .
     8 rm bla/blo/plouf
     9 rm bla/bli/plouf
    10 rm titi toto tutu
    11 rm plif
    12 push .
    13 push bla/bli/plouf bla/blo/plouf
    14 push bla/bli/plouf bla/blo/plouf
    15 push tutu titi
    16 push .
    17 push toto
    18 init
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├++ bla/
├++ plif
├++ titi
├++ toto
└++ tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color undo
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
    -2 push .
    -1 rm -r .
-->  0 push .
     1 rm -r bla
     2 push .
     3 rm -r plif bla/bli
     4 push .
     5 rm plif bla/bli/plouf bla/blo/plouf
     6 push .
     7 rm bla/blo/plouf
     8 rm bla/bli/plouf
     9 rm titi toto tutu
    10 rm plif
    11 push .
    12 push bla/bli/plouf bla/blo/plouf
    13 push bla/bli/plouf bla/blo/plouf
    14 push tutu titi
    15 push .
    16 push toto
    17 init
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color undo 3
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
    -5 push .
    -4 rm -r .
    -3 push .
    -2 rm -r bla
    -1 push .
-->  0 rm -r plif bla/bli
     1 push .
     2 rm plif bla/bli/plouf bla/blo/plouf
     3 push .
     4 rm bla/blo/plouf
     5 rm bla/bli/plouf
     6 rm titi toto tutu
     7 rm plif
     8 push .
     9 push bla/bli/plouf bla/blo/plouf
    10 push bla/bli/plouf bla/blo/plouf
    11 push tutu titi
    12 push .
    13 push toto
    14 init
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├++ bli/
│   └── blo/
│       └── plouf
├++ plif
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color redo 4
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
    -1 push .
-->  0 rm -r .
     1 push .
     2 rm -r bla
     3 push .
     4 rm -r plif bla/bli
     5 push .
     6 rm plif bla/bli/plouf bla/blo/plouf
     7 push .
     8 rm bla/blo/plouf
     9 rm bla/bli/plouf
    10 rm titi toto tutu
    11 rm plif
    12 push .
    13 push bla/bli/plouf bla/blo/plouf
    14 push bla/bli/plouf bla/blo/plouf
    15 push tutu titi
    16 push .
    17 push toto
    18 init
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├++ bla/
├++ plif
├++ titi
├++ toto
└++ tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color push bla
Pushed: bla/blo/plouf
Pushed: bla/bli/plouf
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 push bla
     1 rm -r .
     2 push .
     3 rm -r bla
     4 push .
     5 rm -r plif bla/bli
     6 push .
     7 rm plif bla/bli/plouf bla/blo/plouf
     8 push .
     9 rm bla/blo/plouf
    10 rm bla/bli/plouf
    11 rm titi toto tutu
    12 rm plif
    13 push .
    14 push bla/bli/plouf bla/blo/plouf
    15 push bla/bli/plouf bla/blo/plouf
    16 push tutu titi
    17 push .
    18 push toto
    19 init
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├++ plif
├++ titi
├++ toto
└++ tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color redo
Error:
  journal has less than 1 redo entries
Exit code: 1
$ cd /tmp/filou-test/clone
$ main.exe --no-color push
Pushed: titi
Pushed: toto
Pushed: tutu
Pushed: plif (duplicate of: bla/blo/plouf)
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 push .
     1 push bla
     2 rm -r .
     3 push .
     4 rm -r bla
     5 push .
     6 rm -r plif bla/bli
     7 push .
     8 rm plif bla/bli/plouf bla/blo/plouf
     9 push .
    10 rm bla/blo/plouf
    11 rm bla/bli/plouf
    12 rm titi toto tutu
    13 rm plif
    14 push .
    15 push bla/bli/plouf bla/blo/plouf
    16 push bla/bli/plouf bla/blo/plouf
    17 push tutu titi
    18 push .
    19 push toto
    20 init
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
# Check what prune removes.
$ cd /tmp/filou-test/clone
$ main.exe --no-color prune --yes
Removed 50 objects totalling 6.92 kB.
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 30, file count: 6).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 push .
# Check that the main repository is not read with --cache.
$ mv /tmp/filou-test/main /tmp/filou-test/main.backup
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
Error:
  failed to fetch root:
  no such file: /tmp/filou-test/main/root
Exit code: 1
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree --cache
./
├── bla/
│   ├── bli/
│   │   └── plouf
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
$ mv /tmp/filou-test/main.backup /tmp/filou-test/main
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 push .
# Check that needed objects are copied in the clone cache when fetching.
$ rm -r -f /tmp/filou-test/clone/.filou
$ main.exe --no-color clone /tmp/filou-test/main /tmp/filou-test/clone
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree bla/bli
└── bla/bli/
    └── plouf
$ cd /tmp/filou-test/clone
$ tree -a -s -F
.
├── [       4096]  bla/
│   ├── [       4096]  bli/
│   │   └── [          4]  plouf
│   └── [       4096]  blo/
│       └── [          4]  plouf
├── [       4096]  .filou/
│   ├── [       4096]  c8/
│   │   └── [       4096]  c0/
│   │       └── [        146]  c8c02c7854ff0487015eaa44c129a131f340bb7a747e743f237e40cee4d9ede6
│   ├── [         44]  config
│   ├── [       4096]  d8/
│   │   └── [       4096]  c1/
│   │       └── [         88]  d8c1bb84c95d33a716260fbf820b844e7e6d9a7442bd075c145d23ce3b1cab31
│   ├── [       4096]  e8/
│   │   └── [       4096]  78/
│   │       └── [        297]  e878aee40659906d5ccb6940f93a28f3730dcf507e467ce2d9bda2c9eeeb9fdc
│   └── [        175]  root
├── [          4]  plif
├── [          6]  titi
├── [          9]  toto
└── [          3]  tutu

10 directories, 11 files
$ cd /tmp/filou-test/clone
$ main.exe --no-color update
Computing reachable object set...
Copied 12 objects.
Clone is up-to-date.
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 push .
# Test prune on the clone.
$ echo 'this is a truc' > bla/bli/truc
$ cd /tmp/filou-test/clone
$ main.exe --no-color push bla/bli
Pushed: bla/bli/truc
$ cd /tmp/filou-test/clone
$ main.exe --no-color prune --yes
Removed 8 objects totalling 1.51 kB.
# Clone: some objects should have been removed, no files should have been added:
- /tmp/filou-test/clone/.filou/c1/b8/c1b896190d5906ef0ee8a53cff6e44584674d8f90d74122807eaafe0b5c29632
- /tmp/filou-test/clone/.filou/c8/c0/c8c02c7854ff0487015eaa44c129a131f340bb7a747e743f237e40cee4d9ede6
- /tmp/filou-test/clone/.filou/d8/c1/d8c1bb84c95d33a716260fbf820b844e7e6d9a7442bd075c145d23ce3b1cab31
- /tmp/filou-test/clone/.filou/e8/78/e878aee40659906d5ccb6940f93a28f3730dcf507e467ce2d9bda2c9eeeb9fdc
# Main: should be the same diff:
- /tmp/filou-test/main/c1/b8/c1b896190d5906ef0ee8a53cff6e44584674d8f90d74122807eaafe0b5c29632
- /tmp/filou-test/main/c8/c0/c8c02c7854ff0487015eaa44c129a131f340bb7a747e743f237e40cee4d9ede6
- /tmp/filou-test/main/d8/c1/d8c1bb84c95d33a716260fbf820b844e7e6d9a7442bd075c145d23ce3b1cab31
- /tmp/filou-test/main/e8/78/e878aee40659906d5ccb6940f93a28f3730dcf507e467ce2d9bda2c9eeeb9fdc
$ cd /tmp/filou-test/clone
$ main.exe --no-color check
Directory structure looks ok (total size: 44, file count: 7).
All files are available.
Hash index is consistent with the directory structure.
$ cd /tmp/filou-test/clone
$ main.exe --no-color tree
./
├── bla/
│   ├── bli/
│   │   ├── plouf
│   │   └── truc
│   └── blo/
│       └── plouf
├── plif
├── titi
├── toto
└── tutu
# Check that if some files are missing from the cache, they are not added.
$ cd /tmp/filou-test/clone
$ rm .filou/00/84/0084fb625c884272e1379698afdc70763959a9eab98f2d96e59ed020fa8ed456
$ rm .filou/e7/a7/e7a7dc6d20a44dd7fb3755a97db8c924815571a38d60cfd9fd5748a9b26597e2
$ cd /tmp/filou-test/clone
$ main.exe --no-color prune --yes
Removed 0 objects totalling 0 B.
# Clone: diff should be empty:
# Main: diff should also be empty:
# Updating should restore 2 objects:
$ cd /tmp/filou-test/clone
$ main.exe --no-color update
Computing reachable object set...
Copied 2 objects.
Clone is up-to-date.
# Check that if more objects exist in the clone than in the main, they are removed.
$ cd /tmp/filou-test/clone
$ mkdir .filou/01
$ mkdir .filou/01/23
$ echo 'dummy object' > .filou/01/23/01234567fb95b9dd5d20056bc24150b79354852e0f0a28ce578af2b3d2f4b859
$ cd /tmp/filou-test/clone
$ main.exe --no-color prune --yes
Removed 1 objects totalling 12 B.
# Clone: diff should show one removed file:
- /tmp/filou-test/clone/.filou/01/23/01234567fb95b9dd5d20056bc24150b79354852e0f0a28ce578af2b3d2f4b859
# Main: diff should be empty:
$ cd /tmp/filou-test/clone
$ main.exe --no-color log
-->  0 push bla/bli
